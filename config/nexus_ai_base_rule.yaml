description: |
  以下说明描述了Nexus-AI在构建、更新智能体时需遵守的基本规则，可用于以下场景：
  - Nexus AI进行构建、更新时需遵守base和对应workflows的规则，如build、update、deploy等
  - 使用第三方AI IDE进行编辑时，可通过规则快速了解目录结构及生成逻辑

  规则分类包括：
  - base：无论使用何种workflow，都需遵守的基础规则
  - build：构建时需遵守的规则约束
  - update：更新时需遵守的规则约束

  每类规则包含如下信息：
  - version：版本号
  - updated_on：更新日期
  - author：作者
  - change_log：变更记录
  - attributes：属性

  属性包括：
  - directory_rules：目录规则
  - generation_rules：生成规则
  - cache_rules：缓存规则
  - external_resources：外部资源规则
  - custom_rules：用户自定义规则
workflows:
  base:
    - version: "latest"
      updated_on: "2025-11-10"
      author: "qangz"
      change_log:
        - date: "2025-11-10"
          summary: "新增base规则"
      attributes:
        directory_rules: |  # 目录规则
          =====通用规则=====
          nexus-ai顶层目录保持五个分区：`agents/`、`prompts/`、`tools/`、`projects/`、`nexus_utils/`。
          - `agents/`：Agent运行代码目录，内部按`system_agents/`、`template_agents/`、`generated_agents/`区分来源。
          - `prompts/`：Agent提示词模板目录，结构与`agents/`一致，对应系统、模板、生成三类提示词。
          - `tools/`：Agent引用的工具代码目录，分为`system_tools/`、`template_tools/`、`generated_tools/`，与Agent目录一一对应。
          - `projects/<project_name>/agents/<agent_name>/`：集中存放各阶段JSON文档（需求、架构、设计、提示词、工具、代码、验收）及项目说明文件。
          - `nexus_utils/`：平台通用模块，禁止放置项目产物或临时文件。
        generation_rules: | # 生成规则
          =====通用生成规则=====
          创建的Agent执行脚本中，创建Agent对象必须通过nexus_utils.agent_factory.create_agent_from_prompt_template实现

          =====AgentCore部署入口点规则（必须遵守）=====
          所有生成的Agent脚本必须包含AgentCore标准入口点，以支持部署到Amazon Bedrock AgentCore：

          1. **必须定义handler函数**：
             ```python
             from typing import Dict, Any

             def handler(event: Dict[str, Any], context: Any = None) -> Dict[str, Any]:
                 """
                 AgentCore 标准入口点

                 Args:
                     event: AgentCore 传入的事件，包含:
                         - prompt: 用户消息
                         - user_id: 用户ID（可选）
                         - session_id: 会话ID（可选）
                         - 其他业务参数
                     context: AgentCore 上下文

                 Returns:
                     Dict: 响应结果，必须包含 success 和 response 或 error
                 """
                 prompt = event.get("prompt") or event.get("message") or event.get("input", "")

                 if not prompt:
                     return {"success": False, "error": "Missing 'prompt' in request"}

                 try:
                     result = my_agent(prompt)
                     response_text = result.content if hasattr(result, 'content') else str(result)
                     return {"success": True, "response": response_text}
                 except Exception as e:
                     return {"success": False, "error": str(e)}
             ```

          2. **必须定义别名入口点**：
             ```python
             invoke = handler
             main = handler
             ```

          3. **handler函数位置**：
             - handler函数应定义在Agent实例创建之后、`if __name__ == "__main__"` 之前
             - 使用注释 `# ==================== AgentCore 入口点（必须包含）====================` 标识

          4. **返回格式要求**：
             - 成功时返回：`{"success": True, "response": "响应内容"}`
             - 失败时返回：`{"success": False, "error": "错误信息"}`

          5. **错误处理**：
             - handler函数必须包含try-catch处理，确保不会抛出未捕获的异常
        cache_rules: |      # 缓存规则
          =====通用缓存规则=====
          如用户要求构建的Agent进行内容缓存，请按照如下规则：
          默认缓存路径：`.cache/<agent_name>/`
          在缓存目录中，Agent还应按照具体要求进行目录划分，如按<Project_ID>、<Session_ID>、<Task_ID>等进行目录划分。
        external_resources: | # 外部资源规则
          =====通用外部资源规则=====
          无特殊要求
        custom_rules: |     # 用户自定义规则
          =====通用用户自定义规则=====
          无特殊要求

  agent_build:
    - version: "latest"
      updated_on: "2025-11-10"
      author: "qangz"
      change_log:
        - date: "2025-11-10"
          summary: "新增build规则"
      attributes:
        directory_rules: |
          =====Build Workflow目录规则=====
          重要参数：
          project_name: 由intent analyzer基于用户需求意图识别后生成
          agent_name: 默认与project_name一致
          重要目录：
          项目过程目录：`projects/<project_name>/`
          agent过程目录：`projects/<project_name>/agents/<agent_name>/`
          agent脚本目录：`agents/generated_agents/<agent_name>/<agent_name>.py`
          agent提示词配置目录：`prompts/generated_agents_prompts/<agent_name>/<agent_name>.yaml`
          agent工具代码目录：`tools/generated_tools/<agent_name>/*.py`
          注意：当项目为多Agent项目时,需求分析、 架构设计、agent设计应存储在主agent过程中目录，工具开发、提示词工程及agent代码开发等设计文档存储在各自Agent过程中目录，如：
            -`projects/<project_name>/agents/<other_agent_name>/tools_developer.json`
            -`projects/<project_name>/agents/<other_agent_name>/prompt_engineer.json`
            -`projects/<project_name>/agents/<other_agent_name>/agent_code_developer.json`
        generation_rules: |
          =====Build Workflow生成规则=====
          - 生成的Agent名称在所有阶段都应固定
          - 生成的Agent脚本初始化Agent时的参数默认为agent_params = {"env": "production","version": "latest",  "model_id": "default","enable_logging": True}
          - 当存在多个Agent时，必须在提示词开发阶段，创建多个yaml配置对应每个Agent
          - 当创建多个Agent时，优先在agent脚本中创建多个Agent对象，并按照逻辑进行编排和判断，也可使用swarm或graph进行编排。
          - **重要**：必须遵守base规则中的"AgentCore部署入口点规则"，确保所有生成的Agent脚本都包含handler入口点函数
        cache_rules: |
          =====Build Workflow缓存规则=====
          当用户要求构建的Agent进行内容缓存，请按照如下规则：
          默认缓存路径：`.cache/<agent_name>/`
          在缓存目录中，Agent还应按照具体要求进行目录划分，如按<Project_ID>、<Session_ID>、<Task_ID>等进行目录划分。
        external_resources: |
          =====Build Workflow外部资源规则=====
        custom_rules: |
          =====Build Workflow用户自定义规则=====
          - 生成的Agent所使用的模型如无特殊要求或需求，请使用"global.anthropic.claude-sonnet-4-5-20250929-v1:0"

  agent_update:
    - version: "latest"
      updated_on: "2025-11-10"
      author: "qangz"
      change_log:
        - date: "2025-11-10"
          summary: "新增update规则"
      attributes:
        directory_rules: |
          =====Update Workflow目录规则=====
          根据指定要更新的Project Name，仅允许在以下目录范围使用工具进行创建和更新操作，其他范围仅允许读取操作：
          - `projects/<project_name>/<version_id>/`
          - `prompts/generated_agents_prompts/<project_name>/<agent_name>.yaml`
          - `tools/generated_tools/<project_name>/<version_id>/`
          - `agents/generated_agents/<project_name>/<version_id>/<agent_name>.py`
        generation_rules: |
          =====Update Workflow生成规则=====
          - 不允许修改和删除源文件，仅允许在当前工作版本的目录中创建新文件
          - 请遵循目录规则进行新文件生成
        cache_rules: |
          =====Update Workflow缓存规则=====
          无特殊要求
        external_resources: |
          =====Update Workflow外部资源规则=====
          无特殊要求
        custom_rules: |
          =====Update Workflow用户自定义规则=====
          无特殊要求

  tool_build:
    - version: "latest"
      updated_on: "2025-11-11"
      author: "qangz"
      change_log:
        - date: "2025-11-11"
          summary: "新增tool_build规则"
      attributes:
        directory_rules: |
          =====Tool Build Workflow目录规则=====
          工具构建工作流仅允许在以下目录范围使用工具进行创建和更新操作：
          - `tools/generated_tools/tool_build_<tool_name>/`：工具项目根目录，存储所有工具文件
          - `tools/generated_tools/tool_build_<tool_name>/stages/`：存储各阶段JSON文档（需求、设计、开发、验证、文档）
          - `tools/generated_tools/tool_build_<tool_name>/config.yaml`：工具项目配置文件
          - `tools/generated_tools/tool_build_<tool_name>/status.yaml`：工具项目状态文件
          - `tools/generated_tools/tool_build_<tool_name>/README.md`：工具使用文档
          - `tools/generated_tools/tool_build_<tool_name>/*.py`：工具代码文件
          工具项目命名规范：必须以 `tool_build_` 开头，后跟描述性英文名称（小写，下划线分隔）
        generation_rules: |
          =====Tool Build Workflow生成规则=====
          - 每个用户的功能需求，无论开发多少个工具，都应存储在同一工具项目目录的脚本中
          - 工具代码必须使用 `@tool` 装饰器，符合Strands SDK规范
          - 工具函数应返回JSON字符串或错误信息字符串
          - 所有工具必须注册到项目的 `status.yaml` 中
          - 必须生成完整的 README.md 文档，包含工具功能和使用说明
        cache_rules: |
          =====Tool Build Workflow缓存规则=====
          无特殊要求
        external_resources: |
          =====Tool Build Workflow外部资源规则=====
          无特殊要求
        custom_rules: |
          =====Tool Build Workflow用户自定义规则=====
          无特殊要求
# Jaeger 架构对比：Sidecar vs 独立服务

## 当前架构：Sidecar 模式

### 架构图
```
┌─────────────────────────────────────────────────────────┐
│  ECS Service: API (desired_count = 2)                  │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Task 1 (Fargate)          Task 2 (Fargate)            │
│  ┌──────────────┐          ┌──────────────┐           │
│  │ API容器      │          │ API容器      │           │
│  │ :8000        │          │ :8000        │           │
│  └──────────────┘          └──────────────┘           │
│  ┌──────────────┐          ┌──────────────┐           │
│  │ Jaeger容器1  │          │ Jaeger容器2  │           │
│  │ :16686,4318  │          │ :16686,4318  │           │
│  └──────────────┘          └──────────────┘           │
│                                                          │
└─────────────────────────────────────────────────────────┘
         │                        │
         └────────┬───────────────┘
                  │
         ┌────────▼────────┐
         │  ALB            │
         │  /jaeger/*      │
         └─────────────────┘
```

### 问题
- ❌ 每个任务都有独立的 Jaeger 实例
- ❌ 追踪数据分散，无法聚合
- ❌ 访问 UI 时只能看到随机一个实例的数据
- ❌ 资源浪费（每个任务运行 Jaeger）
- ❌ 任务重启后追踪数据丢失

## 推荐架构：独立 Jaeger 服务

### 架构图
```
┌─────────────────────────────────────────────────────────┐
│  ECS Service: API (desired_count = 2)                  │
├─────────────────────────────────────────────────────────┤
│  Task 1 (Fargate)          Task 2 (Fargate)            │
│  ┌──────────────┐          ┌──────────────┐           │
│  │ API容器      │          │ API容器      │           │
│  │ :8000        │          │ :8000        │           │
│  │              │          │              │           │
│  │ OTEL →       │          │ OTEL →       │           │
│  │ jaeger:4318  │          │ jaeger:4318  │           │
│  └──────┬───────┘          └──────┬───────┘           │
└─────────┼─────────────────────────┼────────────────────┘
          │                         │
          │ (Service Discovery)     │
          │                         │
          └───────────┬─────────────┘
                      │
┌─────────────────────▼──────────────────────────────────┐
│  ECS Service: Jaeger (desired_count = 1)              │
├────────────────────────────────────────────────────────┤
│  Task 1 (Fargate)                                     │
│  ┌──────────────────────────┐                        │
│  │ Jaeger容器               │                        │
│  │ :16686 (UI)              │                        │
│  │ :4317 (OTLP gRPC)        │                        │
│  │ :4318 (OTLP HTTP)        │                        │
│  │                          │                        │
│  │ 聚合所有API实例的追踪数据 │                        │
│  └──────────────────────────┘                        │
└────────────────────────────────────────────────────────┘
                      │
         ┌────────────▼────────────┐
         │  ALB                    │
         │  /jaeger/* → Jaeger TG  │
         └─────────────────────────┘
```

### 优势
- ✅ 所有 API 实例向同一个 Jaeger 服务发送追踪数据
- ✅ 在 Jaeger UI 中可以看到完整的、聚合的追踪数据
- ✅ 资源效率高（只需运行 1 个 Jaeger 实例）
- ✅ 可以配置持久化存储（S3、Elasticsearch 等）
- ✅ 更好的可扩展性和可维护性

## 实施建议

### 方案 1：独立 Jaeger ECS Service（推荐）

创建一个单独的 ECS Service 专门运行 Jaeger：

1. **创建 Jaeger Task Definition**
   - 单独的 Task Definition
   - 使用 `jaegertracing/all-in-one:latest` 镜像
   - 较小的资源分配（1 vCPU, 2GB 内存）

2. **创建 Jaeger ECS Service**
   - 单实例运行（desired_count = 1）
   - 注册到现有的 Jaeger Target Group
   - 使用 Service Discovery 提供 DNS 名称

3. **修改 API 容器环境变量**
   - 从 `http://localhost:4318` 改为 `http://jaeger.local:4318`
   - 或使用 Service Discovery DNS 名称

### 方案 2：使用 AWS X-Ray（替代方案）

如果不需要 Jaeger 的特定功能，可以考虑使用 AWS X-Ray：
- ✅ 完全托管的追踪服务
- ✅ 与 AWS 服务集成良好
- ✅ 无需管理基础设施
- ✅ 成本基于使用量

### 方案 3：使用 Jaeger Cloud（付费服务）

如果预算允许，可以使用托管的 Jaeger 服务。

## 迁移步骤

如果要从 Sidecar 模式迁移到独立服务模式：

1. 创建独立的 Jaeger ECS Service 和 Task Definition
2. 设置 Service Discovery 让 API 可以访问 Jaeger
3. 更新 API Task Definition，移除 Jaeger sidecar 容器
4. 更新 API 环境变量指向共享的 Jaeger 服务
5. 删除旧的 Jaeger Target Group（如果不再需要）
6. 应用 Terraform 配置

## 资源对比

### Sidecar 模式（当前）
- 2 个 API 任务 × 1 个 Jaeger 容器 = 2 个 Jaeger 实例
- 额外资源：2 × (0.5 vCPU + 512MB) = 1 vCPU + 1GB

### 独立服务模式（推荐）
- 1 个独立的 Jaeger 服务 = 1 个 Jaeger 实例
- 额外资源：1 × (0.5 vCPU + 512MB) = 0.5 vCPU + 512MB
- **节省 50% 的资源**


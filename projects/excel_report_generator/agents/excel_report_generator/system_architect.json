{
  "system_design": {
    "design_overview": {
      "project_name": "excel_report_generator",
      "version": "1.0",
      "date": "2025-11-18",
      "design_scope": "Excel智能报表生成系统的完整系统架构设计，包括单Agent架构、数据处理管道、图表生成工具链、HTML报告生成模块以及缓存管理机制",
      "design_principles": [
        "单一职责原则 - 每个工具函数专注于特定功能",
        "幂等性保证 - 相同输入产生一致输出",
        "管道化处理 - 数据处理采用线性管道模式",
        "工具化设计 - 核心功能通过专业工具实现",
        "可观测性 - 支持完整的日志和监控",
        "容错性设计 - 单个组件失败不影响整体流程",
        "标准化接口 - 所有模块采用统一的输入输出格式"
      ],
      "key_decisions": [
        "采用单Agent架构，基于data_analyzer_agent模板",
        "使用管道模式组织数据处理流程：读取→分析→可视化→报告生成",
        "每种图表类型对应一个专门的工具函数确保稳定性",
        "采用分层缓存策略：.cache/excel_report_generator/<session_id>/",
        "使用claude-sonnet-4-5模型进行需求理解和策略制定",
        "基于pandas和matplotlib构建数据处理和可视化工具链",
        "使用jinja2模板引擎生成HTML报告"
      ],
      "workflow_type": "single_agent",
      "recommended_templates": ["data_analyzer_agent"]
    },
    "architecture": {
      "system_context": "Excel智能报表生成系统是一个基于AI的数据分析平台，通过单个智能Agent协调多个专业工具，实现从Excel数据读取到HTML报告生成的完整自动化流程。系统采用本地化部署，支持离线运行，确保数据安全性。",
      "agent_topology": "单Agent拓扑结构：ExcelReportGeneratorAgent作为唯一的智能决策节点，通过调用专业化工具链完成数据处理任务。Agent负责流程协调、需求理解、策略制定和结果整合，具体的数据处理、图表生成、文件操作由对应的工具函数执行。",
      "interaction_model": "用户与Agent采用对话式交互模型。用户提供Excel文件路径和自然语言需求描述，Agent理解需求后制定分析策略，依次调用数据读取、分析、可视化、报告生成工具，最终向用户返回HTML报告路径和分析摘要。整个过程支持进度反馈和错误提示。",
      "technology_stack": {
        "sdk": "Strands SDK",
        "runtime": "Local Python 3.13+",
        "integrations": [
          "AWS Bedrock (claude-sonnet-4-5)",
          "pandas (数据处理)",
          "matplotlib/seaborn (图表生成)",
          "openpyxl (Excel读取)",
          "jinja2 (HTML模板)",
          "scipy/scikit-learn (统计分析)"
        ]
      }
    },
    "agents": [
      {
        "name": "excel_report_generator",
        "purpose": "智能Excel数据分析和报表生成Agent，负责理解用户需求，协调数据处理流程，生成专业的分析报告",
        "responsibilities": [
          "解析用户的自然语言需求描述",
          "制定数据分析和报表生成策略",
          "协调数据读取、清洗、分析、可视化、报告生成流程",
          "监控处理进度并提供用户反馈",
          "处理异常情况并提供错误恢复",
          "确保输出结果的一致性和专业性",
          "管理会话状态和缓存文件"
        ],
        "interfaces": {
          "inputs": [
            "excel_file_path (str): Excel文件路径",
            "user_requirements (str): 用户需求描述",
            "session_id (str, optional): 会话ID",
            "output_format (str, optional): 输出格式偏好"
          ],
          "outputs": [
            "html_report_path (str): 生成的HTML报告路径",
            "analysis_summary (dict): 分析结果摘要",
            "generated_charts (list): 生成的图表文件列表",
            "processing_log (list): 处理日志",
            "success_status (bool): 处理成功状态"
          ]
        },
        "dependencies": [
          "excel_data_reader (工具)",
          "data_analyzer (工具)",
          "chart_generator_suite (工具集)",
          "html_report_builder (工具)",
          "cache_manager (工具)",
          "AWS Bedrock (claude-sonnet-4-5)"
        ],
        "implementation_notes": [
          "基于data_analyzer_agent模板进行扩展",
          "使用nexus_utils.agent_factory.create_agent_from_prompt_template创建",
          "集成幂等性控制机制（固定随机种子、确定性算法）",
          "支持会话状态管理和断点续传",
          "实现完整的错误处理和日志记录"
        ],
        "recommended_template": "data_analyzer_agent"
      }
    ],
    "data_models": [
      {
        "name": "ExcelDataModel",
        "schema": "{'sheets': list, 'data': pd.DataFrame, 'columns': list, 'dtypes': dict, 'metadata': dict}",
        "validation_rules": [
          "sheets列表不能为空",
          "data必须是有效的pandas DataFrame",
          "columns必须与DataFrame列名一致",
          "dtypes必须包含所有列的数据类型"
        ],
        "relationships": ["被AnalysisResult引用", "被ChartConfig使用"]
      },
      {
        "name": "AnalysisResult",
        "schema": "{'statistics': dict, 'insights': list, 'anomalies': list, 'correlations': dict, 'trends': dict}",
        "validation_rules": [
          "statistics必须包含基础统计指标",
          "insights列表不能为空",
          "correlations必须是有效的相关系数矩阵",
          "trends必须包含时间序列分析结果（如适用）"
        ],
        "relationships": ["引用ExcelDataModel", "被ReportTemplate使用"]
      },
      {
        "name": "ChartConfig",
        "schema": "{'chart_type': str, 'data_columns': list, 'style_params': dict, 'file_path': str, 'title': str}",
        "validation_rules": [
          "chart_type必须在支持的类型列表中",
          "data_columns必须存在于源数据中",
          "file_path必须是有效的PNG文件路径",
          "title不能为空"
        ],
        "relationships": ["使用ExcelDataModel数据", "被HTMLReport引用"]
      },
      {
        "name": "ReportTemplate",
        "schema": "{'title': str, 'summary': str, 'sections': list, 'charts': list, 'conclusions': list, 'metadata': dict}",
        "validation_rules": [
          "title和summary不能为空",
          "sections必须包含至少一个分析章节",
          "charts列表必须包含有效的图表引用",
          "conclusions必须基于分析结果生成"
        ],
        "relationships": ["整合AnalysisResult和ChartConfig", "生成最终HTML输出"]
      }
    ],
    "interaction_flows": [
      {
        "name": "完整报表生成流程",
        "description": "从用户输入到HTML报告生成的完整数据处理管道",
        "steps": [
          {
            "step": "1. 需求解析",
            "agent": "excel_report_generator",
            "action": "解析用户需求，生成会话ID，创建缓存目录",
            "data": "user_requirements -> analysis_strategy"
          },
          {
            "step": "2. Excel数据读取",
            "agent": "excel_report_generator",
            "action": "调用excel_data_reader工具读取Excel文件",
            "data": "excel_file_path -> ExcelDataModel"
          },
          {
            "step": "3. 数据分析",
            "agent": "excel_report_generator",
            "action": "调用data_analyzer工具进行深度分析",
            "data": "ExcelDataModel -> AnalysisResult"
          },
          {
            "step": "4. 图表生成策略制定",
            "agent": "excel_report_generator",
            "action": "基于分析结果和用户需求确定图表类型和参数",
            "data": "AnalysisResult + user_requirements -> chart_configs"
          },
          {
            "step": "5. 批量图表生成",
            "agent": "excel_report_generator",
            "action": "并行调用各类图表生成工具",
            "data": "chart_configs -> generated_charts"
          },
          {
            "step": "6. HTML报告构建",
            "agent": "excel_report_generator",
            "action": "调用html_report_builder生成最终报告",
            "data": "AnalysisResult + generated_charts -> html_report"
          },
          {
            "step": "7. 结果返回",
            "agent": "excel_report_generator",
            "action": "整理输出结果，更新缓存索引",
            "data": "html_report + processing_log -> user_response"
          }
        ]
      },
      {
        "name": "错误处理流程",
        "description": "处理各种异常情况的容错机制",
        "steps": [
          {
            "step": "1. 异常检测",
            "agent": "excel_report_generator",
            "action": "监控各步骤执行状态，捕获异常",
            "data": "step_status -> error_info"
          },
          {
            "step": "2. 错误分类",
            "agent": "excel_report_generator",
            "action": "根据错误类型制定恢复策略",
            "data": "error_info -> recovery_strategy"
          },
          {
            "step": "3. 部分恢复",
            "agent": "excel_report_generator",
            "action": "跳过失败步骤，继续可执行的后续步骤",
            "data": "recovery_strategy -> partial_results"
          },
          {
            "step": "4. 错误报告",
            "agent": "excel_report_generator",
            "action": "生成错误报告，提供用户反馈",
            "data": "partial_results + error_log -> error_report"
          }
        ]
      }
    ],
    "security_considerations": [
      "Excel文件内容仅在本地处理，不上传至外部服务",
      "生成的缓存文件设置适当的文件权限（600）",
      "敏感数据在日志中进行脱敏处理",
      "禁用Excel宏执行，仅读取数据内容",
      "会话ID使用UUID4确保唯一性和不可预测性",
      "定期清理过期缓存文件，避免数据泄露"
    ],
    "error_handling": [
      "文件读取失败：检查文件格式、权限、完整性，提供具体错误信息",
      "数据解析异常：跳过异常行，记录错误位置，继续处理有效数据",
      "内存不足：采用分块读取策略，限制单次处理数据量",
      "图表生成失败：跳过失败图表，继续生成其他图表，在报告中标注",
      "HTML生成错误：使用简化模板，确保基本报告可以生成",
      "缓存写入失败：降级到临时目录，确保结果可以输出"
    ],
    "performance_considerations": [
      "数据读取优化：使用pandas的chunk读取处理大文件",
      "内存管理：及时释放中间变量，使用内存映射文件",
      "并行处理：图表生成支持多线程并行执行",
      "缓存复用：相同数据和参数的图表直接复用缓存",
      "延迟加载：按需加载数据和生成图表",
      "响应时间目标：10MB文件5分钟内完成完整处理"
    ],
    "monitoring_strategy": [
      "进度监控：每个主要步骤完成后更新进度状态",
      "性能监控：记录各步骤执行时间和资源使用情况",
      "错误监控：统计错误类型和频率，建立错误知识库",
      "质量监控：验证生成图表的完整性和HTML报告的有效性",
      "资源监控：监控内存使用、磁盘空间、CPU占用率",
      "用户体验监控：收集用户反馈和满意度评分"
    ]
  },
  "design_rationale": "本系统架构设计基于以下核心考虑：1) 单Agent架构选择：基于需求分析，该项目功能虽然复杂但流程线性，无需多Agent协作，单Agent配合专业工具更加高效简洁。选择data_analyzer_agent模板作为基础，该模板已经集成了数据分析的核心功能，只需扩展图表生成和HTML报告功能。2) 管道化设计：数据处理采用清晰的管道模式，每个步骤职责明确，便于测试和维护。支持部分失败时的优雅降级。3) 工具化架构：每种图表类型对应专门工具函数，确保稳定性和幂等性。工具函数独立可测，便于单元测试和功能验证。4) 缓存策略：采用分层缓存设计，支持会话隔离和历史追溯。通过文件哈希实现智能复用，提升性能。5) 容错设计：各个环节都有完善的错误处理机制，单点失败不影响整体流程。支持部分结果输出，提升用户体验。6) 性能优化：针对大文件处理采用分块读取、并行处理、内存优化等策略。设定明确的性能目标并提供监控手段。7) 安全考虑：所有数据处理均在本地进行，不依赖外部服务，确保数据安全。完善的权限控制和数据脱敏机制。该架构设计充分考虑了需求的完整性、系统的可扩展性、运行的稳定性和维护的便利性，为后续的详细设计和开发实现提供了坚实的基础。"
}
{
  "agent_code_development": {
    "main.py": "```python\n# agents/generated_agents/greeting_agent/main.py\n\nimport uvicorn\nimport os\nimport sys\nimport time\nfrom fastapi import FastAPI, Request\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.responses import JSONResponse\nfrom fastapi.openapi.utils import get_openapi\n\n# 添加项目根目录到Python路径\nsys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))))\n\n# 导入自定义模块\nfrom .routes import router as api_router\nfrom .middleware import LoggingMiddleware, MetricsMiddleware\nfrom .config import settings, APP_VERSION, APP_START_TIME\nfrom tools.generated_tools.logger import Logger\nfrom tools.generated_tools.metrics_collector import MetricsCollector\n\n# 初始化指标收集器\nmetrics_collector = MetricsCollector()\n\n# 初始化日志记录器\nlogger = Logger.setup_logger(\n    name=\"greeting_api\",\n    level=settings.log_level,\n    log_format=settings.log_format,\n    log_file=settings.log_file\n)\n\n# 创建FastAPI应用\napp = FastAPI(\n    title=\"Greeting API\",\n    description=\"A simple API for time-aware greetings\",\n    version=APP_VERSION,\n    docs_url=\"/docs\",\n    redoc_url=\"/redoc\"\n)\n\n# 添加CORS中间件\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=settings.cors_origins,\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# 添加自定义中间件\napp.add_middleware(LoggingMiddleware, logger=logger)\napp.add_middleware(MetricsMiddleware, metrics_collector=metrics_collector)\n\n# 包含API路由\napp.include_router(api_router)\n\n# 自定义OpenAPI文档\ndef custom_openapi():\n    if app.openapi_schema:\n        return app.openapi_schema\n    \n    openapi_schema = get_openapi(\n        title=\"Greeting API\",\n        version=APP_VERSION,\n        description=\"A simple API for time-aware greetings. Returns appropriate greetings based on the current time.\",\n        routes=app.routes,\n    )\n    \n    # 添加服务器信息\n    openapi_schema[\"info\"][\"x-server-info\"] = {\n        \"environment\": settings.environment,\n        \"version\": APP_VERSION\n    }\n    \n    app.openapi_schema = openapi_schema\n    return app.openapi_schema\n\napp.openapi = custom_openapi\n\n# 优雅关闭处理\n@app.on_event(\"shutdown\")\nasync def shutdown_event():\n    logger.info({\"message\": \"Application shutting down\", \"data\": {\"uptime\": time.time() - APP_START_TIME}})\n\n# 直接运行模块时的入口点\nif __name__ == \"__main__\":\n    uvicorn.run(\n        \"main:app\",\n        host=settings.host,\n        port=settings.port,\n        reload=settings.reload,\n        workers=settings.workers\n    )\n```",
    
    "config.py": "```python\n# agents/generated_agents/greeting_agent/config.py\n\nimport os\nimport time\nfrom pydantic import BaseSettings, Field\nfrom typing import List\n\n# 应用版本和启动时间\nAPP_VERSION = \"1.0.0\"\nAPP_START_TIME = time.time()\n\nclass Settings(BaseSettings):\n    \"\"\"\n    应用配置设置\n    \"\"\"\n    # 服务器设置\n    host: str = Field(default=\"0.0.0.0\", env=\"HOST\")\n    port: int = Field(default=8000, env=\"PORT\")\n    reload: bool = Field(default=False, env=\"RELOAD\")\n    workers: int = Field(default=1, env=\"WORKERS\")\n    \n    # 环境设置\n    environment: str = Field(default=\"development\", env=\"ENVIRONMENT\")\n    debug: bool = Field(default=False, env=\"DEBUG\")\n    \n    # 日志设置\n    log_level: str = Field(default=\"info\", env=\"LOG_LEVEL\")\n    log_format: str = Field(default=\"json\", env=\"LOG_FORMAT\")\n    log_file: str = Field(default=None, env=\"LOG_FILE\")\n    \n    # CORS设置\n    cors_origins: List[str] = Field(\n        default=[\"*\"],\n        env=\"CORS_ORIGINS\"\n    )\n    \n    # 问候设置\n    default_language: str = Field(default=\"zh\", env=\"DEFAULT_LANGUAGE\")\n    \n    class Config:\n        env_file = \".env\"\n        case_sensitive = False\n\n# 创建设置实例\nsettings = Settings()\n\n# 问候时间段配置\nTIME_RANGES = {\n    \"morning\": (6, 12),     # 早晨: 6点到12点\n    \"afternoon\": (12, 18), # 下午: 12点到18点\n    \"evening\": (18, 22),   # 晚上: 18点到22点\n    \"night\": (22, 6)       # 深夜: 22点到6点\n}\n```",
    
    "models.py": "```python\n# agents/generated_agents/greeting_agent/models.py\n\nfrom pydantic import BaseModel, Field, validator\nfrom typing import Optional, Dict, Any\n\nclass GreetingRequest(BaseModel):\n    \"\"\"\n    问候请求模型\n    \"\"\"\n    name: str = Field(..., min_length=1, max_length=50, description=\"User name\")\n    language: Optional[str] = Field(\"zh\", description=\"Language code (zh/en)\")\n    timezone: Optional[str] = Field(None, description=\"Timezone in IANA format (e.g. Asia/Shanghai)\")\n    \n    @validator(\"language\")\n    def validate_language(cls, v):\n        if v not in [\"zh\", \"en\"]:\n            raise ValueError(f\"Unsupported language: {v}. Supported languages are: zh, en\")\n        return v\n\nclass GreetingResponse(BaseModel):\n    \"\"\"\n    问候响应模型\n    \"\"\"\n    status: str = Field(..., description=\"Response status (success/error)\")\n    message: str = Field(..., description=\"Greeting message\")\n    data: Dict[str, Any] = Field(..., description=\"Response metadata\")\n\nclass ErrorResponse(BaseModel):\n    \"\"\"\n    错误响应模型\n    \"\"\"\n    status: str = Field(\"error\", description=\"Error status\")\n    error: str = Field(..., description=\"Error message\")\n    error_code: str = Field(..., description=\"Error code\")\n    details: Optional[Dict[str, Any]] = Field(None, description=\"Error details\")\n    timestamp: str = Field(..., description=\"Error timestamp in ISO 8601 format\")\n\nclass HealthResponse(BaseModel):\n    \"\"\"\n    健康检查响应模型\n    \"\"\"\n    status: str = Field(..., description=\"Health status (healthy/unhealthy)\")\n    version: str = Field(..., description=\"Application version\")\n    uptime: str = Field(..., description=\"Application uptime in format 'Xh Ym Zs'\")\n    timestamp: str = Field(..., description=\"Timestamp in ISO 8601 format\")\n    metrics: Dict[str, Any] = Field(..., description=\"Service metrics\")\n```",
    
    "routes.py": "```python\n# agents/generated_agents/greeting_agent/routes.py\n\nfrom fastapi import APIRouter, Depends, Query, Body, Request, HTTPException\nfrom fastapi.responses import JSONResponse\nimport time\nimport datetime\n\n# 导入自定义模块\nfrom .models import GreetingRequest, GreetingResponse, ErrorResponse, HealthResponse\nfrom .services import GreetingService, HealthService\nfrom .config import APP_VERSION, APP_START_TIME, settings\n\n# 创建路由器\nrouter = APIRouter()\n\n# 问候服务实例\ngreeting_service = GreetingService()\n\n# 健康检查服务实例\nhealth_service = HealthService()\n\n@router.post(\"/api/greet\", response_model=GreetingResponse, tags=[\"greeting\"])\nasync def greet_post(request: Request, greeting_req: GreetingRequest):\n    \"\"\"\n    根据当前时间生成个性化问候语\n    \n    - **name**: 用户名称\n    - **language**: 语言代码 (zh/en)\n    - **timezone**: 时区 (可选，IANA格式)\n    \"\"\"\n    start_time = time.time()\n    \n    try:\n        # 调用问候服务生成问候\n        response = greeting_service.generate_greeting(\n            name=greeting_req.name,\n            language=greeting_req.language,\n            timezone=greeting_req.timezone\n        )\n        \n        # 计算处理时间\n        processing_time = (time.time() - start_time) * 1000\n        response[\"data\"][\"processing_time_ms\"] = round(processing_time, 2)\n        \n        return response\n    except ValueError as e:\n        # 处理验证错误\n        raise HTTPException(\n            status_code=400,\n            detail=str(e)\n        )\n    except Exception as e:\n        # 处理其他错误\n        raise HTTPException(\n            status_code=500,\n            detail=\"Internal server error\"\n        )\n\n@router.get(\"/api/greet\", response_model=GreetingResponse, tags=[\"greeting\"])\nasync def greet_get(\n    request: Request,\n    name: str = Query(..., min_length=1, max_length=50, description=\"User name\"),\n    language: str = Query(\"zh\", description=\"Language code (zh/en)\"),\n    timezone: Optional[str] = Query(None, description=\"Timezone in IANA format\")\n):\n    \"\"\"\n    根据当前时间生成个性化问候语 (GET方法)\n    \n    - **name**: 用户名称\n    - **language**: 语言代码 (zh/en)\n    - **timezone**: 时区 (可选，IANA格式)\n    \"\"\"\n    start_time = time.time()\n    \n    try:\n        # 验证语言参数\n        if language not in [\"zh\", \"en\"]:\n            raise ValueError(f\"Unsupported language: {language}. Supported languages are: zh, en\")\n        \n        # 调用问候服务生成问候\n        response = greeting_service.generate_greeting(\n            name=name,\n            language=language,\n            timezone=timezone\n        )\n        \n        # 计算处理时间\n        processing_time = (time.time() - start_time) * 1000\n        response[\"data\"][\"processing_time_ms\"] = round(processing_time, 2)\n        \n        return response\n    except ValueError as e:\n        # 处理验证错误\n        raise HTTPException(\n            status_code=400,\n            detail=str(e)\n        )\n    except Exception as e:\n        # 处理其他错误\n        raise HTTPException(\n            status_code=500,\n            detail=\"Internal server error\"\n        )\n\n@router.get(\"/health\", response_model=HealthResponse, tags=[\"system\"])\nasync def health_check(request: Request):\n    \"\"\"\n    服务健康检查端点\n    \n    返回服务状态、版本、运行时间和基本指标\n    \"\"\"\n    # 调用健康检查服务\n    return health_service.check_health(APP_VERSION, APP_START_TIME)\n\n# 404错误处理\n@router.get(\"/{path:path}\", include_in_schema=False)\nasync def not_found(path: str):\n    \"\"\"\n    处理未找到的路径\n    \"\"\"\n    return JSONResponse(\n        status_code=404,\n        content={\n            \"status\": \"error\",\n            \"error\": \"Not Found\",\n            \"error_code\": \"RESOURCE_NOT_FOUND\",\n            \"timestamp\": datetime.datetime.now().isoformat(),\n            \"details\": {\"path\": path}\n        }\n    )\n```",
    
    "services.py": "```python\n# agents/generated_agents/greeting_agent/services.py\n\nimport time\nfrom typing import Dict, Any, Optional\nimport datetime\n\n# 导入工具模块\nfrom tools.generated_tools.time_processor import TimeProcessor\nfrom tools.generated_tools.greeting_generator import GreetingGenerator\nfrom tools.generated_tools.response_formatter import ResponseFormatter\nfrom tools.generated_tools.metrics_collector import MetricsCollector\n\n# 导入配置\nfrom .config import settings\n\nclass GreetingService:\n    \"\"\"\n    问候服务，负责生成问候消息\n    \"\"\"\n    \n    def __init__(self):\n        \"\"\"\n        初始化问候服务\n        \"\"\"\n        # 可以在这里初始化其他资源或依赖\n        pass\n    \n    def generate_greeting(self, name: str, language: str = \"zh\", timezone: Optional[str] = None) -> Dict[str, Any]:\n        \"\"\"\n        根据当前时间生成问候消息\n        \n        Args:\n            name: 用户名称\n            language: 语言代码，支持 'zh'(中文) 和 'en'(英文)，默认为中文\n            timezone: 时区字符串，如不提供则使用系统时区\n            \n        Returns:\n            Dict[str, Any]: 格式化的问候响应\n            \n        Raises:\n            ValueError: 参数验证失败\n        \"\"\"\n        # 获取当前时间\n        try:\n            current_time = TimeProcessor.get_current_time(timezone)\n        except ValueError as e:\n            raise ValueError(str(e))\n        \n        # 确定问候类型\n        greeting_type = TimeProcessor.get_greeting_type(current_time)\n        \n        # 生成问候消息\n        try:\n            greeting_message = GreetingGenerator.generate_greeting(\n                greeting_type=greeting_type,\n                name=name,\n                language=language\n            )\n        except ValueError as e:\n            raise ValueError(str(e))\n        \n        # 格式化响应\n        return ResponseFormatter.format_greeting_response(\n            greeting=greeting_message,\n            greeting_type=greeting_type,\n            language=language,\n            processing_time_ms=0.0  # 这个值会在路由处理器中更新\n        )\n\nclass HealthService:\n    \"\"\"\n    健康检查服务，负责提供服务健康状态\n    \"\"\"\n    \n    def __init__(self):\n        \"\"\"\n        初始化健康检查服务\n        \"\"\"\n        self._metrics_collector = MetricsCollector()\n        self._start_time = time.time()\n    \n    def check_health(self, version: str, start_time: float) -> Dict[str, Any]:\n        \"\"\"\n        检查服务健康状态\n        \n        Args:\n            version: 应用版本\n            start_time: 应用启动时间戳\n            \n        Returns:\n            Dict[str, Any]: 健康检查响应\n        \"\"\"\n        # 计算运行时间\n        uptime = time.time() - start_time\n        \n        # 获取基本指标\n        metrics = {\n            \"total_requests\": self._metrics_collector.get_request_count(),\n            \"avg_response_time\": round(self._metrics_collector.get_avg_response_time(), 2),\n            \"p95_response_time\": round(self._metrics_collector.get_p95_response_time(), 2),\n            \"error_rate\": round(self._metrics_collector.get_error_rate() * 100, 2)\n        }\n        \n        # 确定健康状态 - 这里可以添加更多的健康检查逻辑\n        is_healthy = True\n        \n        # 格式化健康检查响应\n        return ResponseFormatter.format_health_response(\n            is_healthy=is_healthy,\n            version=version,\n            uptime_seconds=uptime,\n            metrics=metrics\n        )\n```",
    
    "middleware.py": "```python\n# agents/generated_agents/greeting_agent/middleware.py\n\nimport time\nfrom fastapi import Request, Response\nfrom fastapi.middleware.base import BaseHTTPMiddleware\nfrom starlette.types import ASGIApp\nfrom typing import Callable, Dict, Any\nimport logging\nimport json\nimport traceback\n\nclass LoggingMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    日志中间件，记录请求和响应信息\n    \"\"\"\n    \n    def __init__(self, app: ASGIApp, logger: logging.Logger):\n        \"\"\"\n        初始化日志中间件\n        \n        Args:\n            app: ASGI应用\n            logger: 日志记录器\n        \"\"\"\n        super().__init__(app)\n        self.logger = logger\n    \n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        \"\"\"\n        处理请求并记录日志\n        \n        Args:\n            request: HTTP请求\n            call_next: 下一个处理函数\n            \n        Returns:\n            Response: HTTP响应\n        \"\"\"\n        start_time = time.time()\n        request_id = request.headers.get(\"X-Request-ID\", \"\")\n        \n        # 记录请求信息\n        self.logger.info({\n            \"message\": \"Request received\",\n            \"data\": {\n                \"request_id\": request_id,\n                \"method\": request.method,\n                \"url\": str(request.url),\n                \"client_ip\": request.client.host if request.client else \"unknown\",\n                \"user_agent\": request.headers.get(\"User-Agent\", \"unknown\")\n            }\n        })\n        \n        # 处理请求\n        try:\n            response = await call_next(request)\n            process_time = time.time() - start_time\n            \n            # 记录响应信息\n            self.logger.info({\n                \"message\": \"Request completed\",\n                \"data\": {\n                    \"request_id\": request_id,\n                    \"method\": request.method,\n                    \"url\": str(request.url),\n                    \"status_code\": response.status_code,\n                    \"processing_time_ms\": round(process_time * 1000, 2)\n                }\n            })\n            \n            # 添加处理时间到响应头\n            response.headers[\"X-Process-Time\"] = str(round(process_time * 1000, 2))\n            if request_id:\n                response.headers[\"X-Request-ID\"] = request_id\n                \n            return response\n        except Exception as e:\n            # 记录错误信息\n            process_time = time.time() - start_time\n            self.logger.error({\n                \"message\": \"Request failed\",\n                \"data\": {\n                    \"request_id\": request_id,\n                    \"method\": request.method,\n                    \"url\": str(request.url),\n                    \"error\": str(e),\n                    \"traceback\": traceback.format_exc(),\n                    \"processing_time_ms\": round(process_time * 1000, 2)\n                }\n            })\n            raise\n\nclass MetricsMiddleware(BaseHTTPMiddleware):\n    \"\"\"\n    指标中间件，收集API性能指标\n    \"\"\"\n    \n    def __init__(self, app: ASGIApp, metrics_collector):\n        \"\"\"\n        初始化指标中间件\n        \n        Args:\n            app: ASGI应用\n            metrics_collector: 指标收集器\n        \"\"\"\n        super().__init__(app)\n        self.metrics_collector = metrics_collector\n    \n    async def dispatch(self, request: Request, call_next: Callable) -> Response:\n        \"\"\"\n        处理请求并收集指标\n        \n        Args:\n            request: HTTP请求\n            call_next: 下一个处理函数\n            \n        Returns:\n            Response: HTTP响应\n        \"\"\"\n        start_time = time.time()\n        endpoint = f\"{request.method} {request.url.path}\"\n        \n        try:\n            response = await call_next(request)\n            \n            # 记录请求指标\n            self.metrics_collector.record_request(\n                endpoint=endpoint,\n                start_time=start_time,\n                status_code=response.status_code\n            )\n            \n            return response\n        except Exception as e:\n            # 记录错误请求指标\n            self.metrics_collector.record_request(\n                endpoint=endpoint,\n                start_time=start_time,\n                status_code=500,\n                error=str(e)\n            )\n            raise\n```"
  }
}
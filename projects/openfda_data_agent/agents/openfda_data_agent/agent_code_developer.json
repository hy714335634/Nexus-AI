{
  "agent_code_development": {
    "development_overview": {
      "project_name": "openfda_data_agent",
      "version": "1.0",
      "date": "2025-12-02",
      "development_scope": "为OpenFDA数据查询Agent开发完整的Python代码，基于API集成专家模板进行定制化开发，实现自然语言查询、多端点路由、API调用、数据解析和格式化等核心功能，遵循AWS Bedrock AgentCore部署规范",
      "design_principles": [
        "单一职责原则：Agent专注于OpenFDA API集成和数据获取",
        "工具驱动架构：利用专用工具处理具体任务",
        "容错优先原则：完善的错误处理和重试机制",
        "AgentCore兼容：严格遵循部署规范",
        "日志完善：全面的日志记录便于调试和监控"
      ],
      "key_decisions": [
        "基于api_integration_agent模板定制开发，复用成熟架构",
        "使用create_agent_from_prompt_template工厂方法创建Agent实例",
        "实现BedrockAgentCoreApp标准入口点，支持AgentCore部署",
        "使用handler函数作为AgentCore标准入口，返回字符串格式",
        "集成5个专用OpenFDA工具，形成完整查询流程",
        "实现健壮的响应解析机制，适配Strands Agent返回格式",
        "提供命令行测试接口，支持本地开发和调试"
      ]
    },
    "agent_implementation": {
      "agent_name": "openfda_data_agent",
      "file_path": "agents/generated_agents/openfda_data_agent/openfda_data_agent.py",
      "main_class": "无（使用函数式编程）",
      "entry_point": "handler函数（AgentCore标准入口点）",
      "dependencies": [
        "os",
        "json",
        "logging",
        "typing",
        "nexus_utils.agent_factory",
        "bedrock_agentcore.runtime"
      ],
      "imports": [
        "import os",
        "import json",
        "import logging",
        "from typing import Dict, Any",
        "from nexus_utils.agent_factory import create_agent_from_prompt_template",
        "from bedrock_agentcore.runtime import BedrockAgentCoreApp"
      ]
    },
    "core_functions": [
      {
        "function_name": "handler",
        "purpose": "AgentCore标准入口点，处理HTTP请求并返回响应",
        "parameters": [
          {
            "name": "payload",
            "type": "Dict[str, Any]",
            "description": "AgentCore传入的请求体，包含prompt字段",
            "required": true
          }
        ],
        "return_type": "str",
        "return_description": "格式化的响应文本（不是Dict）",
        "implementation_notes": [
          "使用@app.entrypoint装饰器标记为AgentCore入口点",
          "从payload中提取prompt字段",
          "调用openfda_agent处理查询",
          "实现健壮的响应解析机制，适配多种返回格式",
          "返回字符串格式的响应，符合AgentCore规范",
          "完整的错误处理和日志记录"
        ]
      },
      {
        "function_name": "create_agent_from_prompt_template",
        "purpose": "使用工厂方法创建Agent实例",
        "parameters": [
          {
            "name": "agent_name",
            "type": "str",
            "description": "Agent配置路径",
            "required": true
          },
          {
            "name": "env",
            "type": "str",
            "description": "运行环境（production/development/testing）",
            "required": false
          },
          {
            "name": "version",
            "type": "str",
            "description": "Agent版本",
            "required": false
          },
          {
            "name": "model_id",
            "type": "str",
            "description": "LLM模型ID",
            "required": false
          },
          {
            "name": "enable_logging",
            "type": "bool",
            "description": "是否启用日志",
            "required": false
          }
        ],
        "return_type": "Agent",
        "return_description": "配置好的Agent实例",
        "implementation_notes": [
          "从prompts/generated_agents_prompts/openfda_data_agent/目录加载配置",
          "自动加载工具依赖",
          "配置LLM模型和参数",
          "启用日志记录"
        ]
      },
      {
        "function_name": "__main__",
        "purpose": "本地运行入口，支持命令行测试和HTTP服务器启动",
        "parameters": [
          {
            "name": "-i/--input",
            "type": "str",
            "description": "查询输入（自然语言）",
            "required": false
          },
          {
            "name": "--debug",
            "type": "bool",
            "description": "启用调试模式",
            "required": false
          }
        ],
        "return_type": "void",
        "return_description": "无返回值",
        "implementation_notes": [
          "使用argparse解析命令行参数",
          "检查DOCKER_CONTAINER环境变量判断运行模式",
          "本地测试模式：直接调用Agent处理输入",
          "AgentCore部署模式：启动HTTP服务器",
          "提供丰富的使用示例和帮助信息"
        ]
      }
    ],
    "tool_integration": {
      "custom_tools": [
        "openfda_endpoint_router - 智能端点路由",
        "openfda_search_builder - 搜索参数构建",
        "openfda_query - API调用执行",
        "openfda_result_parser - 结果解析",
        "openfda_result_formatter - 结果格式化"
      ],
      "system_tools": [
        "current_time - 时间获取"
      ],
      "strands_tools": [],
      "integration_notes": [
        "工具通过提示词配置文件自动加载",
        "工具调用顺序：端点路由 -> 参数构建 -> API调用 -> 结果解析 -> 结果格式化",
        "每个工具返回JSON格式的结构化数据",
        "Agent负责协调工具调用和处理工具输出"
      ]
    },
    "configuration": {
      "environment_variables": [
        "BYPASS_TOOL_CONSENT=true - 绕过工具使用确认",
        "DOCKER_CONTAINER=1 - 标识Docker容器环境（AgentCore部署时自动设置）"
      ],
      "model_configuration": {
        "model_name": "global.anthropic.claude-sonnet-4-5-20250929-v1:0",
        "max_tokens": 60000,
        "temperature": 0.3,
        "streaming": false
      },
      "streaming_config": {
        "enabled": false,
        "chunk_size": 1024
      },
      "agent_parameters": {
        "env": "production",
        "version": "latest",
        "model_id": "default",
        "enable_logging": true
      }
    },
    "error_handling": {
      "exception_types": [
        "Missing prompt field - 缺少prompt字段",
        "Agent execution error - Agent执行失败",
        "Response parsing error - 响应解析失败",
        "Tool call error - 工具调用失败",
        "API error - OpenFDA API错误"
      ],
      "error_responses": [
        "Error: Missing 'prompt' in request. Please provide a query.",
        "Error: Agent execution failed - {error_message}",
        "Error: {specific_error_description}"
      ],
      "recovery_strategies": [
        "参数缺失：返回明确的错误提示",
        "Agent执行失败：记录详细错误日志，返回友好错误信息",
        "响应解析失败：尝试多种解析方式，fallback到字符串转换",
        "工具调用失败：由Agent的提示词逻辑处理重试",
        "API错误：由openfda_query工具处理重试和错误返回"
      ]
    },
    "testing": {
      "test_cases": [
        "基础查询：python openfda_data_agent.py -i '查询阿司匹林的不良反应'",
        "设备查询：python openfda_data_agent.py -i '查询心脏起搏器的召回信息'",
        "食品查询：python openfda_data_agent.py -i '查询沙门氏菌相关的食品召回'",
        "复杂查询：python openfda_data_agent.py -i '查询2023年的药物不良事件，按严重程度排序'",
        "调试模式：python openfda_data_agent.py -i '测试查询' --debug"
      ],
      "test_scenarios": [
        "正常查询场景：验证完整查询流程",
        "错误查询场景：测试无效输入处理",
        "API失败场景：测试重试机制",
        "多轮对话场景：测试上下文维护",
        "AgentCore部署场景：测试HTTP端点"
      ],
      "validation_criteria": [
        "Agent实例创建成功",
        "handler函数正确处理payload",
        "响应格式为字符串",
        "错误情况返回友好提示",
        "日志记录完整",
        "命令行参数解析正确",
        "HTTP服务器启动成功"
      ]
    },
    "deployment": {
      "deployment_requirements": [
        "Python 3.13+运行环境",
        "Strands SDK和相关依赖",
        "BedrockAgentCoreApp库",
        "nexus_utils工具包",
        "OpenFDA API网络访问",
        "提示词配置文件（prompts/generated_agents_prompts/openfda_data_agent/）",
        "工具代码文件（tools/generated_tools/openfda_data_agent/）"
      ],
      "runtime_dependencies": [
        "strands-agents",
        "strands-agents-tools",
        "boto3",
        "botocore",
        "requests",
        "PyYAML",
        "./nexus_utils"
      ],
      "performance_considerations": [
        "单次查询响应时间控制在5秒内",
        "API调用超时时间30秒",
        "最多重试3次，指数退避策略",
        "结果默认限制10条，最大100条",
        "日志级别production环境使用INFO",
        "避免在handler中进行耗时操作"
      ],
      "agentcore_deployment": {
        "entry_point": "handler函数",
        "http_endpoint": "POST /invocations",
        "port": 8080,
        "payload_format": "{\"prompt\": \"user query\"}",
        "response_format": "Plain text string",
        "environment_variables": [
          "BYPASS_TOOL_CONSENT=true",
          "DOCKER_CONTAINER=1"
        ],
        "dockerfile_requirements": [
          "基于Python 3.13镜像",
          "安装requirements.txt依赖",
          "复制Agent代码和配置文件",
          "暴露8080端口",
          "设置DOCKER_CONTAINER=1环境变量",
          "启动命令：python openfda_data_agent.py"
        ]
      }
    },
    "development_notes": "Agent代码开发完成，严格遵循API集成专家模板架构和AgentCore部署规范。核心特性包括：1) 使用BedrockAgentCoreApp实现标准入口点，支持HTTP服务器模式；2) 实现健壮的响应解析机制，适配Strands Agent的多种返回格式；3) 完善的日志记录系统，便于调试和监控；4) 灵活的运行模式，支持本地测试和AgentCore部署；5) 清晰的命令行接口，提供丰富的使用示例。代码质量方面：遵循PEP 8规范，使用完整的类型注解，提供详细的文档字符串，实现全面的错误处理。集成方面：通过agent_factory工厂方法创建Agent实例，自动加载提示词配置和工具依赖，确保配置和代码的分离。部署方面：符合AgentCore的所有技术要求，handler函数返回字符串格式，使用@app.entrypoint装饰器，支持Docker容器化部署。"
  }
}
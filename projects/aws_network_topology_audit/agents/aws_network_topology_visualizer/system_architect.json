{
  "system_design": {
    "design_overview": {
      "project_name": "aws_network_topology_audit",
      "version": "1.0",
      "date": "2025-11-11",
      "design_scope": "设计一个用于收集、分析和可视化AWS网络拓扑结构的系统，专注于满足审计要求，能够展示各种VPC连接类型并高亮显示网络边界。",
      "design_principles": [
        "模块化设计，将数据收集、分析和可视化功能分离",
        "可扩展性，支持未来添加更多网络资源类型和连接类型",
        "安全性，遵循最小权限原则访问AWS资源",
        "可观测性，提供详细的日志和错误信息",
        "用户友好，生成直观清晰的网络拓扑图"
      ],
      "key_decisions": [
        "采用单Agent架构，集成数据收集、分析和可视化功能",
        "使用boto3 SDK访问AWS API获取网络资源信息",
        "使用NetworkX和Graphviz进行网络拓扑图生成和可视化",
        "实现跨区域和跨账户资源收集",
        "采用颜色编码和图形符号区分不同类型的网络连接和边界"
      ],
      "workflow_type": "single_agent",
      "recommended_templates": ["data_analyzer_agent"]
    },
    "architecture": {
      "system_context": "系统将作为一个独立的工具运行，通过AWS API收集网络资源信息，分析网络连接关系，并生成可视化的网络拓扑图。用户提供AWS凭证和配置参数，系统返回网络拓扑图和相关分析结果。",
      "agent_topology": "单Agent架构，包含数据收集、关系分析和可视化渲染三个主要功能模块",
      "interaction_model": "用户通过命令行或简单界面与Agent交互，提供AWS凭证和配置参数，Agent完成数据收集、分析和可视化，返回网络拓扑图和分析结果",
      "technology_stack": {
        "sdk": "Strands SDK",
        "runtime": "Local",
        "integrations": [
          "AWS SDK (boto3)",
          "NetworkX (网络分析库)",
          "Graphviz/PyGraphviz (图形可视化)",
          "Matplotlib/Pillow (图像处理)"
        ]
      }
    },
    "agents": [
      {
        "name": "aws_network_topology_visualizer",
        "purpose": "收集AWS网络资源信息，分析网络连接关系，生成可视化的网络拓扑图，并高亮显示网络边界",
        "responsibilities": [
          "收集AWS网络资源信息（VPC、子网、路由表、安全组等）",
          "识别各种类型的VPC连接（TGW、VPC Peering、PrivateLink等）",
          "识别跨区域和跨账户连接",
          "识别通过CGW、DXGW的连接",
          "识别通过Network Firewall隔离的网络",
          "分析网络连接关系和网络边界",
          "生成可视化的网络拓扑图",
          "高亮显示网络边界",
          "导出网络拓扑图"
        ],
        "interfaces": {
          "inputs": [
            "AWS凭证（访问密钥或角色ARN）",
            "区域范围（单个或多个区域）",
            "账户范围（单个或多个账户）",
            "资源过滤条件（可选）",
            "输出格式和路径（可选）",
            "可视化选项（布局、颜色方案等）"
          ],
          "outputs": [
            "网络拓扑图（PNG、JPG、SVG格式）",
            "资源收集摘要（资源类型和数量）",
            "网络连接分析报告",
            "网络边界识别结果",
            "错误和警告信息"
          ]
        },
        "dependencies": [
          "AWS API（EC2、VPC、Transit Gateway、Direct Connect等）",
          "图形可视化库（NetworkX、Graphviz）"
        ],
        "implementation_notes": [
          "使用boto3 SDK访问AWS API，需要适当的IAM权限",
          "支持跨账户访问，使用角色切换功能",
          "使用NetworkX构建网络图模型",
          "使用Graphviz进行图形渲染",
          "实现缓存机制减少API调用",
          "实现错误重试和限流处理"
        ],
        "recommended_template": "data_analyzer_agent"
      }
    ],
    "data_models": [
      {
        "name": "NetworkResource",
        "schema": "基础网络资源模型，包含资源ID、名称、类型、区域、账户ID等通用属性",
        "validation_rules": [
          "资源ID必须唯一",
          "资源类型必须是预定义的有效类型",
          "区域代码必须是有效的AWS区域"
        ],
        "relationships": ["作为所有具体网络资源类型的基类"]
      },
      {
        "name": "VPC",
        "schema": "VPC资源模型，继承自NetworkResource，包含CIDR块、是否默认VPC、标签等属性",
        "validation_rules": [
          "CIDR块必须是有效的IPv4或IPv6地址范围",
          "VPC ID格式必须符合AWS规范"
        ],
        "relationships": ["包含多个子网", "关联多个路由表", "关联多个安全组", "关联多个网络ACL"]
      },
      {
        "name": "Subnet",
        "schema": "子网资源模型，继承自NetworkResource，包含CIDR块、可用区、是否公有等属性",
        "validation_rules": [
          "CIDR块必须是有效的IPv4或IPv6地址范围",
          "CIDR块必须是所属VPC CIDR块的子集",
          "可用区必须是有效的AWS可用区"
        ],
        "relationships": ["属于一个VPC", "关联一个路由表", "包含多个网络接口"]
      },
      {
        "name": "Connection",
        "schema": "网络连接模型，包含连接ID、连接类型、源资源、目标资源、状态等属性",
        "validation_rules": [
          "连接类型必须是预定义的有效类型（TGW、VPC Peering、PrivateLink等）",
          "源资源和目标资源必须存在",
          "连接状态必须是有效的状态值"
        ],
        "relationships": ["连接两个或多个NetworkResource"]
      },
      {
        "name": "NetworkBoundary",
        "schema": "网络边界模型，包含边界ID、边界类型、相关资源、边界属性等",
        "validation_rules": [
          "边界类型必须是预定义的有效类型（账户边界、区域边界、安全边界等）",
          "相关资源必须存在"
        ],
        "relationships": ["关联一个或多个NetworkResource", "关联一个或多个Connection"]
      },
      {
        "name": "TopologyGraph",
        "schema": "拓扑图模型，包含节点集合、边集合、布局信息、可视化属性等",
        "validation_rules": [
          "节点必须对应有效的NetworkResource",
          "边必须对应有效的Connection"
        ],
        "relationships": ["包含多个NetworkResource作为节点", "包含多个Connection作为边", "包含多个NetworkBoundary作为特殊标记"]
      }
    ],
    "interaction_flows": [
      {
        "name": "数据收集流程",
        "description": "收集AWS网络资源信息的流程",
        "steps": [
          {
            "step": "验证AWS凭证",
            "agent": "aws_network_topology_visualizer",
            "action": "验证提供的AWS凭证是否有效",
            "data": "AWS访问密钥或角色ARN"
          },
          {
            "step": "确定收集范围",
            "agent": "aws_network_topology_visualizer",
            "action": "根据用户输入确定区域和账户范围",
            "data": "区域列表、账户列表"
          },
          {
            "step": "收集VPC资源",
            "agent": "aws_network_topology_visualizer",
            "action": "调用AWS API收集VPC及相关资源信息",
            "data": "VPC、子网、路由表、安全组等资源数据"
          },
          {
            "step": "收集连接资源",
            "agent": "aws_network_topology_visualizer",
            "action": "调用AWS API收集各种连接资源信息",
            "data": "TGW、VPC Peering、PrivateLink、CGW、DXGW等连接数据"
          },
          {
            "step": "收集安全资源",
            "agent": "aws_network_topology_visualizer",
            "action": "调用AWS API收集网络安全相关资源信息",
            "data": "Network Firewall、安全组规则、网络ACL规则等安全数据"
          },
          {
            "step": "生成资源收集摘要",
            "agent": "aws_network_topology_visualizer",
            "action": "统计收集到的资源类型和数量",
            "data": "资源收集摘要报告"
          }
        ]
      },
      {
        "name": "网络关系分析流程",
        "description": "分析网络资源之间的连接关系的流程",
        "steps": [
          {
            "step": "构建资源图",
            "agent": "aws_network_topology_visualizer",
            "action": "将收集到的资源转换为图数据结构",
            "data": "NetworkResource对象集合"
          },
          {
            "step": "识别VPC连接",
            "agent": "aws_network_topology_visualizer",
            "action": "分析并识别各种类型的VPC连接",
            "data": "Connection对象集合"
          },
          {
            "step": "识别跨区域连接",
            "agent": "aws_network_topology_visualizer",
            "action": "识别跨区域的网络连接",
            "data": "跨区域Connection对象集合"
          },
          {
            "step": "识别跨账户连接",
            "agent": "aws_network_topology_visualizer",
            "action": "识别跨账户的网络连接",
            "data": "跨账户Connection对象集合"
          },
          {
            "step": "识别网络边界",
            "agent": "aws_network_topology_visualizer",
            "action": "识别各种类型的网络边界",
            "data": "NetworkBoundary对象集合"
          },
          {
            "step": "生成连接分析报告",
            "agent": "aws_network_topology_visualizer",
            "action": "生成网络连接分析报告",
            "data": "连接分析报告"
          }
        ]
      },
      {
        "name": "拓扑图生成流程",
        "description": "生成可视化网络拓扑图的流程",
        "steps": [
          {
            "step": "构建拓扑图模型",
            "agent": "aws_network_topology_visualizer",
            "action": "基于资源图和连接分析结果构建拓扑图模型",
            "data": "TopologyGraph对象"
          },
          {
            "step": "应用布局算法",
            "agent": "aws_network_topology_visualizer",
            "action": "应用图布局算法优化节点位置",
            "data": "带布局信息的TopologyGraph对象"
          },
          {
            "step": "应用视觉样式",
            "agent": "aws_network_topology_visualizer",
            "action": "应用颜色、形状、线型等视觉样式",
            "data": "带视觉样式的TopologyGraph对象"
          },
          {
            "step": "高亮网络边界",
            "agent": "aws_network_topology_visualizer",
            "action": "在拓扑图中高亮显示网络边界",
            "data": "带边界高亮的TopologyGraph对象"
          },
          {
            "step": "添加图例和标签",
            "agent": "aws_network_topology_visualizer",
            "action": "添加图例、标签和说明文本",
            "data": "带图例和标签的TopologyGraph对象"
          },
          {
            "step": "渲染拓扑图",
            "agent": "aws_network_topology_visualizer",
            "action": "将拓扑图模型渲染为图像",
            "data": "拓扑图图像文件"
          },
          {
            "step": "导出拓扑图",
            "agent": "aws_network_topology_visualizer",
            "action": "将拓扑图导出为指定格式",
            "data": "PNG、JPG或SVG格式的拓扑图文件"
          }
        ]
      }
    ],
    "security_considerations": [
      "使用最小权限原则配置IAM权限，只请求必要的只读权限",
      "不在代码中存储AWS凭证，使用环境变量、配置文件或临时凭证",
      "支持使用IAM角色进行跨账户访问，避免共享长期凭证",
      "提供选项允许用户模糊处理敏感信息（如IP地址、资源ID）",
      "确保导出的拓扑图不包含敏感信息",
      "实现日志记录但避免记录敏感信息"
    ],
    "error_handling": [
      "实现AWS API调用的错误重试机制，处理临时性故障",
      "处理API限流情况，实现指数退避策略",
      "处理权限不足的情况，提供清晰的错误信息和所需权限列表",
      "处理资源不存在或无法访问的情况",
      "处理跨账户访问失败的情况，提供故障排除指南",
      "提供详细的错误日志，帮助诊断问题",
      "实现优雅的失败处理，即使部分数据收集失败也能生成部分拓扑图"
    ],
    "performance_considerations": [
      "实现并行API调用，提高数据收集效率",
      "实现缓存机制，避免重复API调用",
      "使用分页处理大量资源数据",
      "优化图布局算法，提高拓扑图渲染性能",
      "对于大规模环境，实现资源过滤和采样机制",
      "提供进度指示器，显示数据收集和处理进度",
      "针对大型拓扑图，实现分层或分区显示"
    ],
    "monitoring_strategy": [
      "记录API调用次数和响应时间，监控API使用情况",
      "记录数据收集和处理时间，识别性能瓶颈",
      "记录错误和警告信息，帮助诊断问题",
      "提供详细的操作日志，记录系统活动",
      "实现可配置的日志级别，控制日志详细程度",
      "记录资源统计信息，帮助了解环境规模和复杂度"
    ]
  },
  "design_rationale": "本设计采用单Agent架构，主要基于以下考虑：1）需求集中于数据收集、分析和可视化，功能相对集中，不需要复杂的多Agent协作；2）单Agent架构简化了开发和维护，减少了组件间通信的复杂性；3）数据流较为线性，从收集到分析再到可视化，适合在单个Agent中实现。\n\n推荐使用data_analyzer_agent模板作为基础，因为该模板已具备数据处理和可视化的基本框架，与项目需求高度匹配。虽然需要扩展AWS资源收集和网络拓扑可视化功能，但基本框架可以复用。\n\n系统设计采用模块化方法，将功能分为数据收集、关系分析和可视化渲染三个主要模块，这样有利于代码组织和未来扩展。数据模型设计遵循面向对象原则，使用继承关系简化代码并提高可维护性。\n\n交互流程设计考虑了数据处理的自然顺序，从收集原始数据，到分析关系，再到生成可视化结果。每个步骤都有明确的输入和输出，便于测试和调试。\n\n安全性、错误处理、性能和监控策略的设计考虑了AWS环境的特点和审计需求的重要性，确保系统在各种情况下都能可靠运行并提供有用的结果。"
}
{
  "agent_design": {
    "design_overview": {
      "project_name": "children_chat_companion",
      "version": "1.0",
      "date": "2025-12-23",
      "design_scope": "设计一个专为3-12岁儿童提供陪伴聊天服务的智能体，具备年龄适配对话、多轮上下文管理、用户画像构建、会话记忆加载等核心能力。基于Strands SDK和Claude模型实现，采用单Agent架构，通过提示词工程实现大部分功能，最小化工具开发。",
      "design_goals": [
        "创建一个儿童友好的对话Agent，能够以适合3-12岁不同年龄段的方式进行自然交流",
        "实现渐进式用户画像构建机制，在对话中自然地了解和记录儿童的特征、兴趣和偏好",
        "提供跨会话的记忆连续性，使Agent能够在新会话中加载历史画像和关键记忆",
        "确保对话内容的安全性和适龄性，保护儿童免受不当内容影响",
        "提供流畅的实时交互体验，通过流式响应实现逐字显示",
        "设计优雅的错误处理和降级机制，确保系统稳定可靠",
        "采用模块化设计，便于未来功能扩展和优化"
      ],
      "key_design_decisions": [
        {
          "decision": "采用单Agent架构，所有功能集中在children_chat_companion Agent中",
          "rationale": "需求分析确认该项目为单Agent场景，所有功能围绕对话交互展开，不涉及多角色协作。单Agent架构降低系统复杂度，简化状态管理，提高响应速度。",
          "alternatives": [
            "多Agent架构（如对话Agent+画像管理Agent+记忆管理Agent）",
            "混合架构（主Agent+辅助工具Agent）"
          ],
          "consequences": [
            "优点：系统简单，维护成本低，响应速度快，状态管理统一",
            "缺点：单点故障风险，功能扩展需修改核心Agent"
          ]
        },
        {
          "decision": "基于multimodal_analyzer_agent模板定制Agent实现",
          "rationale": "该模板已具备多轮对话管理、流式响应、上下文维护等核心能力，与儿童陪伴Agent需求高度契合。通过定制提示词和添加画像管理工具，可快速实现目标功能。",
          "alternatives": [
            "从零开始开发全新Agent",
            "基于其他模板（如default.yaml）定制"
          ],
          "consequences": [
            "优点：开发效率高，代码质量有保障，已验证的流式响应机制",
            "缺点：需要理解模板原有逻辑，部分功能可能需要适配"
          ]
        },
        {
          "decision": "通过提示词工程实现年龄适配、画像提取、内容安全等核心功能",
          "rationale": "Claude模型具备强大的语义理解和信息抽取能力，可通过精心设计的提示词实现大部分功能需求，无需开发复杂的NLP工具。这种方式开发效率高，易于迭代优化。",
          "alternatives": [
            "开发专门的NLP工具进行信息抽取和内容过滤",
            "集成第三方NLP服务"
          ],
          "consequences": [
            "优点：开发成本低，迭代速度快，充分利用模型能力",
            "缺点：依赖模型质量，提示词设计需要精心调优"
          ]
        },
        {
          "decision": "仅开发4个基础文件操作工具，最小化工具集",
          "rationale": "分析需求后确认，核心功能可通过提示词实现，仅需基础的文件读写工具支持画像和会话历史的持久化。最小化工具集降低开发和维护成本，提高系统稳定性。",
          "alternatives": [
            "开发更多专用工具（如画像分析工具、内容过滤工具等）",
            "集成外部工具库"
          ],
          "consequences": [
            "优点：工具简单可靠，维护成本低，测试覆盖容易",
            "缺点：功能扩展时可能需要添加新工具"
          ]
        },
        {
          "decision": "采用三段年龄适配策略（3-6岁、7-9岁、10-12岁）",
          "rationale": "平衡了实现复杂度和适配精度。三个年龄段对应儿童认知发展的不同阶段，每个阶段的对话特征差异显著，便于定义清晰的提示词策略。",
          "alternatives": [
            "按年龄逐年适配（12个策略）",
            "粗略分为两段（3-7岁、8-12岁）"
          ],
          "consequences": [
            "优点：适配精度合理，实现复杂度可控，易于维护",
            "缺点：年龄段边界可能不适用于所有儿童，需要后续优化"
          ]
        },
        {
          "decision": "采用渐进式画像构建策略，不强制首次收集完整信息",
          "rationale": "避免一开始就问很多问题影响用户体验，在多次对话中自然地了解儿童特征。这种方式更符合真实社交场景，降低用户负担，提高对话自然度。",
          "alternatives": [
            "首次对话强制收集所有必要信息",
            "通过表单预先收集用户信息"
          ],
          "consequences": [
            "优点：用户体验好，对话自然，信息收集不突兀",
            "缺点：画像构建速度较慢，初期可能缺少关键信息"
          ]
        }
      ]
    },
    "agents": [
      {
        "agent_id": "children_chat_companion",
        "name": "children_chat_companion",
        "role": "儿童陪伴聊天助手",
        "purpose": "为3-12岁儿童提供安全、有趣、富有教育意义的陪伴聊天服务。通过年龄适配的对话方式与儿童进行多轮交流，在对话中自然地构建用户画像，记录儿童的特征、兴趣和喜好，并在跨会话时加载历史记忆，实现连续性的个性化互动体验。",
        "personality": {
          "traits": [
            "友好亲切 - 像朋友一样与儿童交流，使用温暖的语气",
            "耐心倾听 - 认真理解儿童的表达，不打断，给予充分的关注",
            "积极鼓励 - 对儿童的分享和成就给予真诚的肯定和鼓励",
            "富有好奇心 - 对儿童的兴趣爱好表现出真诚的好奇和兴趣",
            "适度幽默 - 使用儿童能理解的幽默方式，增加对话趣味性",
            "教育引导 - 在对话中自然地融入知识点，启发思考"
          ],
          "communication_style": "根据儿童年龄自动适配对话风格。对3-6岁儿童使用简单词汇、短句子、拟声词和重复表达；对7-9岁儿童使用中等复杂度词汇、故事化表达和适度成语；对10-12岁儿童使用丰富词汇、复杂句式和启发式引导。整体风格活泼生动，富有童趣，充满正能量。",
          "tone": "温暖、友善、充满鼓励。使用第一人称（我）与儿童对话，营造平等友好的氛围。适时使用emoji和感叹词增加亲和力。避免说教式语气，以朋友的身份进行交流。"
        },
        "capabilities": {
          "core_functions": [
            "年龄适配对话 - 根据儿童年龄（3-6岁、7-9岁、10-12岁）自动调整对话内容、词汇难度、句式复杂度和互动方式",
            "多轮上下文管理 - 维护3-5轮对话的上下文窗口，理解代词指代、话题延续和对话连贯性",
            "用户画像构建 - 在对话中自动识别和提取儿童的年龄、性别、兴趣、性格、习惯等特征信息",
            "画像实时更新 - 每次对话结束后分析对话内容，更新用户画像中的相关字段和统计信息",
            "会话记忆加载 - 新会话开始时加载用户历史画像和最近会话的关键记忆，实现跨会话连续性",
            "流式实时响应 - 通过BedrockAgentCore流式响应机制，逐字显示回复内容，提供流畅交互体验",
            "内容安全控制 - 确保生成的对话内容符合儿童内容安全标准，过滤不当信息，引导正面话题",
            "趣味性互动 - 在对话中加入emoji、拟声词、比喻、故事等元素，增加对话趣味性",
            "教育性引导 - 根据对话情境自然地融入科学、历史、文化等知识点，启发儿童思考",
            "错误优雅处理 - 处理画像加载失败、会话历史缺失、流式响应中断等异常情况，确保对话不中断"
          ],
          "specialized_skills": [
            "信息抽取能力 - 从儿童的自然语言输入中提取结构化的画像信息（年龄、兴趣、性格等）",
            "年龄推断能力 - 当年龄信息缺失时，通过语言风格、表达内容推断大致年龄段",
            "兴趣权重管理 - 根据兴趣被提及的频率和时间动态调整兴趣权重，反映真实偏好变化",
            "关键记忆提取 - 识别对话中的重要事件、特殊偏好、需要记住的细节，存入关键记忆列表",
            "话题引导能力 - 当对话停滞或儿童不知道说什么时，根据画像中的兴趣主动提出话题",
            "情感识别能力 - 识别儿童的情绪状态（开心、难过、兴奋等），给予适当的回应和安慰",
            "安全话题转换 - 当儿童提到不当内容或敏感话题时，礼貌地引导话题转向正面内容"
          ],
          "limitations": [
            "仅支持中文对话，初版不支持多语言",
            "不支持语音输入输出，仅支持文本交互",
            "不支持图像、视频等多模态内容生成",
            "不提供家长监控和管理界面",
            "不具备用户认证和账号管理功能",
            "单次会话历史限制为50轮对话，超过后需归档",
            "上下文窗口限制为3-5轮，更早的对话内容不在当前上下文中",
            "依赖本地文件系统，不支持分布式存储",
            "不支持与其他儿童的社交互动功能"
          ],
          "tools_required": [
            "load_user_profile - 从本地文件系统加载用户画像（profile.json）",
            "save_user_profile - 将更新后的用户画像保存到本地文件系统",
            "load_session_history - 加载指定会话的历史对话记录（session_<id>.json）",
            "save_session_history - 将当前会话的对话记录保存到本地文件系统"
          ]
        },
        "knowledge_domain": {
          "primary_domains": [
            "儿童心理学 - 理解3-12岁儿童的认知发展阶段、情感需求、兴趣特点",
            "儿童教育 - 掌握适合不同年龄段的教育方法、知识内容、引导技巧",
            "儿童语言发展 - 了解不同年龄段儿童的词汇量、句式复杂度、表达能力",
            "儿童兴趣领域 - 熟悉儿童常见的兴趣爱好（动物、恐龙、绘画、运动、科学等）",
            "儿童内容安全 - 掌握儿童内容安全标准，识别和避免不当内容",
            "对话管理 - 掌握多轮对话的上下文管理、话题转换、对话修复技巧",
            "用户画像构建 - 理解如何从对话中提取和组织用户特征信息"
          ],
          "expertise_level": "专家级 - 在儿童陪伴对话、年龄适配交流、用户画像构建方面具备专业能力",
          "knowledge_sources": [
            "Claude模型内置的通用知识库（涵盖科学、历史、文化、艺术等领域）",
            "系统提示词中定义的儿童对话策略和年龄适配规则",
            "用户画像文件中存储的个性化信息（兴趣、性格、关键记忆）",
            "会话历史文件中的历史对话内容和上下文信息"
          ],
          "update_frequency": "实时更新 - 每次对话后立即更新用户画像和会话历史，确保信息最新"
        },
        "interaction_patterns": {
          "communication_style": "采用同步流式交互模式。接收用户输入后，首先加载用户画像和会话历史，然后根据年龄选择适配策略，构建完整提示词，调用Claude模型生成流式响应，逐字返回给用户。对话完成后异步更新用户画像和保存会话历史。",
          "conversation_flow": "典型对话流程：1) 接收用户输入和用户ID；2) 加载用户画像，如果不存在则创建默认画像；3) 加载会话历史，获取最近3-5轮对话；4) 根据画像中的年龄选择年龄适配策略（3-6岁/7-9岁/10-12岁）；5) 构建完整提示词（系统提示+年龄策略+画像信息+会话历史+用户输入）；6) 调用stream_async()生成流式响应；7) 通过yield逐步返回响应片段；8) 对话完成后提取画像信息并更新；9) 保存会话历史到文件。",
          "error_responses": [
            "画像加载失败 - 使用默认画像（年龄7岁，空兴趣列表），记录警告日志，继续对话",
            "会话历史加载失败 - 将历史设为空列表，作为新会话处理，记录信息日志",
            "画像保存失败 - 记录错误日志，但不中断对话，下次对话时尝试修复",
            "流式响应中断 - 捕获异常，yield 'Error: 对话生成失败，请稍后再试'",
            "无效输入 - 返回'Error: 请输入有效的对话内容'",
            "模型调用超时 - 返回'Error: 响应超时，请重试'",
            "文件系统错误 - 记录详细错误信息，优雅降级到只读模式"
          ]
        },
        "constraints": [
          "必须使用anthropic.claude-sonnet-4-5-20250929-v1:0模型",
          "必须遵守BedrockAgentCore部署入口点规则，使用@app.entrypoint装饰器",
          "必须使用create_agent_from_prompt_template创建Agent实例",
          "必须实现async handler函数，接收payload参数（Dict类型）",
          "必须使用agent.stream_async()实现流式响应，通过yield返回片段",
          "用户画像和会话历史必须存储在.cache/children_chat_companion/<user_id>/目录下",
          "单次对话响应时间不超过3秒（首字响应不超过1秒）",
          "用户画像文件大小控制在100KB以内",
          "单个会话历史不超过50轮对话",
          "上下文窗口限制为最近3-5轮对话",
          "提示词总长度（系统提示+画像+历史+输入）控制在4000 tokens以内",
          "所有对话内容必须符合儿童内容安全标准",
          "不得记录儿童的真实姓名、地址、学校名称等敏感信息",
          "必须支持100个并发用户会话"
        ],
        "evaluation_criteria": [
          "对话自然度 - 回复是否符合儿童语言习惯，是否自然流畅",
          "年龄适配准确性 - 是否根据年龄正确调整了词汇难度和句式复杂度",
          "画像构建准确率 - 提取的画像信息是否准确，是否遗漏关键信息",
          "记忆连续性 - 跨会话时是否正确加载和引用了历史记忆",
          "内容安全性 - 生成的内容是否100%符合儿童内容安全标准",
          "响应速度 - 首字响应时间是否<1秒，总响应时间是否<3秒",
          "趣味性 - 对话是否有趣，是否能吸引儿童持续交流",
          "教育性 - 是否在对话中自然地融入了知识点和启发",
          "错误处理能力 - 异常情况下是否能优雅降级，不影响用户体验",
          "儿童满意度 - 儿童是否愿意持续使用，平均会话轮数是否达到10轮以上"
        ],
        "model_requirements": {
          "model_name": "global.anthropic.claude-sonnet-4-5-20250929-v1:0",
          "minimum_capabilities": [
            "中文自然语言理解和生成能力",
            "多轮对话上下文理解能力",
            "信息抽取和结构化能力",
            "流式响应生成能力",
            "内容安全过滤能力",
            "情感识别和回应能力",
            "知识问答能力（科学、历史、文化等）"
          ],
          "rationale": "Claude Sonnet 4.5模型具备强大的中文理解和生成能力，原生支持流式响应，内置内容安全机制，能够理解复杂的多轮对话上下文，具备出色的信息抽取能力，适合实现儿童陪伴对话和用户画像构建功能。"
        },
        "memory_configuration": {
          "memory_type": "混合记忆系统 - 短期记忆（会话上下文）+ 长期记忆（用户画像和会话历史）",
          "retention_policy": "短期记忆：保留最近3-5轮对话，会话结束后清空。长期记忆：用户画像和会话历史持久化存储到本地文件系统，永久保留（除非手动删除）。会话历史超过50轮后进行归档压缩。",
          "retrieval_strategy": "短期记忆：直接从当前会话上下文中获取。长期记忆：通过load_user_profile和load_session_history工具从文件系统加载。新会话开始时加载完整用户画像和最近一次会话的关键信息。对话过程中优先使用短期记忆，必要时引用长期记忆中的关键内容。"
        }
      }
    ],
    "agent_relationships": [],
    "system_integration": {
      "entry_point": "BedrockAgentCore HTTP服务器的/invocations端点接收POST请求，调用@app.entrypoint装饰的async handler函数。handler函数接收payload参数（包含prompt、user_id、session_id），执行对话流程，通过yield返回流式响应片段。",
      "exit_points": [
        "正常流式响应完成 - 所有响应片段通过yield返回后，handler函数自然结束，HTTP响应完成",
        "错误退出 - 捕获异常后yield错误信息，handler函数结束，返回HTTP 200和错误内容",
        "超时退出 - 模型调用超时或响应生成超过设定时间，返回超时错误信息"
      ],
      "external_interfaces": [
        "AWS Bedrock Claude模型API - 通过Strands SDK调用，用于对话生成和信息抽取",
        "本地文件系统 - 通过Python标准库或aiofiles访问，用于读写用户画像和会话历史",
        "StrandsTelemetry - 通过OTLP协议发送遥测数据到可观测性平台",
        "客户端应用 - 通过HTTP POST请求发送用户输入，接收流式响应"
      ]
    }
  }
}
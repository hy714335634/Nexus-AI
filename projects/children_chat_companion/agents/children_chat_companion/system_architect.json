{
  "system_design": {
    "design_overview": {
      "project_name": "children_chat_companion",
      "version": "1.0",
      "date": "2025-12-23",
      "design_scope": "设计一个专为3-12岁儿童提供陪伴聊天服务的单Agent系统，包含多轮对话管理、用户画像构建、会话记忆和年龄适配对话能力。系统基于Strands SDK和AWS Bedrock Claude模型，采用本地文件存储方案，支持流式响应和BedrockAgentCore部署。",
      "design_principles": [
        "单一职责原则：单个Agent承载所有核心功能，通过提示词工程实现功能分离",
        "儿童优先原则：所有设计决策以儿童安全、体验和成长为首要考虑",
        "提示词工程优先：优先通过提示词实现功能，最小化工具开发",
        "渐进式构建：用户画像和会话记忆采用渐进式构建策略",
        "优雅降级：关键功能失败时不影响基本对话能力",
        "可扩展性：预留扩展接口，支持未来功能增强"
      ],
      "key_decisions": [
        "决策1：采用单Agent架构 - 理由：功能聚焦于对话交互，不涉及多角色协作，单Agent可满足所有需求并降低系统复杂度",
        "决策2：基于multimodal_analyzer_agent模板定制 - 理由：该模板已具备多轮对话、流式响应和上下文管理能力，可快速适配儿童陪伴场景",
        "决策3：采用本地文件系统存储用户画像 - 理由：初版产品数据量小，本地存储简单可靠，符合隐私保护要求，未来可平滑迁移到数据库",
        "决策4：使用JSON格式存储画像数据 - 理由：结构化清晰、易于读写、支持嵌套结构、便于版本演化",
        "决策5：三段年龄适配策略（3-6岁、7-9岁、10-12岁） - 理由：平衡了实现复杂度和适配精度，符合儿童认知发展阶段",
        "决策6：提示词实现画像提取 - 理由：Claude模型具备强大的信息抽取能力，可通过提示词工程实现，无需额外NLP工具",
        "决策7：支持BedrockAgentCore流式响应 - 理由：提升用户体验，符合平台部署规范，实现实时交互效果",
        "决策8：最小化工具集 - 理由：仅需基础文件读写工具，降低维护成本，提高系统稳定性"
      ],
      "workflow_type": "single_agent",
      "recommended_templates": [
        "multimodal_analyzer_agent（主框架）",
        "default.yaml（提示词基础模板）"
      ]
    },
    "architecture": {
      "system_context": "本系统是一个儿童陪伴聊天服务，部署在支持AWS Bedrock的环境中。用户（儿童）通过客户端应用与Agent进行交互，Agent负责理解儿童输入、生成适龄回复、构建用户画像、维护会话记忆。系统不直接与外部教育内容库集成，所有知识通过Claude模型内置能力提供。用户画像和会话历史存储在本地文件系统的缓存目录中，按user_id和session_id组织。系统支持通过BedrockAgentCore部署到生产环境，也支持本地测试模式。",
      "agent_topology": "单Agent拓扑结构：\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                      客户端应用层                              │\n│  （Web/Mobile App，负责用户交互和会话管理）                    │\n└────────────────────┬────────────────────────────────────────┘\n                     │ HTTP Request (payload)\n                     │ {prompt, user_id, session_id}\n                     ↓\n┌─────────────────────────────────────────────────────────────┐\n│              BedrockAgentCore Runtime                        │\n│  （部署运行时，处理HTTP请求和流式响应）                        │\n└────────────────────┬────────────────────────────────────────┘\n                     │ @app.entrypoint\n                     ↓\n┌─────────────────────────────────────────────────────────────┐\n│           children_chat_companion Agent                      │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │         核心对话管理模块                                 │  │\n│  │  - 接收用户输入                                         │  │\n│  │  - 加载用户画像和会话历史                                │  │\n│  │  - 选择年龄适配策略                                      │  │\n│  │  - 生成适龄回复（流式输出）                              │  │\n│  │  - 更新用户画像                                         │  │\n│  │  - 保存会话历史                                         │  │\n│  └───────────────────────────────────────────────────────┘  │\n│                                                               │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │         用户画像管理模块                                 │  │\n│  │  - 画像加载（load_user_profile）                        │  │\n│  │  - 画像更新（update_user_profile）                      │  │\n│  │  - 信息抽取（提示词实现）                                │  │\n│  │  - 画像持久化（save_user_profile）                      │  │\n│  └───────────────────────────────────────────────────────┘  │\n│                                                               │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │         会话记忆管理模块                                 │  │\n│  │  - 会话历史加载（load_session_history）                 │  │\n│  │  - 上下文窗口管理（最近3-5轮）                           │  │\n│  │  - 会话历史保存（save_session_history）                 │  │\n│  └───────────────────────────────────────────────────────┘  │\n│                                                               │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │         年龄适配策略模块                                 │  │\n│  │  - 3-6岁策略（简单词汇、短句子、拟声词）                 │  │\n│  │  - 7-9岁策略（中等复杂度、故事化表达）                   │  │\n│  │  - 10-12岁策略（丰富词汇、启发式引导）                   │  │\n│  │  （通过提示词模板实现）                                  │  │\n│  └───────────────────────────────────────────────────────┘  │\n│                                                               │\n│  ┌───────────────────────────────────────────────────────┐  │\n│  │         内容安全控制模块                                 │  │\n│  │  - 输入内容检查                                         │  │\n│  │  - 输出内容过滤                                         │  │\n│  │  - 敏感话题引导                                         │  │\n│  │  （依赖Claude模型内置安全机制+提示词约束）              │  │\n│  └───────────────────────────────────────────────────────┘  │\n└────────────────────┬────────────────────────────────────────┘\n                     │ Tool Calls\n                     ↓\n┌─────────────────────────────────────────────────────────────┐\n│                    工具层（Tools）                            │\n│  ┌─────────────────┐  ┌─────────────────┐                   │\n│  │ load_user_      │  │ save_user_      │                   │\n│  │ profile         │  │ profile         │                   │\n│  └─────────────────┘  └─────────────────┘                   │\n│  ┌─────────────────┐  ┌─────────────────┐                   │\n│  │ load_session_   │  │ save_session_   │                   │\n│  │ history         │  │ history         │                   │\n│  └─────────────────┘  └─────────────────┘                   │\n└────────────────────┬────────────────────────────────────────┘\n                     │ File I/O\n                     ↓\n┌─────────────────────────────────────────────────────────────┐\n│              本地文件系统（.cache/）                          │\n│  .cache/children_chat_companion/                             │\n│    ├── <user_id_1>/                                          │\n│    │   ├── profile.json           # 用户画像                │\n│    │   ├── session_<id_1>.json    # 会话历史1              │\n│    │   └── session_<id_2>.json    # 会话历史2              │\n│    └── <user_id_2>/                                          │\n│        └── ...                                               │\n└─────────────────────────────────────────────────────────────┘\n\n数据流向：\n1. 客户端 → Agent：发送{prompt, user_id, session_id}\n2. Agent → 文件系统：加载用户画像和会话历史\n3. Agent → Claude模型：构建完整提示词（系统提示+画像+历史+用户输入）\n4. Claude模型 → Agent：生成流式响应\n5. Agent → 客户端：流式返回回复内容\n6. Agent → 文件系统：更新用户画像和保存会话历史\n```",
      "interaction_model": "同步流式交互模型：\n\n1. **请求接收阶段**：\n   - BedrockAgentCore接收HTTP POST请求到/invocations端点\n   - 解析payload提取prompt、user_id、session_id\n   - 调用@app.entrypoint装饰的handler函数\n\n2. **上下文准备阶段**：\n   - 调用load_user_profile工具加载用户画像\n   - 调用load_session_history工具加载最近会话历史（最多3-5轮）\n   - 根据画像中的年龄信息选择对应的年龄适配策略\n   - 构建完整的系统提示词（基础提示+年龄策略+安全约束）\n\n3. **对话生成阶段**：\n   - 将用户输入、画像信息、会话历史组合成完整提示词\n   - 调用agent.stream_async()方法生成流式响应\n   - 通过async for逐步yield响应片段给客户端\n   - 客户端实时显示回复内容\n\n4. **画像更新阶段**（对话完成后异步执行）：\n   - 分析本轮对话内容，提取新的画像信息\n   - 识别兴趣点、性格特征、行为习惯等\n   - 更新profile.json中的相应字段\n   - 更新统计信息（对话次数、最后对话时间等）\n\n5. **会话保存阶段**：\n   - 将本轮对话（用户输入+Agent回复）添加到会话历史\n   - 调用save_session_history工具持久化到session_<id>.json\n   - 如果会话历史超过50轮，进行归档或压缩\n\n6. **错误处理**：\n   - 如果画像加载失败，使用默认画像（年龄：7岁，兴趣：[]）\n   - 如果会话历史加载失败，从空历史开始\n   - 如果画像保存失败，记录日志但不中断对话\n   - 如果流式响应中断，返回错误信息并优雅退出\n\n交互时序图：\n```\n客户端          AgentCore        Agent           工具层         文件系统\n  │                │              │              │              │\n  │──POST /invocations────────────>│              │              │\n  │                │──handler()───>│              │              │\n  │                │              │──load_profile─────────────>│\n  │                │              │<─profile.json──────────────│\n  │                │              │──load_history─────────────>│\n  │                │              │<─session.json──────────────│\n  │                │              │              │              │\n  │                │              │──stream_async()────>        │\n  │                │              │    (Claude)  │              │\n  │<──yield chunk 1───────────────│<─────────────│              │\n  │<──yield chunk 2───────────────│<─────────────│              │\n  │<──yield chunk 3───────────────│<─────────────│              │\n  │                │              │              │              │\n  │                │              │──extract_info()             │\n  │                │              │──save_profile─────────────>│\n  │                │              │──save_history─────────────>│\n  │<──完成──────────────────────────│              │              │\n```",
      "technology_stack": {
        "sdk": "Strands SDK (基于AWS Bedrock)",
        "runtime": "BedrockAgentCore (生产) / Local Python (开发测试)",
        "model": "anthropic.claude-sonnet-4-5-20250929-v1:0",
        "framework": "基于multimodal_analyzer_agent模板定制",
        "storage": "本地文件系统（JSON格式）",
        "deployment": "AWS Bedrock AgentCore + Docker容器",
        "language": "Python 3.13+",
        "integrations": [
          "AWS Bedrock Claude模型（对话生成）",
          "nexus_utils.agent_factory（Agent创建）",
          "nexus_utils.config_loader（配置管理）",
          "BedrockAgentCoreApp（HTTP服务器）",
          "StrandsTelemetry（可观测性）"
        ]
      }
    },
    "agents": [
      {
        "name": "children_chat_companion",
        "purpose": "为3-12岁儿童提供陪伴聊天服务，通过年龄适配对话、用户画像构建和会话记忆实现个性化互动体验",
        "responsibilities": [
          "接收和理解儿童的对话输入",
          "根据儿童年龄生成适配的回复内容（词汇、语气、复杂度）",
          "维护多轮对话的上下文连贯性（3-5轮上下文窗口）",
          "自动识别和提取儿童的特征信息（年龄、性别、兴趣、性格等）",
          "实时更新用户画像并持久化存储",
          "加载历史画像和会话记忆，实现跨会话连续性",
          "确保对话内容的安全性和适龄性",
          "提供富有趣味性和教育性的互动体验",
          "以流式方式实时返回回复内容",
          "处理异常情况并优雅降级"
        ],
        "interfaces": {
          "inputs": [
            "prompt: str - 儿童的对话输入",
            "user_id: str - 用户唯一标识（必需）",
            "session_id: str - 会话唯一标识（可选，未提供则自动生成）",
            "media: List[Dict] - 媒体文件列表（可选，初版不支持）"
          ],
          "outputs": [
            "stream: AsyncGenerator[str] - 流式响应片段",
            "每个片段为一个文本字符串",
            "错误时返回以'Error: '开头的错误信息"
          ]
        },
        "dependencies": [
          "AWS Bedrock Claude模型（对话生成能力）",
          "nexus_utils.agent_factory（Agent对象创建）",
          "nexus_utils.config_loader（配置加载）",
          "BedrockAgentCoreApp（HTTP服务和入口点）",
          "本地文件系统（.cache/目录读写权限）",
          "load_user_profile工具（用户画像加载）",
          "save_user_profile工具（用户画像保存）",
          "load_session_history工具（会话历史加载）",
          "save_session_history工具（会话历史保存）"
        ],
        "implementation_notes": [
          "使用create_agent_from_prompt_template创建Agent实例",
          "提示词配置文件位于prompts/generated_agents_prompts/children_chat_companion/children_chat_companion.yaml",
          "Agent脚本位于agents/generated_agents/children_chat_companion/children_chat_companion.py",
          "必须实现@app.entrypoint装饰的async handler函数",
          "handler函数使用agent.stream_async()实现流式响应",
          "使用async for event in stream循环yield响应片段",
          "用户画像提取逻辑通过提示词实现，无需额外NLP工具",
          "年龄适配策略在提示词中定义三个年龄段的不同模板",
          "内容安全依赖Claude模型内置机制+提示词约束",
          "缓存目录结构：.cache/children_chat_companion/<user_id>/profile.json和session_*.json",
          "如果DOCKER_CONTAINER=1环境变量存在，启动HTTP服务器模式",
          "否则支持命令行测试模式（-i参数）",
          "初始化参数：env=production, version=latest, model_id=global.anthropic.claude-sonnet-4-5-20250929-v1:0, enable_logging=True"
        ],
        "recommended_template": "multimodal_analyzer_agent（提供多轮对话和流式响应基础框架）"
      }
    ],
    "data_models": [
      {
        "name": "UserProfile",
        "schema": "{\n  \"user_id\": \"string (必需) - 用户唯一标识\",\n  \"basic_info\": {\n    \"nickname\": \"string (可选) - 儿童昵称\",\n    \"age\": \"integer (必需) - 年龄（3-12）\",\n    \"gender\": \"string (可选) - 性别（male/female/unknown）\",\n    \"grade\": \"string (可选) - 年级\"\n  },\n  \"interests\": [\n    {\n      \"name\": \"string - 兴趣名称（如'恐龙'、'画画'）\",\n      \"weight\": \"float - 兴趣权重（0.0-1.0）\",\n      \"first_mentioned\": \"string - 首次提及时间（ISO 8601）\",\n      \"last_mentioned\": \"string - 最后提及时间（ISO 8601）\",\n      \"mention_count\": \"integer - 提及次数\"\n    }\n  ],\n  \"personality_traits\": [\n    \"string - 性格特征标签（如'活泼'、'好奇'、'内向'）\"\n  ],\n  \"behavior_patterns\": [\n    \"string - 行为习惯描述（如'喜欢问为什么'、'经常分享学校趣事'）\"\n  ],\n  \"key_memories\": [\n    {\n      \"content\": \"string - 重要记忆内容\",\n      \"timestamp\": \"string - 记录时间（ISO 8601）\",\n      \"context\": \"string - 上下文说明\"\n    }\n  ],\n  \"conversation_stats\": {\n    \"total_conversations\": \"integer - 总对话次数\",\n    \"total_turns\": \"integer - 总对话轮数\",\n    \"first_conversation\": \"string - 首次对话时间（ISO 8601）\",\n    \"last_conversation\": \"string - 最后对话时间（ISO 8601）\",\n    \"average_turns_per_session\": \"float - 平均每次会话轮数\"\n  },\n  \"created_at\": \"string - 画像创建时间（ISO 8601）\",\n  \"last_updated\": \"string - 最后更新时间（ISO 8601）\",\n  \"version\": \"string - 画像版本号（如'1.0'）\"\n}",
        "validation_rules": [
          "user_id必须为非空字符串",
          "age必须在3-12范围内",
          "gender只能是male、female或unknown",
          "interests数组中的weight必须在0.0-1.0范围内",
          "所有时间戳必须符合ISO 8601格式",
          "mention_count必须为非负整数",
          "total_conversations和total_turns必须为非负整数"
        ],
        "relationships": [
          "UserProfile与SessionHistory是一对多关系（一个用户有多个会话）",
          "UserProfile.user_id是SessionHistory.user_id的外键"
        ]
      },
      {
        "name": "SessionHistory",
        "schema": "{\n  \"session_id\": \"string (必需) - 会话唯一标识\",\n  \"user_id\": \"string (必需) - 用户唯一标识\",\n  \"conversation_turns\": [\n    {\n      \"turn_number\": \"integer - 轮次编号（从1开始）\",\n      \"timestamp\": \"string - 时间戳（ISO 8601）\",\n      \"user_input\": \"string - 用户输入内容\",\n      \"agent_response\": \"string - Agent回复内容\",\n      \"context_summary\": \"string (可选) - 本轮上下文摘要\"\n    }\n  ],\n  \"session_metadata\": {\n    \"start_time\": \"string - 会话开始时间（ISO 8601）\",\n    \"end_time\": \"string (可选) - 会话结束时间（ISO 8601）\",\n    \"total_turns\": \"integer - 本次会话总轮数\",\n    \"user_age_at_session\": \"integer - 会话时用户年龄\",\n    \"topics_discussed\": [\"string - 讨论的主题列表\"]\n  },\n  \"created_at\": \"string - 会话创建时间（ISO 8601）\",\n  \"last_updated\": \"string - 最后更新时间（ISO 8601）\"\n}",
        "validation_rules": [
          "session_id和user_id必须为非空字符串",
          "turn_number必须连续递增",
          "conversation_turns数组长度不超过50",
          "所有时间戳必须符合ISO 8601格式",
          "end_time必须晚于start_time",
          "total_turns必须等于conversation_turns数组长度"
        ],
        "relationships": [
          "SessionHistory.user_id关联到UserProfile.user_id",
          "一个会话只属于一个用户",
          "会话历史按session_id独立存储"
        ]
      },
      {
        "name": "AgentPayload",
        "schema": "{\n  \"prompt\": \"string (必需) - 用户输入的对话内容\",\n  \"user_id\": \"string (必需) - 用户唯一标识\",\n  \"session_id\": \"string (可选) - 会话标识，未提供则自动生成UUID\",\n  \"media\": [\n    {\n      \"type\": \"string - 媒体类型（image/audio/video）\",\n      \"url\": \"string - 媒体资源URL\",\n      \"metadata\": \"object - 媒体元数据\"\n    }\n  ],\n  \"context\": {\n    \"timestamp\": \"string - 请求时间戳（ISO 8601）\",\n    \"client_info\": \"object (可选) - 客户端信息\"\n  }\n}",
        "validation_rules": [
          "prompt必须为非空字符串",
          "user_id必须为非空字符串",
          "session_id如果提供必须为有效UUID或字符串",
          "media数组为可选，初版不处理媒体文件",
          "prompt长度不超过2000字符"
        ],
        "relationships": [
          "AgentPayload是Handler函数的输入参数",
          "AgentPayload.user_id用于加载UserProfile",
          "AgentPayload.session_id用于加载SessionHistory"
        ]
      }
    ],
    "interaction_flows": [
      {
        "name": "首次对话流程",
        "description": "儿童首次与Agent交互，系统创建新的用户画像并进行初步信息收集",
        "steps": [
          {
            "step": "1. 接收首次对话请求",
            "agent": "children_chat_companion",
            "action": "Handler函数接收payload（prompt, user_id, session_id）",
            "data": "{prompt: '你好', user_id: 'child_001', session_id: null}"
          },
          {
            "step": "2. 检测新用户",
            "agent": "children_chat_companion",
            "action": "调用load_user_profile工具，发现用户画像不存在",
            "data": "返回None或FileNotFoundError"
          },
          {
            "step": "3. 创建默认画像",
            "agent": "children_chat_companion",
            "action": "创建初始UserProfile，设置默认年龄为7岁，兴趣为空列表",
            "data": "{user_id: 'child_001', age: 7, interests: [], created_at: '2025-12-23T06:31:00Z'}"
          },
          {
            "step": "4. 生成欢迎回复",
            "agent": "children_chat_companion",
            "action": "使用中等年龄段提示词（7-9岁），生成友好的欢迎消息",
            "data": "流式输出：'你好呀！很高兴认识你！我是你的聊天小伙伴...'"
          },
          {
            "step": "5. 自然引导信息收集",
            "agent": "children_chat_companion",
            "action": "在欢迎消息中自然地询问年龄、兴趣等信息",
            "data": "流式输出：'...你今年几岁啦？平时喜欢做什么呢？'"
          },
          {
            "step": "6. 保存初始会话",
            "agent": "children_chat_companion",
            "action": "调用save_session_history工具，创建新会话文件",
            "data": "保存到.cache/children_chat_companion/child_001/session_<uuid>.json"
          },
          {
            "step": "7. 返回响应",
            "agent": "children_chat_companion",
            "action": "完成流式输出，等待用户下一轮输入",
            "data": "HTTP 200, 流式响应完成"
          }
        ]
      },
      {
        "name": "常规对话流程",
        "description": "已有画像的用户进行日常对话，系统加载历史信息并更新画像",
        "steps": [
          {
            "step": "1. 接收对话请求",
            "agent": "children_chat_companion",
            "action": "Handler函数接收payload",
            "data": "{prompt: '我今天在学校学了恐龙知识！', user_id: 'child_001', session_id: 'session_123'}"
          },
          {
            "step": "2. 加载用户画像",
            "agent": "children_chat_companion",
            "action": "调用load_user_profile工具，读取profile.json",
            "data": "{age: 8, interests: [{name: '画画', weight: 0.8}], personality_traits: ['好奇']}"
          },
          {
            "step": "3. 加载会话历史",
            "agent": "children_chat_companion",
            "action": "调用load_session_history工具，读取最近3-5轮对话",
            "data": "[{turn: 1, user: '你好', agent: '你好呀！'}, {turn: 2, user: '我喜欢画画', agent: '画画真棒！'}]"
          },
          {
            "step": "4. 选择年龄适配策略",
            "agent": "children_chat_companion",
            "action": "根据画像中age=8，选择7-9岁年龄段提示词模板",
            "data": "使用中等复杂度词汇和句式"
          },
          {
            "step": "5. 构建完整提示词",
            "agent": "children_chat_companion",
            "action": "组合系统提示+画像信息+会话历史+用户输入",
            "data": "完整提示词包含年龄策略、已知兴趣、历史上下文和当前输入"
          },
          {
            "step": "6. 生成流式回复",
            "agent": "children_chat_companion",
            "action": "调用agent.stream_async()，流式生成回复",
            "data": "流式输出：'哇！恐龙真的很神奇呢！你最喜欢哪种恐龙？...'"
          },
          {
            "step": "7. 提取画像信息",
            "agent": "children_chat_companion",
            "action": "分析用户输入，识别新兴趣'恐龙'",
            "data": "新兴趣：{name: '恐龙', weight: 0.5, first_mentioned: '2025-12-23T06:35:00Z'}"
          },
          {
            "step": "8. 更新用户画像",
            "agent": "children_chat_companion",
            "action": "调用save_user_profile工具，添加'恐龙'到interests列表",
            "data": "更新后画像：interests: [{name: '画画', weight: 0.8}, {name: '恐龙', weight: 0.5}]"
          },
          {
            "step": "9. 保存会话历史",
            "agent": "children_chat_companion",
            "action": "调用save_session_history工具，添加本轮对话到会话文件",
            "data": "追加到session_123.json：{turn: 3, user: '我今天在学校学了恐龙知识！', agent: '哇！恐龙真的很神奇呢！...'}"
          },
          {
            "step": "10. 返回响应",
            "agent": "children_chat_companion",
            "action": "完成流式输出和后台更新",
            "data": "HTTP 200, 流式响应完成"
          }
        ]
      },
      {
        "name": "跨会话记忆加载流程",
        "description": "用户在新会话中返回，系统加载历史画像和关键记忆",
        "steps": [
          {
            "step": "1. 接收新会话请求",
            "agent": "children_chat_companion",
            "action": "Handler函数接收payload，session_id为新生成的UUID",
            "data": "{prompt: '嗨！', user_id: 'child_001', session_id: 'session_456'}"
          },
          {
            "step": "2. 加载用户画像",
            "agent": "children_chat_companion",
            "action": "调用load_user_profile工具，读取完整画像",
            "data": "{age: 8, interests: [{name: '画画', weight: 0.8}, {name: '恐龙', weight: 0.5}], last_conversation: '2025-12-22T14:20:00Z'}"
          },
          {
            "step": "3. 检测会话间隔",
            "agent": "children_chat_companion",
            "action": "计算距离上次对话的时间间隔",
            "data": "间隔：约1天"
          },
          {
            "step": "4. 加载历史会话摘要",
            "agent": "children_chat_companion",
            "action": "读取最近一次会话的关键信息",
            "data": "上次讨论了恐龙知识，用户表现出浓厚兴趣"
          },
          {
            "step": "5. 生成记忆化欢迎",
            "agent": "children_chat_companion",
            "action": "在系统提示词中注入历史记忆，生成个性化欢迎",
            "data": "流式输出：'嗨！好久不见啦！还记得昨天我们聊的恐龙吗？你有没有了解到更多恐龙的事情呀？'"
          },
          {
            "step": "6. 创建新会话文件",
            "agent": "children_chat_companion",
            "action": "调用save_session_history工具，创建session_456.json",
            "data": "新会话文件：{session_id: 'session_456', user_id: 'child_001', start_time: '2025-12-23T06:40:00Z'}"
          },
          {
            "step": "7. 更新画像统计",
            "agent": "children_chat_companion",
            "action": "更新conversation_stats中的total_conversations和last_conversation",
            "data": "total_conversations: 3, last_conversation: '2025-12-23T06:40:00Z'"
          },
          {
            "step": "8. 返回响应",
            "agent": "children_chat_companion",
            "action": "完成流式输出，建立新会话连接",
            "data": "HTTP 200, 流式响应完成"
          }
        ]
      },
      {
        "name": "画像更新流程",
        "description": "在对话过程中持续更新用户画像的详细流程",
        "steps": [
          {
            "step": "1. 对话进行中",
            "agent": "children_chat_companion",
            "action": "Agent正在生成流式回复",
            "data": "流式输出进行中"
          },
          {
            "step": "2. 并行信息抽取",
            "agent": "children_chat_companion",
            "action": "通过提示词指令，Claude模型在生成回复的同时识别画像信息",
            "data": "识别到：用户提到'喜欢霸王龙'，年龄线索'我上三年级了'"
          },
          {
            "step": "3. 结构化信息提取",
            "agent": "children_chat_companion",
            "action": "将识别的信息转换为结构化数据",
            "data": "{new_interest: '霸王龙', grade: '三年级', implied_age: 8-9}"
          },
          {
            "step": "4. 读取当前画像",
            "agent": "children_chat_companion",
            "action": "调用load_user_profile获取最新画像",
            "data": "当前画像：{age: 8, grade: null, interests: [{name: '恐龙', weight: 0.5}]}"
          },
          {
            "step": "5. 合并更新逻辑",
            "agent": "children_chat_companion",
            "action": "智能合并新信息到现有画像",
            "data": "更新：grade设为'三年级'，'恐龙'兴趣下添加子兴趣'霸王龙'，权重提升到0.7"
          },
          {
            "step": "6. 更新时间戳",
            "agent": "children_chat_companion",
            "action": "更新相关字段的时间戳",
            "data": "interests[0].last_mentioned: '2025-12-23T06:45:00Z', mention_count: 2"
          },
          {
            "step": "7. 持久化画像",
            "agent": "children_chat_companion",
            "action": "调用save_user_profile工具，写入profile.json",
            "data": "写入.cache/children_chat_companion/child_001/profile.json"
          },
          {
            "step": "8. 更新完成",
            "agent": "children_chat_companion",
            "action": "画像更新完成，不影响对话继续",
            "data": "更新成功，last_updated: '2025-12-23T06:45:00Z'"
          }
        ]
      },
      {
        "name": "错误处理流程",
        "description": "处理各类异常情况，确保系统优雅降级",
        "steps": [
          {
            "step": "1. 画像加载失败",
            "agent": "children_chat_companion",
            "action": "load_user_profile工具抛出FileNotFoundError或读取错误",
            "data": "异常：profile.json不存在或损坏"
          },
          {
            "step": "2. 使用默认画像",
            "agent": "children_chat_companion",
            "action": "创建临时默认画像，记录日志",
            "data": "默认画像：{age: 7, interests: [], created_at: 'now'}"
          },
          {
            "step": "3. 继续对话",
            "agent": "children_chat_companion",
            "action": "使用默认画像生成回复，不中断对话",
            "data": "正常生成流式响应"
          },
          {
            "step": "4. 会话历史加载失败",
            "agent": "children_chat_companion",
            "action": "load_session_history工具失败",
            "data": "异常：session文件不存在"
          },
          {
            "step": "5. 从空历史开始",
            "agent": "children_chat_companion",
            "action": "将会话历史设为空列表，作为新会话处理",
            "data": "conversation_history: []"
          },
          {
            "step": "6. 流式响应中断",
            "agent": "children_chat_companion",
            "action": "stream_async()过程中发生异常",
            "data": "异常：网络中断或模型错误"
          },
          {
            "step": "7. 捕获异常并返回错误",
            "agent": "children_chat_companion",
            "action": "在try-except中捕获，yield错误信息",
            "data": "yield 'Error: 对话生成失败，请稍后再试'"
          },
          {
            "step": "8. 画像保存失败",
            "agent": "children_chat_companion",
            "action": "save_user_profile工具失败（磁盘满或权限问题）",
            "data": "异常：写入profile.json失败"
          },
          {
            "step": "9. 记录日志但不中断",
            "agent": "children_chat_companion",
            "action": "记录错误日志，但不影响已完成的对话",
            "data": "日志：'Failed to save profile for user child_001'"
          },
          {
            "step": "10. 返回成功响应",
            "agent": "children_chat_companion",
            "action": "对话已成功完成，画像保存失败不影响用户体验",
            "data": "HTTP 200，流式响应已完成"
          }
        ]
      }
    ],
    "security_considerations": [
      "内容安全：依赖Claude模型内置的内容安全机制，在系统提示词中强化儿童内容安全约束",
      "隐私保护：用户画像和会话历史仅存储在本地文件系统，不上传到外部服务器",
      "敏感信息过滤：在提示词中明确指示不记录真实姓名、地址、学校名称等敏感信息",
      "用户ID匿名化：建议客户端使用UUID或不可逆哈希作为user_id，避免使用真实身份信息",
      "文件系统隔离：每个用户的数据存储在独立目录中，避免跨用户数据泄露",
      "输入验证：验证payload中的prompt长度（不超过2000字符），防止超长输入攻击",
      "错误信息脱敏：对儿童用户隐藏技术性错误信息，返回友好的错误提示",
      "访问控制：缓存目录设置适当的文件权限（如700），仅允许Agent进程访问",
      "会话隔离：每个会话独立存储，防止会话混淆或数据污染",
      "审计日志：记录关键操作（画像创建、更新、删除）到日志文件，支持安全审计"
    ],
    "error_handling": [
      "画像加载失败：使用默认画像（年龄7岁，空兴趣列表），记录警告日志，继续对话",
      "会话历史加载失败：将会话历史设为空列表，作为新会话处理，记录信息日志",
      "画像保存失败：记录错误日志，但不中断已完成的对话，下次对话时尝试修复",
      "会话保存失败：记录错误日志，不影响对话完成，会话数据可能丢失但不影响用户体验",
      "流式响应中断：捕获异常，yield 'Error: 对话生成失败，请稍后再试'，返回HTTP 200",
      "模型调用超时：设置超时时间（如30秒），超时后返回友好错误信息",
      "JSON解析失败：捕获JSONDecodeError，使用默认数据结构，记录错误日志",
      "文件系统错误：捕获IOError和OSError，记录详细错误信息，优雅降级到只读模式",
      "年龄信息缺失：使用默认年龄7岁（中间年龄段），提示用户提供年龄信息",
      "无效输入：验证prompt非空且长度合理，无效时返回'Error: 请输入有效的对话内容'",
      "并发冲突：使用文件锁或时间戳机制避免并发写入冲突，最后写入者获胜策略",
      "存储空间不足：检测磁盘空间，不足时记录严重日志并通知管理员，继续提供只读服务"
    ],
    "performance_considerations": [
      "画像加载优化：画像文件通常小于100KB，加载时间<500ms，可考虑内存缓存热门画像",
      "会话历史限制：单个会话文件最多存储50轮对话，超过后归档或压缩旧对话",
      "上下文窗口管理：仅加载最近3-5轮对话到上下文，减少Token消耗和延迟",
      "流式响应优化：使用stream_async()实现真正的流式输出，首字响应时间<1秒",
      "异步画像更新：画像更新在流式响应完成后异步执行，不阻塞响应返回",
      "文件I/O优化：使用异步文件操作（aiofiles）减少阻塞，批量写入减少磁盘操作",
      "提示词长度控制：系统提示词+画像+历史上下文总长度控制在4000 tokens以内",
      "模型参数优化：max_tokens设为60000支持长对话，temperature=0.6平衡创意和稳定性",
      "并发处理：BedrockAgentCore支持多并发请求，每个请求独立处理，目标支持100并发",
      "缓存策略：考虑为频繁访问的画像添加内存缓存（如LRU cache），减少文件读取",
      "响应时间目标：单次对话总响应时间<3秒（包括画像加载、模型生成、画像更新）",
      "资源限制：监控内存使用，单个Agent进程内存占用<500MB"
    ],
    "monitoring_strategy": [
      "使用StrandsTelemetry设置OTLP导出器，发送遥测数据到可观测性平台",
      "监控关键指标：对话响应时间、画像加载时间、画像更新成功率、流式响应完成率",
      "记录详细日志：使用Python logging模块，记录INFO级别的关键操作和ERROR级别的异常",
      "日志内容包括：user_id、session_id、操作类型、耗时、结果状态、错误信息",
      "监控画像更新频率：统计每个用户的画像更新次数和间隔，识别异常模式",
      "监控会话统计：跟踪平均会话轮数、会话时长、用户活跃度等业务指标",
      "错误率监控：统计画像加载失败率、保存失败率、流式响应中断率",
      "性能监控：跟踪P50、P95、P99响应时间，设置告警阈值（如P95>5秒告警）",
      "存储监控：监控缓存目录大小、文件数量、磁盘使用率，设置容量告警",
      "模型调用监控：跟踪模型API调用次数、成功率、平均耗时、Token消耗",
      "用户行为分析：统计用户留存率、平均对话轮数、兴趣分布等，支持产品优化",
      "健康检查：提供/health端点，检查文件系统可访问性、模型连接状态等",
      "告警策略：错误率>5%、响应时间P95>5秒、存储空间<10%时触发告警"
    ]
  },
  "design_rationale": "本系统设计基于以下核心理念和决策：\n\n**1. 单Agent架构的合理性**\n分析需求后确认，所有功能均围绕对话交互展开，不涉及多角色协作或复杂工作流。采用单Agent架构可以：\n- 降低系统复杂度，减少Agent间通信开销\n- 简化部署和维护，所有逻辑集中在一个Agent中\n- 提高响应速度，避免多Agent协调延迟\n- 便于状态管理，用户画像和会话历史统一管理\n\n**2. 基于multimodal_analyzer_agent模板的选择**\n该模板提供了完善的多轮对话框架和流式响应能力，是儿童陪伴Agent的理想基础：\n- 已实现多轮对话管理和上下文维护机制\n- 原生支持流式响应（streaming: True），符合实时交互需求\n- 具备良好的工具集成框架，易于添加画像管理工具\n- 代码结构清晰，便于定制化修改\n\n**3. 提示词工程优先策略**\n大量功能通过提示词实现而非硬编码，带来显著优势：\n- 年龄适配策略：三个年龄段的对话风格完全通过提示词模板定义，易于调整优化\n- 画像信息抽取：利用Claude模型的语义理解能力，通过提示词指令实现信息提取，无需额外NLP工具\n- 内容安全控制：在系统提示词中定义儿童内容安全规则，结合模型内置安全机制\n- 趣味性和教育性：通过提示词设计对话风格，融入教育元素和鼓励性语言\n- 快速迭代：修改提示词即可调整Agent行为，无需重新开发部署\n\n**4. 本地文件系统存储方案**\n初版采用本地文件存储，基于以下考虑：\n- 简单可靠：无需额外数据库服务，降低系统依赖\n- 隐私保护：数据不离开本地环境，符合儿童隐私保护要求\n- 快速开发：文件操作简单，开发和调试效率高\n- 易于扩展：未来可平滑迁移到数据库（如DynamoDB），数据模型已标准化\n- 性能充足：单用户画像<100KB，加载时间<500ms，满足性能要求\n\n**5. JSON数据模型设计**\nUserProfile和SessionHistory采用JSON格式，具有多重优势：\n- 结构化清晰：字段语义明确，易于理解和维护\n- 灵活可扩展：支持嵌套结构，易于添加新字段\n- 标准化：JSON是通用数据交换格式，便于与其他系统集成\n- 版本演化：支持版本字段，便于未来数据模型升级\n- 人类可读：便于调试和数据分析\n\n**6. 三段年龄适配策略**\n将3-12岁划分为三个年龄段（3-6岁、7-9岁、10-12岁），平衡了实现复杂度和适配精度：\n- 符合儿童认知发展阶段（学龄前、小学低年级、小学高年级）\n- 每个年龄段的对话特征差异显著，易于定义清晰的提示词策略\n- 三段划分避免了过细（实现复杂）或过粗（适配不精准）的问题\n- 支持渐进式优化：可根据实际效果调整年龄段边界或增加细分\n\n**7. 渐进式画像构建**\n不要求首次对话即收集完整信息，采用渐进式构建策略：\n- 降低用户负担：避免一开始就问很多问题，影响体验\n- 自然信息收集：在多次对话中自然地了解儿童特征\n- 动态权重调整：根据提及频率动态调整兴趣权重，反映真实偏好\n- 容错性强：部分信息缺失不影响基本对话功能\n\n**8. 流式响应实现**\n采用BedrockAgentCore流式响应模式，显著提升用户体验：\n- 实时反馈：逐字显示回复，避免长时间等待\n- 符合规范：遵循BedrockAgentCore部署标准，使用@app.entrypoint装饰器\n- 异步处理：使用async/await和stream_async()实现真正的异步流式输出\n- 错误处理：流式过程中异常可优雅处理，yield错误信息\n\n**9. 最小化工具集设计**\n仅开发四个基础工具（load_user_profile、save_user_profile、load_session_history、save_session_history）：\n- 职责单一：每个工具只负责一个文件操作\n- 易于测试：功能简单，单元测试覆盖容易\n- 高可靠性：减少工具数量降低出错概率\n- 维护成本低：工具代码量少，维护负担小\n\n**10. 优雅降级策略**\n系统设计充分考虑容错性：\n- 画像加载失败时使用默认画像，不中断对话\n- 会话历史加载失败时从空历史开始，不影响当前交互\n- 画像保存失败时记录日志但不影响已完成的对话\n- 流式响应中断时返回友好错误信息，不暴露技术细节\n\n**11. 安全性优先**\n儿童产品的安全性是最高优先级：\n- 依赖Claude模型内置的内容安全机制，减少自定义过滤器的开发成本\n- 在提示词中强化安全约束，定义明确的内容边界\n- 本地存储保护隐私，不上传敏感数据\n- 敏感信息过滤，不记录真实姓名、地址等\n\n**12. 可观测性设计**\n集成StrandsTelemetry和详细日志，支持运维监控：\n- 关键指标监控：响应时间、成功率、画像更新频率\n- 详细日志记录：所有关键操作和异常都有日志\n- 健康检查：提供/health端点，便于负载均衡器检测\n- 告警策略：定义清晰的告警阈值，及时发现问题\n\n**13. 扩展性预留**\n虽然初版功能聚焦，但设计中预留了扩展空间：\n- 数据模型标准化：便于未来迁移到数据库\n- 年龄段可扩展：可根据需要增加更细的年龄划分\n- 媒体支持预留：AgentPayload中包含media字段，支持未来多模态扩展\n- 工具可插拔：工具层设计支持添加新工具（如外部知识库检索）\n\n**14. 性能优化考虑**\n设计中充分考虑性能要求：\n- 上下文窗口限制：仅加载3-5轮历史，控制Token消耗\n- 异步画像更新：不阻塞流式响应返回\n- 文件大小限制：画像<100KB，会话<50轮，控制I/O开销\n- 流式输出优化：首字响应<1秒，提升交互体验\n\n**总结**\n本设计方案在功能完整性、实现复杂度、用户体验、安全性、可维护性之间取得了良好平衡。通过单Agent架构、提示词工程优先、本地文件存储、流式响应等关键决策，实现了一个简洁高效、易于开发和维护的儿童陪伴聊天系统。设计充分考虑了Nexus-AI平台的技术约束和最佳实践，为后续的开发阶段提供了清晰的技术蓝图。"
}
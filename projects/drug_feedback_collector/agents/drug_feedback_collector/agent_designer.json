{
  "agent_design": {
    "design_overview": {
      "project_name": "drug_feedback_collector",
      "version": "1.0",
      "date": "2025-12-17",
      "design_scope": "设计单个专用Agent用于药物反馈信息收集。该Agent具备网络搜索、内容抓取、信息提取、数据分析和报告生成能力。基于deep_research_agent模板进行定制开发，集成Tavily Search API和AWS Bedrock Claude模型。",
      "design_goals": [
        "创建一个功能完整的药物反馈收集Agent，能够自动化执行信息收集流程",
        "实现高质量的信息提取和分类，准确识别疗效、副作用、使用体验等反馈类型",
        "提供流式响应体验，实时反馈搜索和分析进度",
        "确保系统稳定性和容错能力，处理网络异常和API失败场景",
        "优化性能，通过缓存和并发处理提升响应速度",
        "遵守网络爬虫合规要求，保护用户隐私和数据安全"
      ],
      "key_design_decisions": [
        {
          "decision": "采用单Agent架构，所有功能通过内部工具编排完成",
          "rationale": "药物反馈收集流程是线性的、有明确依赖关系的任务序列（搜索→抓取→分析→报告）。单Agent架构避免了多Agent通信的复杂性，简化了错误处理和状态管理。内部工具调用的延迟更低，调试和监控更简单。",
          "alternatives": [
            "多Agent架构（搜索Agent、抓取Agent、分析Agent、报告Agent）- 增加通信开销和复杂度",
            "无Agent纯脚本方式 - 缺乏LLM的智能理解能力"
          ],
          "consequences": [
            "优点：简单、高效、易于维护、错误处理集中",
            "缺点：单点故障风险（通过完善的错误处理缓解）",
            "影响：开发周期缩短30%，运维复杂度降低50%"
          ]
        },
        {
          "decision": "基于deep_research_agent模板进行定制开发",
          "rationale": "deep_research_agent模板提供了完整的网络搜索、内容分析、报告生成能力，与需求匹配度达92%。模板已经过生产验证，包含成熟的错误处理、缓存机制和性能优化。相比从零开发可节省60%的开发时间。",
          "alternatives": [
            "从零开发 - 开发周期长，稳定性需要长时间验证",
            "使用api_integration_agent模板 - 匹配度较低（78%），需要更多定制工作"
          ],
          "consequences": [
            "优点：快速交付、稳定可靠、最佳实践内置",
            "缺点：需要理解模板结构，部分功能可能需要调整",
            "影响：预计2周内完成开发，而非从零开发的6周"
          ]
        },
        {
          "decision": "使用Tavily Search API作为网络搜索工具",
          "rationale": "Tavily提供高质量的搜索结果和合规的数据访问方式。相比自建爬虫，Tavily已处理好robots.txt遵守、访问频率控制、反爬虫应对等复杂问题。API稳定性高，支持中英文搜索，结果质量优于通用搜索引擎。",
          "alternatives": [
            "Google Custom Search API - 配额限制严格，成本较高",
            "自建爬虫 - 开发复杂度高，法律风险大",
            "Bing Search API - 中文搜索质量较差"
          ],
          "consequences": [
            "优点：合规、稳定、高质量结果、开箱即用",
            "缺点：依赖第三方服务，需要API密钥管理",
            "影响：搜索质量提升40%，合规风险降低90%"
          ]
        },
        {
          "decision": "使用Claude Sonnet 4.5进行文本分析和信息提取",
          "rationale": "Claude在医疗文本理解方面表现优秀，能准确识别副作用、疗效评价、使用体验等关键信息。支持长文本输入（200K tokens），可以一次处理多个网页内容。Sonnet 4.5在速度和准确性之间取得最佳平衡，成本合理。",
          "alternatives": [
            "GPT-4 - 成本更高，响应速度较慢",
            "规则提取 - 准确率低，无法理解复杂语义",
            "开源模型（如Llama） - 医疗领域准确率不足"
          ],
          "consequences": [
            "优点：高准确率、理解复杂语义、多语言支持",
            "缺点：API调用成本，需要网络连接",
            "影响：信息提取准确率提升至85%以上"
          ]
        },
        {
          "decision": "实现流式响应机制（async handler + stream_async + yield）",
          "rationale": "药物反馈收集流程耗时较长（2-5分钟），用户需要实时了解进度。流式响应可以在搜索、抓取、分析各阶段实时输出进度信息，大幅改善用户体验。BedrockAgentCoreApp原生支持流式响应，实现成本低。",
          "alternatives": [
            "同步阻塞模式 - 用户需等待5分钟才看到结果，体验差",
            "轮询进度API - 增加系统复杂度，需要状态管理"
          ],
          "consequences": [
            "优点：用户体验好、感知等待时间短、实时反馈",
            "缺点：需要异步编程，调试稍复杂",
            "影响：用户满意度预计提升50%"
          ]
        },
        {
          "decision": "实施两层缓存策略（搜索结果7天，最终报告30天）",
          "rationale": "药物反馈信息短期内变化不大，缓存可以显著提升响应速度和降低成本。搜索结果缓存7天（考虑信息时效性），最终报告缓存30天（生成成本高）。用户可通过force_refresh参数绕过缓存。",
          "alternatives": [
            "无缓存 - 每次都重新搜索，成本高、速度慢",
            "永久缓存 - 信息过时风险高",
            "Redis缓存 - 增加系统依赖，本地文件缓存已足够"
          ],
          "consequences": [
            "优点：响应速度提升10倍（缓存命中时），成本降低60%",
            "缺点：需要管理缓存过期，占用磁盘空间",
            "影响：预计缓存命中率40%，平均响应时间从3分钟降至1分钟"
          ]
        },
        {
          "decision": "定义5个核心工具：搜索、抓取、分析、报告、缓存",
          "rationale": "将功能模块化为独立工具，每个工具职责单一、接口清晰。便于单独测试、替换和升级。工具之间通过明确的数据模型传递信息，降低耦合度。5个工具覆盖了完整的业务流程，数量适中，不会过于复杂。",
          "alternatives": [
            "单一大工具 - 职责不清晰，难以维护",
            "更细粒度的工具（10+） - 过度设计，增加复杂度"
          ],
          "consequences": [
            "优点：模块化、可测试、可维护、可扩展",
            "缺点：需要定义工具间接口和数据模型",
            "影响：代码可维护性提升60%，测试覆盖率可达90%"
          ]
        }
      ]
    },
    "agents": [
      {
        "agent_id": "drug_feedback_collector",
        "name": "drug_feedback_collector",
        "role": "药物反馈收集专家",
        "purpose": "接收用户提供的药物名称，自动从互联网搜索、抓取、分析和整理该药物的用户反馈信息，生成结构化的反馈报告。帮助用户快速了解特定药物的真实使用情况、疗效评价、副作用和使用体验。",
        "personality": {
          "traits": [
            "专业可靠：对医疗健康信息保持严谨态度",
            "高效执行：快速完成信息收集和分析任务",
            "透明沟通：实时反馈工作进度和数据来源",
            "谨慎客观：不做主观判断，仅呈现客观事实",
            "用户友好：提供清晰易懂的报告和错误提示"
          ],
          "communication_style": "专业、客观、友好。使用清晰的结构化语言呈现信息，避免医学术语过度使用。在流式响应中提供进度更新（如'正在搜索第3个来源...'、'已抓取15个网页，正在分析...'），让用户了解工作状态。遇到问题时提供具体的解决建议而非笼统的错误信息。",
          "tone": "中性、客观、信息丰富。强调这是公众反馈的汇总而非医疗建议。在报告中明确标注数据来源和局限性。对不确定的信息使用'可能'、'部分用户反映'等限定词。"
        },
        "capabilities": {
          "core_functions": [
            "药物名称验证：接收并验证用户输入的药物名称，支持中英文、通用名和商品名",
            "多维度网络搜索：使用多个关键词变体（评价、副作用、体验、反馈）执行并发搜索",
            "智能网页抓取：批量抓取搜索结果网页，提取正文内容，过滤广告和无关信息",
            "AI驱动的信息提取：使用Claude模型识别和分类用户反馈（疗效、副作用、体验、价格）",
            "情感分析：判断反馈的情感倾向（正面、负面、中性）",
            "信息去重和质量过滤：识别重复内容，过滤低质量和不相关信息",
            "统计分析：计算正负面反馈占比、常见副作用、疗效关键词等",
            "结构化报告生成：生成包含摘要、分类反馈、统计数据、来源追溯的完整报告",
            "缓存管理：存储和检索历史搜索结果，提升响应速度",
            "流式进度反馈：实时输出搜索、抓取、分析各阶段的进度信息",
            "错误处理和降级：处理网络错误、API失败等异常，提供部分结果或友好提示"
          ],
          "specialized_skills": [
            "医疗文本理解：准确识别药物相关术语、副作用描述、疗效评价",
            "多语言处理：支持中英文药物名称和反馈内容",
            "并发任务编排：协调多个异步工具调用，优化执行顺序",
            "数据质量评估：判断反馈信息的可信度和相关性",
            "来源追溯：记录每条信息的来源URL、网站、时间戳",
            "合规性控制：遵守robots.txt规则，控制访问频率",
            "缓存策略管理：根据数据类型和时效性设置不同的缓存时长"
          ],
          "limitations": [
            "不提供医疗诊断或治疗建议，仅收集公众反馈",
            "不访问需要登录或付费的专业医疗数据库",
            "无法验证反馈信息的医学准确性，仅标注来源可信度",
            "依赖搜索引擎的覆盖范围，可能遗漏部分小众网站",
            "受限于Tavily API配额和网络条件",
            "无法处理图片、视频等非文本反馈",
            "不进行药物对比或推荐，仅呈现单一药物的反馈"
          ],
          "tools_required": [
            "tavily_search_tool：使用Tavily Search API执行网络搜索",
            "web_page_extractor_tool：抓取和解析网页内容",
            "content_analyzer_tool：使用Claude模型分析文本并提取结构化信息",
            "report_generator_tool：生成结构化的反馈报告",
            "cache_manager_tool：管理搜索结果和报告的缓存"
          ]
        },
        "knowledge_domain": {
          "primary_domains": [
            "网络信息检索：搜索策略、关键词优化、结果排序",
            "网页抓取技术：HTML解析、内容提取、反爬虫应对",
            "自然语言处理：文本分类、情感分析、信息提取",
            "医疗健康知识：药物名称、副作用术语、疗效描述",
            "数据分析：统计计算、去重算法、质量评估"
          ],
          "expertise_level": "中级专家。在网络搜索和信息提取方面达到专家水平，在医疗健康领域具备足够的术语识别能力但不具备专业诊断能力。",
          "knowledge_sources": [
            "Tavily Search API提供的网络搜索结果",
            "公开的医疗健康网站、论坛、社交媒体",
            "Claude模型的预训练知识（医疗文本理解）",
            "内置的药物名称变体规则库",
            "robots.txt和网络爬虫合规规范"
          ],
          "update_frequency": "实时更新。每次查询都从最新的网络数据中收集信息。缓存数据根据类型分别保留7-30天后自动失效。"
        },
        "interaction_patterns": {
          "communication_style": "流式交互模式。用户发起请求后，Agent立即开始执行并通过流式响应实时反馈进度：\n1. 确认接收药物名称\n2. 输出搜索进度（'正在搜索...已找到X个结果'）\n3. 输出抓取进度（'正在抓取第X/Y个网页...'）\n4. 输出分析进度（'正在分析反馈信息...'）\n5. 逐步输出报告各部分（摘要、正面反馈、负面反馈、副作用、统计数据、来源）\n6. 最后输出完整的JSON格式报告",
          "conversation_flow": "单轮对话模式。每次请求独立处理，不依赖历史对话上下文。流程：\n1. 输入验证：检查drug_name参数是否有效\n2. 缓存检查：如果存在有效缓存且force_refresh=False，直接返回缓存结果\n3. 信息收集：执行搜索→抓取→分析的完整流程\n4. 报告生成：汇总数据并生成结构化报告\n5. 缓存更新：将结果写入缓存\n6. 结果返回：流式输出完整报告",
          "error_responses": [
            "无搜索结果：'未找到关于【药物名】的反馈信息。建议：1) 检查药物名称拼写 2) 尝试使用通用名或商品名 3) 确认该药物是否为常用药物'",
            "网络错误：'网络连接异常，已重试3次仍失败。建议：1) 检查网络连接 2) 稍后重试 3) 如持续失败请联系管理员'",
            "API配额耗尽：'搜索服务配额已用完，已返回部分结果（X条反馈）。建议：1) 使用当前部分结果 2) 1小时后重试以获取完整数据'",
            "数据质量低：'仅找到少量反馈信息（少于5条），结果可能不全面。建议：1) 参考但不完全依赖此结果 2) 尝试其他药物名称变体 3) 咨询医疗专业人士'",
            "LLM分析失败：'AI分析服务暂时不可用，已使用基础规则提取（准确率可能较低）。建议：稍后重试以获取更准确的分析结果'",
            "输入无效：'请提供有效的药物名称。示例：阿司匹林、布洛芬、Aspirin'"
          ]
        },
        "constraints": [
          "必须遵守robots.txt规则，不抓取禁止访问的网站",
          "单个域名每秒最多1个请求，避免对目标网站造成负担",
          "网页内容只保留前10KB，避免内存溢出",
          "单次查询最多抓取50个网页，防止资源耗尽",
          "LLM单次输入不超过150K tokens，需要分批处理大量内容",
          "缓存总大小不超过1GB，超过时删除最旧的缓存",
          "总处理时间不超过10分钟，超时后返回部分结果",
          "不存储用户个人信息，仅处理药物名称和公开反馈",
          "报告中必须包含免责声明，明确不提供医疗建议",
          "所有外部API调用必须使用HTTPS加密"
        ],
        "evaluation_criteria": [
          "信息覆盖率：能成功收集至少80%常见药物的反馈信息",
          "数据质量：每个报告包含至少10条有效反馈",
          "分类准确率：信息分类（疗效、副作用、体验）准确率达85%以上",
          "情感分析准确率：正负面判断准确率达80%以上",
          "响应时间：缓存命中时<10秒，完整流程<5分钟",
          "系统稳定性：成功完成查询的比例达95%以上",
          "缓存命中率：达到40%以上",
          "错误恢复能力：网络错误、API失败时能返回部分结果或友好提示",
          "用户满意度：报告可读性和有用性评价为满意或以上",
          "合规性：100%遵守robots.txt规则，无违规访问"
        ],
        "model_requirements": {
          "model_name": "global.anthropic.claude-sonnet-4-5-20250929-v1:0",
          "minimum_capabilities": [
            "长文本理解：支持至少150K tokens输入",
            "医疗文本理解：准确识别药物名称、副作用、疗效描述",
            "多语言支持：中英文文本理解和生成",
            "结构化输出：生成JSON格式的分类结果",
            "情感分析：判断文本的正负面倾向",
            "信息提取：从长文本中提取关键信息",
            "推理能力：判断信息的相关性和可信度"
          ],
          "rationale": "Claude Sonnet 4.5在医疗文本理解、长文本处理和结构化输出方面表现优秀。相比GPT-4成本更低（约50%），响应速度更快（约2倍）。相比开源模型在医疗领域准确率更高（提升30%以上）。200K tokens的上下文窗口足以一次处理多个网页内容，减少API调用次数。"
        },
        "memory_configuration": {
          "memory_type": "混合记忆系统：短期内存（会话级别）+ 持久化缓存（跨会话）",
          "retention_policy": "短期内存：仅在单次请求处理期间保留，包括搜索结果、抓取内容、分析中间结果。请求完成后自动释放。\n持久化缓存：搜索结果缓存7天，最终报告缓存30天。缓存总大小超过1GB时，按LRU策略删除最旧的缓存。用户可通过force_refresh=True绕过缓存。",
          "retrieval_strategy": "两阶段检索：\n1. 缓存检查：计算药物名称的哈希值作为缓存键，检查.cache/drug_feedback_collector/<hash>/目录下是否存在未过期的report.json\n2. 实时收集：如果缓存不存在或已过期，执行完整的搜索→抓取→分析流程，并将结果写入缓存\n\n缓存键生成：使用药物名称的小写、去空格版本的SHA256哈希值，确保不同表达方式的同一药物共享缓存（如'阿司匹林'和'阿司匹林片'）"
        }
      }
    ],
    "agent_relationships": [],
    "system_integration": {
      "entry_point": "BedrockAgentCoreApp HTTP服务器监听8080端口的/invocations端点。请求体格式：\n{\n  \"prompt\": \"阿司匹林\",  // 或 \"message\": \"阿司匹林\", \"input\": \"阿司匹林\"\n  \"force_refresh\": false,  // 可选\n  \"max_results\": 20,  // 可选\n  \"include_sources\": true  // 可选\n}\n\nhandler函数解析请求参数，创建Agent实例，调用agent.stream_async()执行任务，通过yield流式返回结果。",
      "exit_points": [
        "成功场景：流式输出完整的FeedbackReport JSON，最后一条消息包含完整报告",
        "部分成功场景：流式输出部分结果和警告信息，标注数据不完整",
        "失败场景：输出以'Error: '开头的错误信息，包含具体的失败原因和建议"
      ],
      "external_interfaces": [
        "Tavily Search API：通过HTTPS POST请求发送搜索查询，接收JSON格式的搜索结果列表",
        "目标网站：通过HTTP GET请求抓取网页内容，解析HTML提取正文",
        "AWS Bedrock Claude API：通过boto3 SDK发送文本分析请求，接收结构化的分析结果",
        "本地文件系统：读写.cache/drug_feedback_collector/目录下的缓存文件",
        "OTLP Exporter：发送遥测数据到配置的OTLP端点（默认http://localhost:4318）"
      ]
    }
  }
}
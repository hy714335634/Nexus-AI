{
  "system_design": {
    "design_overview": {
      "project_name": "text_to_poetry_agent",
      "version": "1.0",
      "date": "2025-12-02",
      "design_scope": "设计一个单Agent架构的文字转诗歌系统，基于Amazon Bedrock AgentCore和Claude Sonnet 4.5模型，通过提示词工程实现文本理解、情感分析、风格选择和诗歌创作的完整流程。系统采用单一AI Agent配合精心设计的提示词模板，无需复杂的多Agent协作或外部工具开发。",
      "design_principles": [
        "单一职责原则：Agent专注于文字到诗歌的转换，功能内聚",
        "简洁性原则：采用单Agent架构，避免不必要的复杂度",
        "提示词驱动：核心功能通过提示词工程实现，而非硬编码逻辑",
        "可扩展性：提示词模板易于调整和优化，支持风格扩展",
        "容错性：完善的异常处理和用户友好的错误提示",
        "性能优先：优化响应时间，确保用户体验流畅"
      ],
      "key_decisions": [
        "采用单Agent架构：需求功能明确且内聚，单一Agent即可完成全流程",
        "基于content_generator_agent模板：该模板具备完整的创意生成能力，与诗歌创作需求高度契合",
        "提示词工程为核心：通过精心设计的提示词实现情感分析、风格选择和诗歌生成，无需额外工具开发",
        "使用Claude Sonnet 4.5模型：global.anthropic.claude-sonnet-4-5-20250929-v1:0，具备强大的中文理解和创意生成能力",
        "BedrockAgentCore部署：使用@app.entrypoint装饰器和HTTP服务模式，支持生产环境部署",
        "无持久化存储：不保存用户数据，每次请求独立处理，保护用户隐私"
      ],
      "workflow_type": "single_agent",
      "recommended_templates": [
        "content_generator_agent - 智能内容生成器（强烈推荐，匹配度92%）"
      ]
    },
    "architecture": {
      "system_context": "文字转诗歌系统是一个独立的AI服务，部署在Amazon Bedrock AgentCore上。用户通过HTTP API发送普通文字内容，系统接收后由单一Agent进行处理：首先理解文字的情感和主题，然后智能选择合适的诗歌风格，最后生成格式化的诗歌作品并返回给用户。系统不依赖外部数据库或第三方服务，完全基于Claude Sonnet 4.5模型的自然语言处理能力。",
      "agent_topology": "单Agent拓扑结构：\n\n[用户输入] → [BedrockAgentCore HTTP Endpoint] → [text_to_poetry_agent]\n                                                              ↓\n                                                      [Claude Sonnet 4.5模型]\n                                                              ↓\n                                                      [诗歌输出] → [用户]\n\n说明：\n- 用户通过HTTP POST请求发送文字内容\n- BedrockAgentCore接收请求并路由到text_to_poetry_agent\n- Agent使用精心设计的提示词调用Claude Sonnet 4.5模型\n- 模型完成文本理解、情感分析、风格选择和诗歌生成\n- Agent格式化输出结果并返回给用户",
      "interaction_model": "同步请求-响应模型：\n\n1. 用户发起请求（包含文字内容）\n2. Agent接收并验证输入（检查内容有效性和长度）\n3. Agent构建提示词（包含系统指令、用户文字、风格指导）\n4. Agent调用Claude Sonnet 4.5模型进行推理\n5. 模型返回生成的诗歌内容\n6. Agent格式化输出（标准化诗歌格式）\n7. Agent返回结果给用户\n\n异常情况处理：\n- 输入为空或无效：返回友好提示\n- 输入过长（>2000字）：提示简化或自动截取\n- 模型调用失败：返回错误信息并建议重试\n- 超时：返回超时提示",
      "technology_stack": {
        "sdk": "Strands SDK + BedrockAgentCore",
        "runtime": "Amazon Bedrock AgentCore (HTTP Server模式)",
        "model": "Claude Sonnet 4.5 (global.anthropic.claude-sonnet-4-5-20250929-v1:0)",
        "integrations": [
          "Amazon Bedrock - AI模型推理",
          "nexus_utils.agent_factory - Agent创建工具",
          "Python 3.13+ - 运行环境"
        ]
      }
    },
    "agents": [
      {
        "name": "text_to_poetry_agent",
        "purpose": "将用户输入的普通文字转换为富有艺术美感的诗歌作品",
        "responsibilities": [
          "接收并验证用户输入的文字内容",
          "理解文字的情感基调、主题和核心意境",
          "智能选择合适的诗歌风格（现代诗、古体诗、自由诗）",
          "生成符合诗歌韵律和意境的作品内容",
          "格式化输出诗歌（标准化分行、分节、标点）",
          "处理异常情况并提供友好的用户反馈"
        ],
        "interfaces": {
          "inputs": [
            "prompt: str - 用户输入的文字内容（必需）",
            "style_preference: str - 诗歌风格偏好（可选，如'modern', 'classical', 'free'）",
            "max_length: int - 最大输入长度限制（默认2000字）"
          ],
          "outputs": [
            "poem: str - 生成的诗歌内容（格式化后的文本）",
            "metadata: dict - 元数据（可选，包含风格、情感分析结果等）",
            "error_message: str - 错误信息（仅在失败时返回）"
          ]
        },
        "dependencies": [
          "Claude Sonnet 4.5模型 - 核心AI推理能力",
          "nexus_utils.agent_factory - Agent实例化",
          "BedrockAgentCore - HTTP服务框架",
          "提示词模板 - prompts/generated_agents_prompts/text_to_poetry_agent/text_to_poetry_agent.yaml"
        ],
        "implementation_notes": [
          "基于content_generator_agent模板进行定制",
          "提示词设计是核心：需要包含诗歌创作专业指导、风格定义、情感分析指令",
          "输入验证：检查内容有效性、长度限制、特殊字符处理",
          "使用@app.entrypoint装饰器定义handler函数，符合AgentCore规范",
          "handler函数返回字符串（str），不是Dict",
          "支持本地测试模式（-i参数）和AgentCore部署模式",
          "异常处理：捕获所有异常并返回用户友好的错误信息",
          "日志记录：记录关键操作和错误信息，便于调试",
          "性能优化：控制提示词长度，避免过长导致响应慢"
        ],
        "recommended_template": "content_generator_agent（智能内容生成器）- 该模板专门用于创意内容生成，支持多种内容类型和风格，与诗歌创作需求高度契合。模板提供完整的提示词框架和Agent结构，可直接基于此定制。"
      }
    ],
    "data_models": [
      {
        "name": "PoetryRequest",
        "schema": "{\n  \"prompt\": \"string (required) - 用户输入的文字内容\",\n  \"style_preference\": \"string (optional) - 诗歌风格偏好，可选值：'auto', 'modern', 'classical', 'free'\",\n  \"max_length\": \"integer (optional) - 最大输入长度，默认2000\"\n}",
        "validation_rules": [
          "prompt不能为空或仅包含空白字符",
          "prompt长度不超过max_length（默认2000字）",
          "style_preference必须是预定义的有效值之一",
          "max_length必须在100-5000范围内"
        ],
        "relationships": [
          "输入到text_to_poetry_agent的handler函数"
        ]
      },
      {
        "name": "PoetryResponse",
        "schema": "{\n  \"poem\": \"string - 生成的诗歌内容（格式化后的文本）\",\n  \"style\": \"string - 使用的诗歌风格\",\n  \"emotion\": \"string - 识别的情感基调\",\n  \"line_count\": \"integer - 诗歌行数\",\n  \"status\": \"string - 处理状态（success/error）\",\n  \"message\": \"string - 状态消息或错误提示\"\n}",
        "validation_rules": [
          "poem不能为空（成功情况下）",
          "style必须是预定义的有效值",
          "status必须是'success'或'error'",
          "error情况下必须包含message字段"
        ],
        "relationships": [
          "从text_to_poetry_agent的handler函数返回"
        ]
      },
      {
        "name": "PromptTemplate",
        "schema": "{\n  \"system_prompt\": \"string - 系统提示词，定义Agent角色和能力\",\n  \"user_prompt_template\": \"string - 用户提示词模板，包含变量占位符\",\n  \"style_definitions\": \"dict - 各种诗歌风格的定义和特征\",\n  \"emotion_keywords\": \"dict - 情感关键词和识别规则\",\n  \"format_instructions\": \"string - 输出格式指导\"\n}",
        "validation_rules": [
          "system_prompt必须包含诗歌创作专业指导",
          "user_prompt_template必须包含{text_input}占位符",
          "style_definitions必须至少包含3种风格",
          "format_instructions必须明确输出格式要求"
        ],
        "relationships": [
          "用于text_to_poetry_agent的提示词配置",
          "存储在prompts/generated_agents_prompts/text_to_poetry_agent/text_to_poetry_agent.yaml"
        ]
      }
    ],
    "interaction_flows": [
      {
        "name": "标准诗歌生成流程",
        "description": "用户输入文字，系统生成诗歌的完整流程",
        "steps": [
          {
            "step": "1. 接收用户请求",
            "agent": "text_to_poetry_agent",
            "action": "接收HTTP POST请求，提取payload中的prompt字段",
            "data": "PoetryRequest - 包含用户文字内容和可选参数"
          },
          {
            "step": "2. 输入验证",
            "agent": "text_to_poetry_agent",
            "action": "验证输入有效性：检查prompt非空、长度符合要求、无异常字符",
            "data": "验证结果 - 通过则继续，失败则返回错误提示"
          },
          {
            "step": "3. 构建提示词",
            "agent": "text_to_poetry_agent",
            "action": "基于提示词模板构建完整的提示词，包含系统指令、用户文字、风格指导",
            "data": "完整提示词 - 包含系统提示词和用户提示词"
          },
          {
            "step": "4. 调用AI模型",
            "agent": "text_to_poetry_agent",
            "action": "调用Claude Sonnet 4.5模型进行推理，生成诗歌内容",
            "data": "模型响应 - 包含生成的诗歌文本"
          },
          {
            "step": "5. 提取和格式化输出",
            "agent": "text_to_poetry_agent",
            "action": "从模型响应中提取诗歌内容，进行格式化处理（分行、标点、排版）",
            "data": "格式化的诗歌文本"
          },
          {
            "step": "6. 返回结果",
            "agent": "text_to_poetry_agent",
            "action": "将诗歌内容以字符串形式返回给用户",
            "data": "PoetryResponse - 成功则返回诗歌，失败则返回错误信息"
          }
        ]
      },
      {
        "name": "异常处理流程",
        "description": "处理各种异常情况的流程",
        "steps": [
          {
            "step": "1. 输入异常处理",
            "agent": "text_to_poetry_agent",
            "action": "检测到输入为空或无效时，返回友好提示",
            "data": "错误消息：'请提供有效的文字内容'"
          },
          {
            "step": "2. 长度超限处理",
            "agent": "text_to_poetry_agent",
            "action": "检测到输入超过2000字时，提示用户简化或自动截取前2000字",
            "data": "警告消息：'输入内容过长，已自动截取前2000字进行处理'"
          },
          {
            "step": "3. 模型调用失败处理",
            "agent": "text_to_poetry_agent",
            "action": "捕获模型调用异常，返回错误提示并建议重试",
            "data": "错误消息：'诗歌生成失败，请稍后重试'"
          },
          {
            "step": "4. 超时处理",
            "agent": "text_to_poetry_agent",
            "action": "检测到处理超时（>10秒），返回超时提示",
            "data": "错误消息：'处理超时，请简化输入内容后重试'"
          }
        ]
      }
    ],
    "security_considerations": [
      "用户输入不进行持久化存储，保护用户隐私",
      "遵守AWS Bedrock的安全和隐私政策",
      "不记录用户敏感信息到日志中",
      "API调用使用AWS IAM认证机制",
      "输入验证防止注入攻击（检查特殊字符和长度）",
      "错误信息不暴露系统内部细节",
      "使用环境变量管理敏感配置（如模型ID）"
    ],
    "error_handling": [
      "输入验证错误：返回具体的验证失败原因和改进建议",
      "模型调用失败：捕获异常，返回用户友好的错误信息，记录详细日志",
      "超时处理：设置合理的超时时间（10秒），超时后返回提示",
      "网络异常：捕获网络错误，建议用户检查网络连接",
      "格式化错误：如果输出格式化失败，返回原始模型输出",
      "未知异常：捕获所有未预期异常，返回通用错误提示，记录完整堆栈",
      "降级策略：如果模型不可用，返回明确的服务不可用提示"
    ],
    "performance_considerations": [
      "响应时间目标：单次诗歌生成在10秒内完成",
      "输入长度限制：默认2000字，避免过长输入导致处理缓慢",
      "提示词优化：控制提示词长度，避免过长导致模型推理慢",
      "并发处理：AgentCore支持多并发请求，目标支持10+并发",
      "缓存策略：不使用缓存（每次生成独立），保证创意多样性",
      "模型选择：使用Claude Sonnet 4.5平衡性能和质量",
      "日志优化：使用结构化日志，避免过多日志影响性能",
      "资源管理：合理配置内存和CPU资源，避免资源耗尽"
    ],
    "monitoring_strategy": [
      "关键指标监控：请求成功率、平均响应时间、错误率",
      "日志记录：记录每次请求的输入长度、处理时间、模型响应状态",
      "错误追踪：记录所有异常的详细堆栈信息",
      "性能监控：监控模型调用延迟、HTTP服务响应时间",
      "健康检查：提供/health端点用于服务健康检查",
      "用户反馈：记录用户重试次数，识别问题模式",
      "资源监控：监控内存使用、CPU使用、网络流量",
      "告警机制：错误率超过阈值时触发告警"
    ]
  },
  "design_rationale": "本系统设计基于以下核心理念和技术决策：\n\n1. **单Agent架构选择**：经过需求分析，文字转诗歌功能目标明确、输入输出关系清晰，不需要多个专业角色协作。单一AI Agent配合良好的提示词工程即可完成全流程，避免了多Agent架构的复杂性和通信开销。\n\n2. **基于content_generator_agent模板**：通过agent_template_searcher工具的智能匹配，content_generator_agent模板获得92分的高匹配度。该模板专门设计用于创意内容生成，系统提示词明确包含'创意内容和故事创作'功能，与诗歌创作需求高度契合。模板提供完整的Agent框架、提示词模板和工具集成，可直接基于此定制，大大缩短开发时间。\n\n3. **提示词工程为核心**：诗歌创作的核心价值在于AI模型的创意生成能力和提示词的引导质量。通过精心设计的提示词，可以实现情感分析、风格选择、诗歌生成等所有核心功能，无需开发额外的工具函数。这种方式更灵活、易于优化和迭代。\n\n4. **Claude Sonnet 4.5模型选择**：根据用户自定义规则，使用'global.anthropic.claude-sonnet-4-5-20250929-v1:0'模型。该模型具备强大的中文理解和创意生成能力，能够准确把握文字情感、生成高质量诗歌，且性能和成本平衡良好。\n\n5. **BedrockAgentCore部署模式**：严格遵守AgentCore部署入口点规则，使用@app.entrypoint装饰器和HTTP服务模式。这种设计支持生产环境部署、水平扩展和标准化的API接口，同时保持本地测试的便利性。\n\n6. **无持久化存储设计**：基于隐私保护和系统简洁性考虑，不保存用户输入或生成结果。每次请求独立处理，避免了数据存储、管理和安全的复杂性。如果未来需要用户历史或偏好学习，可通过外部服务集成。\n\n7. **容错性和用户体验**：完善的输入验证、异常处理和友好的错误提示是核心设计原则。系统能够优雅处理各种异常情况（输入无效、模型失败、超时等），并提供具体的改进建议，确保用户体验流畅。\n\n8. **性能优化策略**：通过输入长度限制（2000字）、提示词优化、合理的超时设置（10秒）等手段，确保系统响应迅速。目标支持10+并发请求，满足实际使用需求。\n\n9. **可扩展性设计**：虽然当前是单Agent架构，但设计保持了良好的可扩展性。提示词模板易于调整和优化，支持添加新的诗歌风格；接口设计清晰，支持未来集成更多功能（如多语言、风格评分等）。\n\n10. **监控和可观测性**：设计包含完整的监控策略，记录关键指标、日志和错误信息，支持问题快速定位和系统优化。这对于生产环境的稳定运行至关重要。\n\n总结：本设计充分考虑了需求的特点、技术约束和最佳实践，采用最简洁有效的单Agent架构，基于成熟的模板进行定制，以提示词工程为核心驱动功能实现。设计在功能完整性、开发效率、系统性能和用户体验之间取得了良好的平衡，为后续的实现阶段提供了清晰的指导。"
}
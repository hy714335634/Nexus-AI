{
  "agent_design": {
    "design_overview": {
      "project_name": "fda_data_query_agent",
      "version": "1.0",
      "date": "2025-12-28",
      "design_scope": "设计一个专业的FDA数据查询智能体，能够通过自然语言交互理解用户查询意图，调用openFDA官方API获取药物、医疗设备、食品等FDA公开数据，提供准确、详细、可验证的专业问答服务。Agent采用单一职责设计，集成查询解析、API调用、数据处理、缓存管理、错误处理等核心能力，确保高可用性和良好的用户体验。",
      "design_goals": [
        "提供准确、客观、详细的FDA数据查询服务，确保信息可验证和可追溯",
        "支持自然语言交互，降低专业数据查询门槛，提升用户体验",
        "实现高效的缓存机制，降低API调用量，提升响应速度",
        "确保系统高可用性（99%），通过完善的错误处理和降级策略应对API异常",
        "支持多类型FDA数据查询（药物、医疗设备、食品、不良事件），满足不同用户需求",
        "提供数据不足时的智能提示和替代建议，增强系统透明度",
        "设计模块化、可扩展的架构，支持未来功能迭代和新数据源接入"
      ],
      "key_design_decisions": [
        {
          "decision": "采用单Agent架构，所有功能集成在fda_data_query_agent中",
          "rationale": "需求复杂度适中，功能相对独立，不涉及多角色协作。单Agent架构避免了多Agent协调开销，简化系统设计和维护。Agent内部通过工具函数实现功能模块化，保持代码清晰和可测试性。",
          "alternatives": [
            "多Agent架构（查询解析Agent + API调用Agent + 问答Agent）：增加系统复杂度，协调开销大，不适合本项目",
            "基于工作流编排（如Swarm或Graph）：过度设计，单Agent已足够满足需求"
          ],
          "consequences": [
            "优点：系统简单、维护成本低、响应延迟小、部署便捷",
            "缺点：未来如需支持复杂的多步骤工作流，可能需要重构为多Agent架构"
          ]
        },
        {
          "decision": "基于api_integration_agent模板进行定制开发",
          "rationale": "api_integration_agent模板提供完整的API调用、认证管理、数据转换工具，与本项目需求高度匹配（评分92/100）。复用模板能力可大幅减少开发工作量，专注于FDA特定逻辑的实现。模板已经过验证，稳定性和可靠性有保障。",
          "alternatives": [
            "从零开发：开发工作量大，需要重新实现API调用、错误处理等基础能力",
            "使用deep_research_agent模板：侧重研究和分析，不适合API集成场景"
          ],
          "consequences": [
            "优点：快速开发、代码复用率高、稳定性好",
            "缺点：需要理解模板结构，可能存在部分冗余功能"
          ]
        },
        {
          "decision": "使用提示词工程实现查询意图识别和实体提取",
          "rationale": "Claude Sonnet 4.5模型具备强大的医疗领域知识和自然语言理解能力。通过精心设计的提示词，可以实现查询类型识别（药物/设备/食品/不良事件）、关键实体提取（产品名称、成分、制造商等）、查询参数映射等功能，无需开发额外的NLU模块。这种方法灵活性高、易于迭代优化。",
          "alternatives": [
            "开发专用NLU模块：开发成本高，维护复杂，不如利用LLM的通用能力",
            "使用规则引擎：灵活性差，难以处理复杂和模糊的查询"
          ],
          "consequences": [
            "优点：开发快速、灵活性高、易于优化、无需额外训练",
            "缺点：依赖LLM推理能力，可能存在误判（通过提示词优化和置信度评估缓解）"
          ]
        },
        {
          "decision": "使用本地文件系统缓存，过期时间24小时",
          "rationale": "FDA数据更新频率低（日级别或周级别），本地缓存可有效降低API调用量（目标30%以上）、提升响应速度、降低限流风险。文件系统缓存实现简单，无需额外的缓存服务（如Redis），降低系统复杂度和成本。缓存按query_type组织目录，便于管理和清理。",
          "alternatives": [
            "使用Redis等外部缓存：增加系统依赖和运维成本，对于本项目过度设计",
            "不使用缓存：API调用量大，响应速度慢，容易触发限流"
          ],
          "consequences": [
            "优点：实现简单、成本低、响应快、降低API调用量",
            "缺点：缓存与应用实例绑定，多实例部署时缓存不共享（可通过共享存储解决）"
          ]
        },
        {
          "decision": "使用Claude Sonnet 4.5模型（global.anthropic.claude-sonnet-4-5-20250929-v1:0）",
          "rationale": "Claude Sonnet 4.5在性能和成本之间取得良好平衡，具备强大的医疗领域推理能力、长上下文窗口（200K tokens）、高质量的自然语言生成能力。能够理解复杂的专业查询，进行多步推理，生成详细、准确的回答。相比Claude Opus，成本更低；相比Claude Haiku，能力更强。",
          "alternatives": [
            "Claude Opus：能力最强但成本最高，对于本项目过度配置",
            "Claude Haiku：成本最低但推理能力有限，可能无法满足复杂查询需求"
          ],
          "consequences": [
            "优点：性能强、成本适中、医疗领域知识丰富、长上下文支持",
            "缺点：相比Haiku成本稍高（但在可接受范围内）"
          ]
        },
        {
          "decision": "支持流式响应，实时展示查询进度和结果",
          "rationale": "某些查询可能需要较长时间（如批量查询、多步推理），流式响应可以实时展示进度，提升用户体验，避免用户等待焦虑。BedrockAgentCoreApp原生支持流式响应，实现成本低。流式响应也便于调试和监控。",
          "alternatives": [
            "仅支持同步响应：用户体验差，长时间查询会导致超时或用户流失"
          ],
          "consequences": [
            "优点：用户体验好、实时反馈、支持长时间操作",
            "缺点：客户端需要支持流式响应处理"
          ]
        }
      ]
    },
    "agents": [
      {
        "agent_id": "fda_data_query_agent",
        "name": "FDA Data Query Agent",
        "role": "FDA数据查询和专业问答专家",
        "purpose": "作为用户与openFDA API之间的智能中介，理解用户的自然语言查询需求，调用相应的FDA API端点获取药物、医疗设备、食品等公开数据，提供准确、详细、可验证的专业问答服务。Agent能够处理复杂查询、进行多维度数据分析、生成数据来源追溯信息，并在数据不足时提供智能提示和替代建议。",
        "personality": {
          "traits": [
            "专业严谨：对医疗健康数据保持严谨态度，确保信息准确性和客观性",
            "耐心细致：能够处理复杂和模糊的查询，主动澄清用户意图",
            "透明可信：所有信息都提供数据来源，确保可验证性",
            "友好助人：用户友好的沟通方式，避免过度技术化的表达",
            "适应性强：能够根据数据可用性调整回答策略，提供替代方案"
          ],
          "communication_style": "专业但易懂，结构化但不生硬。使用清晰的语言解释复杂的医疗术语，提供分层次的信息（摘要 + 详情）。在回答中明确区分事实陈述（基于FDA数据）和分析推断（基于多维度数据的综合分析）。遇到不确定或数据不足时，诚实说明限制并提供建议。",
          "tone": "客观、准确、详细、可验证。保持专业性的同时，使用用户友好的表达方式。避免过度自信的断言，对不确定性保持透明。"
        },
        "capabilities": {
          "core_functions": [
            "自然语言查询解析：识别查询类型（药物/设备/食品/不良事件），提取关键实体（产品名称、成分、制造商等），映射到openFDA API查询参数",
            "多类型FDA数据查询：支持药物（drug/label、drug/event、drug/nda）、医疗设备（device/classification、device/recall、device/event）、食品（food/label、food/recall、food/event）等多个API端点",
            "数据提取和格式化：从API响应中提取关键信息（批准日期、适应症、不良反应、召回原因等），格式化为结构化和易读的展示形式",
            "专业问答和推理：基于查询结果进行多步推理，回答比较性问题（如安全性对比）、趋势性问题（如不良事件趋势）、综合性问题（如风险评估）",
            "数据来源追溯：为每条数据生成DataSource对象，包含API端点、完整请求URL、查询参数、时间戳，确保信息可验证",
            "缓存管理：查询结果本地缓存，过期时间24小时，提升响应速度和降低API调用量",
            "错误处理和降级：处理API错误（400/429/500/超时），使用重试和缓存降级策略，确保高可用性",
            "数据不足处理：识别数据不足情况（空结果、字段缺失、数据不完整），分析原因，提供智能提示和替代建议",
            "批量查询支持：支持多个产品的批量查询，提供进度展示和数据导出功能（可选）"
          ],
          "specialized_skills": [
            "医疗术语理解：能够理解和映射医疗领域的专业术语、同义词、俗称（如Aspirin vs 阿司匹林 vs acetylsalicylic acid）",
            "openFDA API专家：深入理解openFDA API结构、查询语法、数据模型、限流政策",
            "数据质量评估：评估查询结果的完整性和可靠性，识别数据缺失和异常",
            "多维度数据整合：整合来自不同API端点的数据（如药物标签 + 不良事件 + 批准信息），提供综合分析",
            "查询优化：对复杂查询进行拆分和优化，提升查询效率和准确性",
            "用户意图推断：根据上下文推断用户的真实需求，主动提供相关信息"
          ],
          "limitations": [
            "数据范围限制：仅能查询openFDA API提供的公开数据，无法访问FDA内部数据或非公开信息",
            "数据时效性：依赖FDA数据更新频率，可能存在滞后（通常为日级别或周级别）",
            "语言限制：初版仅支持英文查询和英文数据展示，不支持多语言",
            "医疗建议限制：不提供医疗建议、诊断或治疗方案，仅提供FDA公开数据查询服务",
            "API依赖性：系统可用性依赖openFDA API的稳定性，API不可用时功能受限（可使用缓存降级）",
            "查询复杂度限制：对于极其复杂或需要深度医学知识的查询，可能无法提供完整回答",
            "数据完整性限制：FDA数据本身可能存在缺失或不完整，Agent无法补充未公开的信息"
          ],
          "tools_required": [
            "fda_api_client：封装openFDA API调用，支持多个endpoint（drugs、devices、foods）和查询参数",
            "cache_manager：管理本地文件系统缓存，支持缓存读写、过期检查、LRU清理",
            "query_parser：解析自然语言查询，识别查询类型和提取关键实体（基于提示词工程）",
            "data_formatter：格式化查询结果，提取关键字段，生成结构化和易读的展示形式",
            "source_tracker：生成数据来源追溯信息（DataSource对象），包含API URL、查询参数、时间戳",
            "http_request：通用HTTP请求工具（从api_integration_agent模板继承），支持GET/POST请求、请求头、超时控制",
            "error_handler：错误处理工具，分类错误类型，执行重试和降级策略，生成用户友好的错误提示"
          ]
        },
        "knowledge_domain": {
          "primary_domains": [
            "FDA监管体系：理解FDA的职责范围、监管流程、数据公开政策",
            "openFDA API：深入掌握API结构、端点、查询语法、数据模型、限流政策",
            "药物知识：药物分类、批准流程（NDA/ANDA）、标签内容、不良反应报告（FAERS）",
            "医疗设备知识：设备分类（Class I/II/III）、510(k)流程、召回流程、不良事件报告（MAUDE）",
            "食品安全知识：食品标签、营养成分、过敏原、召回流程、膳食补充剂",
            "医疗术语：常见医疗术语、同义词、缩写、俗称的理解和映射"
          ],
          "expertise_level": "专家级（Expert）：对FDA监管和openFDA API有深入理解，能够处理复杂和专业的查询，提供准确和详细的回答。",
          "knowledge_sources": [
            "openFDA API官方文档（https://open.fda.gov/apis/）",
            "FDA官方网站（https://www.fda.gov/）",
            "FAERS数据库文档",
            "MAUDE数据库文档",
            "药物标签和批准文件示例",
            "医疗术语词典（如MedDRA、SNOMED CT）",
            "Claude模型的预训练医疗领域知识"
          ],
          "update_frequency": "知识来源为静态文档和预训练知识，无需频繁更新。如openFDA API有重大变更（如新增端点、修改查询语法），需要更新提示词和工具函数。建议每季度检查一次API文档更新。"
        },
        "interaction_patterns": {
          "communication_style": "交互式对话，支持多轮查询和追问。Agent主动澄清模糊查询，提供查询建议，引导用户获取所需信息。",
          "conversation_flow": "1. 接收用户查询 -> 2. 解析查询意图和实体 -> 3. 如意图不明确，主动询问澄清 -> 4. 执行查询（检查缓存 -> 调用API -> 处理响应） -> 5. 生成回答（数据展示 + 专业分析 + 数据来源） -> 6. 提供后续查询建议 -> 7. 等待用户追问或新查询。支持流式响应，实时展示查询进度。",
          "error_responses": [
            "API错误（400参数错误）：'抱歉，查询参数有误。请检查产品名称是否正确，或尝试使用更通用的关键词。例如，使用通用名代替商品名。'",
            "API限流（429）：'系统正在处理大量请求，请稍后再试。我将尝试从缓存中获取相关数据...'",
            "API不可用（500/超时）：'抱歉，FDA数据服务暂时不可用。我将尝试从缓存中获取数据（可能不是最新）。如需最新数据，请稍后重试或访问FDA官网。'",
            "空结果：'未找到与"{query}"相关的FDA数据。可能原因：1) 该产品未在FDA注册；2) 数据尚未公开；3) 产品名称不匹配。建议：1) 尝试使用通用名或其他关键词；2) 访问FDA官网进行人工查询；3) 联系FDA获取更多信息。'",
            "数据不完整：'查询到部分数据，但以下信息缺失：{missing_fields}。这可能是因为FDA数据库中该产品的信息不完整。建议访问FDA官网查看完整记录。'",
            "查询意图不明确：'我不太确定您想查询什么。您是想查询：1) 药物信息？2) 医疗设备信息？3) 食品信息？4) 不良事件报告？请告诉我，以便我提供更准确的结果。'"
          ]
        },
        "constraints": [
          "必须使用openFDA官方API，不得抓取FDA网站数据或使用非官方数据源",
          "遵守openFDA API使用条款和限流政策（240次/分钟/IP），不得滥用API",
          "不提供医疗建议、诊断或治疗方案，仅提供FDA公开数据查询服务，并在回答中明确免责声明",
          "不存储用户敏感信息，日志中不记录完整的用户查询内容（仅记录查询类型和时间戳）",
          "缓存数据仅限FDA公开数据，不包含用户个人信息",
          "所有API通信必须使用HTTPS协议，确保数据传输安全",
          "查询结果必须包含数据来源信息（DataSource对象），确保可验证性和透明度",
          "在回答中明确区分事实陈述（基于FDA数据）和分析推断（基于多维度数据的综合分析）",
          "对于超出FDA数据范围的查询（如其他国家监管机构数据），明确说明限制并提供替代建议",
          "系统响应时间目标：5秒内（不含网络延迟），超时时使用缓存降级或返回友好提示"
        ],
        "evaluation_criteria": [
          "查询意图识别准确率：≥85%（通过人工标注测试集评估）",
          "API调用成功率：≥95%（排除FDA API故障时间）",
          "缓存命中率：≥60%（常见查询）",
          "响应时间：≤5秒（单次查询，不含网络延迟）",
          "数据来源完整性：100%的查询结果都包含DataSource对象",
          "错误处理有效性：所有API错误都能被捕获并转换为用户友好的提示",
          "数据不足处理质量：能够准确识别数据不足情况并提供有价值的建议",
          "用户满意度：≥4/5（通过用户反馈调查）",
          "系统可用性：≥99%（排除FDA API不可用时间）",
          "回答质量：准确性、完整性、客观性、可验证性符合专业标准"
        ],
        "model_requirements": {
          "model_name": "global.anthropic.claude-sonnet-4-5-20250929-v1:0",
          "minimum_capabilities": [
            "长上下文支持（≥100K tokens）：处理大量FDA数据和多轮对话历史",
            "医疗领域知识：理解医疗术语、药物分类、监管流程等专业知识",
            "自然语言理解：准确识别查询意图、提取关键实体、处理模糊和复杂查询",
            "多步推理：基于多维度数据进行综合分析和推理",
            "结构化输出：生成格式良好的JSON和自然语言回答",
            "工具调用：准确调用工具函数，传递正确的参数",
            "错误处理：理解错误信息，生成用户友好的提示"
          ],
          "rationale": "Claude Sonnet 4.5在性能、成本、能力之间取得最佳平衡。具备强大的医疗领域知识和推理能力，能够处理复杂的专业查询。长上下文窗口支持大量数据处理和多轮对话。相比Opus成本更低，相比Haiku能力更强，最适合本项目需求。"
        },
        "memory_configuration": {
          "memory_type": "会话级短期记忆（Session-level short-term memory）+ 本地文件系统缓存（Persistent cache）",
          "retention_policy": "会话记忆：保留当前会话的对话历史和上下文，会话结束后清除。缓存数据：保留24小时，过期后自动清理。查询日志：保留30天，用于监控和分析。",
          "retrieval_strategy": "会话记忆：通过对话历史上下文传递给模型。缓存数据：基于cache_key（query_type + normalized_query + filters的哈希值）进行精确匹配检索。如缓存命中且未过期，直接返回缓存数据；否则调用API并更新缓存。"
        }
      }
    ],
    "agent_relationships": [],
    "system_integration": {
      "entry_point": "HTTP /invocations端点（BedrockAgentCoreApp标准入口）。接收POST请求，请求体包含prompt（用户查询）、user_id（可选）、session_id（可选）、media（可选）。handler函数异步处理请求，使用agent.stream_async()生成流式响应。",
      "exit_points": [
        "HTTP响应：返回QueryResponse对象（JSON格式）或流式响应（文本片段）",
        "缓存写入：查询结果写入本地文件系统（.cache/fda_data_query_agent/）",
        "日志输出：错误日志和性能日志输出到标准输出或日志文件（CloudWatch）",
        "监控指标：查询次数、API调用次数、缓存命中率、错误率等指标输出到监控系统"
      ],
      "external_interfaces": [
        "openFDA API (https://api.fda.gov)：通过HTTPS GET请求调用多个端点（/drug/label.json、/drug/event.json、/device/recall.json等）",
        "本地文件系统：读写缓存数据（.cache/fda_data_query_agent/），按query_type组织子目录",
        "AWS CloudWatch（可选）：日志聚合和监控指标上报",
        "AWS Bedrock：模型推理服务（Claude Sonnet 4.5）",
        "用户客户端：通过HTTP接口与Agent交互，支持流式响应处理"
      ]
    }
  }
}
{
  "tool_development": {
    "development_overview": {
      "project_name": "fda_data_query_agent",
      "version": "1.0",
      "date": "2026-01-22",
      "development_scope": "为FDA数据查询Agent开发完整的工具集，包括FDA API集成工具（5个核心工具）和支持工具（9个辅助工具），覆盖药物、医疗设备、食品、不良事件和召回数据的查询、缓存管理、数据解析、参数验证和错误处理等功能",
      "design_principles": [
        "单一职责：每个工具函数专注于一个特定功能，接口清晰",
        "错误容错：完善的异常处理和重试机制，确保系统鲁棒性",
        "来源追溯：自动为所有FDA数据注入来源标注，确保数据可追溯",
        "性能优化：实现缓存机制（LRU策略）和连接复用，提升响应速度",
        "用户友好：返回结构化JSON数据，提供清晰的错误信息和改进建议",
        "标准规范：遵循Strands框架@tool装饰器规范，使用完整类型注解",
        "安全可靠：输入验证、参数清理、HTTPS通信、缓存大小限制"
      ],
      "key_decisions": [
        "工具文件拆分：将FDA API工具和支持工具分为两个文件，避免单文件过长（fda_api_tools.py和fda_support_tools.py）",
        "自动来源标注：在_annotate_source辅助函数中统一处理来源注入，工具调用时自动执行",
        "指数退避重试：API调用失败时实现1s、2s、4s的指数退避重试，最多3次",
        "缓存策略：24小时有效期，LRU清理策略，最大500MB限制",
        "综合搜索工具：提供search_fda_comprehensive工具，支持跨多个数据类型的一站式查询",
        "数据解析工具：提供专门的parse_fda_drug_data和parse_fda_device_data工具，提取关键字段",
        "参数验证工具：提供validate_search_parameters工具，前置验证查询参数",
        "智能建议工具：提供generate_query_suggestions工具，为失败查询生成改进建议",
        "格式化工具：提供format_fda_response工具，将原始数据格式化为易读文本",
        "健康检查工具：提供get_fda_api_stats工具，监控FDA API可用性和性能"
      ]
    },
    "tools": [
      {
        "tool_name": "query_fda_drugs",
        "description": "查询FDA药物批准信息、标签、NDC代码等数据，支持按品牌名、通用名、活性成分、制造商、NDC代码、申请号等多种方式查询",
        "function_signature": "query_fda_drugs(search_term: str, search_field: str = 'openfda.brand_name', limit: int = 10, skip: int = 0, sort_field: Optional[str] = None, sort_order: str = 'desc') -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词，如药品名称、活性成分等",
            "required": true
          },
          {
            "name": "search_field",
            "type": "str",
            "description": "搜索字段，可选值：openfda.brand_name（品牌名）、openfda.generic_name（通用名）、openfda.substance_name（活性成分）、openfda.manufacturer_name（制造商）、openfda.product_ndc（NDC代码）、application_number（申请号）",
            "required": false
          },
          {
            "name": "limit",
            "type": "int",
            "description": "返回结果数量限制，默认10，最大100",
            "required": false
          },
          {
            "name": "skip",
            "type": "int",
            "description": "跳过的结果数量，用于分页",
            "required": false
          },
          {
            "name": "sort_field",
            "type": "Optional[str]",
            "description": "排序字段，如receivedate",
            "required": false
          },
          {
            "name": "sort_order",
            "type": "str",
            "description": "排序顺序，asc或desc",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的查询结果，包含status（success/error）、query_type、search_term、total_results、returned_count、data（包含results数组和_metadata）、from_cache、error_message（失败时）、suggestions（失败时）等字段",
        "dependencies": ["requests", "json", "hashlib", "time", "typing", "urllib.parse", "strands"],
        "implementation_notes": [
          "调用FDA openFDA Drug Label API（/drug/label.json端点）",
          "自动验证和清理参数（limit限制1-100，skip≥0）",
          "使用_call_fda_api辅助函数处理API调用和重试",
          "使用_annotate_source辅助函数自动注入来源标注",
          "返回结构化JSON数据，包含完整的元数据和来源信息",
          "失败时返回友好的错误信息和改进建议"
        ],
        "error_handling": [
          "捕获requests异常（Timeout、ConnectionError等），实现指数退避重试",
          "处理HTTP错误状态码（404返回空结果，429触发限流重试，500抛出服务器错误）",
          "捕获JSON解析异常，返回格式错误提示",
          "所有异常统一返回JSON格式错误响应，包含error_type、error_message和suggestions"
        ],
        "usage_examples": [
          "query_fda_drugs('aspirin', 'openfda.brand_name', limit=5)",
          "query_fda_drugs('acetaminophen', 'openfda.generic_name', limit=10)",
          "query_fda_drugs('NDA021223', 'application_number', limit=1)"
        ]
      },
      {
        "tool_name": "query_fda_devices",
        "description": "查询FDA医疗设备分类、批准、510(k)/PMA信息等，支持按设备名称、制造商、产品代码、510(k)号等查询",
        "function_signature": "query_fda_devices(search_term: str, search_field: str = 'device_name', limit: int = 10, skip: int = 0, device_class: Optional[str] = None) -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词，如设备名称、制造商等",
            "required": true
          },
          {
            "name": "search_field",
            "type": "str",
            "description": "搜索字段，可选值：device_name、openfda.device_name、applicant（制造商）、product_code、k_number（510(k)号）",
            "required": false
          },
          {
            "name": "limit",
            "type": "int",
            "description": "返回结果数量限制，默认10，最大100",
            "required": false
          },
          {
            "name": "skip",
            "type": "int",
            "description": "跳过的结果数量，用于分页",
            "required": false
          },
          {
            "name": "device_class",
            "type": "Optional[str]",
            "description": "设备分类过滤，可选值：1、2、3",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的查询结果，结构同query_fda_drugs",
        "dependencies": ["requests", "json", "hashlib", "time", "typing", "urllib.parse", "strands"],
        "implementation_notes": [
          "调用FDA openFDA Device 510(k) API（/device/510k.json端点）",
          "支持device_class参数过滤，自动构建AND查询条件",
          "其他实现逻辑与query_fda_drugs类似"
        ],
        "error_handling": ["同query_fda_drugs"],
        "usage_examples": [
          "query_fda_devices('pacemaker', 'device_name', limit=5)",
          "query_fda_devices('Medtronic', 'applicant', device_class='3', limit=10)"
        ]
      },
      {
        "tool_name": "query_fda_food",
        "description": "查询FDA食品召回、执法行动、不良事件等数据，支持查询食品召回信息、执法行动和不良事件报告",
        "function_signature": "query_fda_food(search_term: str, search_field: str = 'product_description', data_type: str = 'recall', limit: int = 10, skip: int = 0, recall_class: Optional[str] = None) -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词，如产品名称、公司名等",
            "required": true
          },
          {
            "name": "search_field",
            "type": "str",
            "description": "搜索字段，可选值：product_description、recalling_firm（召回公司）、recall_number、reason_for_recall",
            "required": false
          },
          {
            "name": "data_type",
            "type": "str",
            "description": "数据类型，可选值：recall（召回信息）、enforcement（执法行动）、event（不良事件）",
            "required": false
          },
          {
            "name": "limit",
            "type": "int",
            "description": "返回结果数量限制，默认10，最大100",
            "required": false
          },
          {
            "name": "skip",
            "type": "int",
            "description": "跳过的结果数量，用于分页",
            "required": false
          },
          {
            "name": "recall_class",
            "type": "Optional[str]",
            "description": "召回级别过滤，可选值：Class I、Class II、Class III",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的查询结果，结构同query_fda_drugs，额外包含data_type和recall_class字段",
        "dependencies": ["requests", "json", "hashlib", "time", "typing", "urllib.parse", "strands"],
        "implementation_notes": [
          "根据data_type参数选择API端点：recall→/food/recall.json、enforcement→/food/enforcement.json、event→/food/event.json",
          "支持recall_class参数过滤（仅recall类型有效）",
          "其他实现逻辑与query_fda_drugs类似"
        ],
        "error_handling": ["同query_fda_drugs"],
        "usage_examples": [
          "query_fda_food('salmonella', 'reason_for_recall', data_type='recall', limit=5)",
          "query_fda_food('peanut butter', 'product_description', recall_class='Class I')"
        ]
      },
      {
        "tool_name": "query_fda_adverse_events",
        "description": "查询FDA药物或设备的不良事件报告数据，支持查询药物和医疗设备相关的不良事件报告",
        "function_signature": "query_fda_adverse_events(search_term: str, search_field: str = 'patient.drug.openfda.brand_name', product_type: str = 'drug', limit: int = 10, skip: int = 0, serious_only: bool = False, date_range: Optional[str] = None) -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词，如产品名称",
            "required": true
          },
          {
            "name": "search_field",
            "type": "str",
            "description": "搜索字段，可选值：patient.drug.openfda.brand_name、patient.drug.openfda.generic_name、patient.drug.medicinalproduct、device.brand_name、device.generic_name",
            "required": false
          },
          {
            "name": "product_type",
            "type": "str",
            "description": "产品类型，可选值：drug或device",
            "required": false
          },
          {
            "name": "limit",
            "type": "int",
            "description": "返回结果数量限制，默认10，最大100",
            "required": false
          },
          {
            "name": "skip",
            "type": "int",
            "description": "跳过的结果数量，用于分页",
            "required": false
          },
          {
            "name": "serious_only",
            "type": "bool",
            "description": "是否仅返回严重不良事件，默认False",
            "required": false
          },
          {
            "name": "date_range",
            "type": "Optional[str]",
            "description": "日期范围过滤，格式：YYYYMMDD:YYYYMMDD，如20200101:20231231",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的查询结果，结构同query_fda_drugs，额外包含product_type、serious_only、date_range字段",
        "dependencies": ["requests", "json", "hashlib", "time", "typing", "urllib.parse", "strands"],
        "implementation_notes": [
          "根据product_type参数选择API端点：drug→/drug/event.json、device→/device/event.json",
          "支持serious_only参数过滤（添加AND serious:'1'条件）",
          "支持date_range参数过滤（添加AND receivedate:[range]条件）",
          "其他实现逻辑与query_fda_drugs类似"
        ],
        "error_handling": ["同query_fda_drugs"],
        "usage_examples": [
          "query_fda_adverse_events('aspirin', serious_only=True, limit=5)",
          "query_fda_adverse_events('insulin pump', search_field='device.brand_name', product_type='device', date_range='20200101:20231231')"
        ]
      },
      {
        "tool_name": "query_fda_recalls",
        "description": "查询FDA召回信息（药物、设备、食品），支持查询药物、医疗设备和食品的召回信息",
        "function_signature": "query_fda_recalls(search_term: str, search_field: str = 'product_description', product_type: str = 'drug', limit: int = 10, skip: int = 0, recall_status: Optional[str] = None, recall_class: Optional[str] = None) -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词，如产品名称、公司名等",
            "required": true
          },
          {
            "name": "search_field",
            "type": "str",
            "description": "搜索字段，可选值：product_description、recalling_firm、recall_number、reason_for_recall",
            "required": false
          },
          {
            "name": "product_type",
            "type": "str",
            "description": "产品类型，可选值：drug、device、food",
            "required": false
          },
          {
            "name": "limit",
            "type": "int",
            "description": "返回结果数量限制，默认10，最大100",
            "required": false
          },
          {
            "name": "skip",
            "type": "int",
            "description": "跳过的结果数量，用于分页",
            "required": false
          },
          {
            "name": "recall_status",
            "type": "Optional[str]",
            "description": "召回状态过滤，可选值：Ongoing（进行中）、Completed（已完成）、Terminated（已终止）",
            "required": false
          },
          {
            "name": "recall_class",
            "type": "Optional[str]",
            "description": "召回级别过滤，可选值：Class I、Class II、Class III",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的查询结果，结构同query_fda_drugs，额外包含product_type、recall_status、recall_class字段",
        "dependencies": ["requests", "json", "hashlib", "time", "typing", "urllib.parse", "strands"],
        "implementation_notes": [
          "根据product_type参数选择API端点：drug→/drug/enforcement.json、device→/device/recall.json、food→/food/enforcement.json",
          "支持recall_status和recall_class参数过滤",
          "其他实现逻辑与query_fda_drugs类似"
        ],
        "error_handling": ["同query_fda_drugs"],
        "usage_examples": [
          "query_fda_recalls('insulin', 'product_description', product_type='drug', limit=5)",
          "query_fda_recalls('pacemaker', product_type='device', recall_status='Ongoing', recall_class='Class I')"
        ]
      },
      {
        "tool_name": "search_fda_comprehensive",
        "description": "综合搜索FDA数据（跨多个数据类型），执行跨多个FDA数据类型的综合搜索，适用于用户不确定数据类型或需要全面信息的场景",
        "function_signature": "search_fda_comprehensive(search_term: str, search_types: List[str] = None, limit_per_type: int = 5, include_adverse_events: bool = True, include_recalls: bool = True) -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词，如产品名称",
            "required": true
          },
          {
            "name": "search_types",
            "type": "List[str]",
            "description": "要搜索的数据类型列表，可选值：drugs、devices、food，如果不提供则搜索所有类型",
            "required": false
          },
          {
            "name": "limit_per_type",
            "type": "int",
            "description": "每种类型返回的结果数量，默认5",
            "required": false
          },
          {
            "name": "include_adverse_events",
            "type": "bool",
            "description": "是否包含不良事件数据，默认True",
            "required": false
          },
          {
            "name": "include_recalls",
            "type": "bool",
            "description": "是否包含召回数据，默认True",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的综合查询结果，包含status、search_term、search_types、timestamp、results（包含各类型的查询结果）、summary（统计信息）",
        "dependencies": ["requests", "json", "hashlib", "time", "typing", "urllib.parse", "strands"],
        "implementation_notes": [
          "内部调用query_fda_drugs、query_fda_devices、query_fda_food等工具",
          "如果include_adverse_events=True，为每种产品类型额外查询不良事件",
          "如果include_recalls=True，为每种产品类型额外查询召回信息",
          "每个子查询独立处理错误，单个失败不影响其他查询",
          "返回summary统计信息（total_queries、successful_queries、failed_queries）"
        ],
        "error_handling": [
          "捕获每个子查询的异常，记录到对应的结果中",
          "整体查询不会因单个子查询失败而失败",
          "在summary中统计成功和失败的查询数量"
        ],
        "usage_examples": [
          "search_fda_comprehensive('aspirin', search_types=['drugs'], limit_per_type=3)",
          "search_fda_comprehensive('insulin', include_adverse_events=True, include_recalls=True)"
        ]
      },
      {
        "tool_name": "get_fda_api_stats",
        "description": "获取FDA API统计信息和健康状态，用于检查FDA API的可用性和响应性能",
        "function_signature": "get_fda_api_stats() -> str",
        "parameters": [],
        "return_type": "str",
        "return_description": "JSON格式的API统计信息，包含status、api_status（healthy/degraded/unavailable）、base_url、timestamp、endpoints（各端点的状态和响应时间）、summary（统计摘要）",
        "dependencies": ["requests", "json", "time", "strands"],
        "implementation_notes": [
          "测试4个关键端点：drugs、devices、food、drug_events",
          "每个端点发送limit=1的测试请求，记录响应时间",
          "判断整体状态：所有端点可用→healthy，部分可用→degraded，全部不可用→unavailable",
          "超时时间设置为5秒（短于正常查询的10秒）"
        ],
        "error_handling": [
          "捕获每个端点测试的异常，记录为unavailable",
          "整体测试不会因单个端点失败而失败"
        ],
        "usage_examples": [
          "get_fda_api_stats()"
        ]
      },
      {
        "tool_name": "cache_query_result",
        "description": "缓存FDA查询结果，将查询结果存储到本地缓存，提升后续相同查询的响应速度",
        "function_signature": "cache_query_result(query_type: str, query_params: Dict[str, Any], result_data: str, cache_dir: str = None, expiration_hours: int = 24) -> str",
        "parameters": [
          {
            "name": "query_type",
            "type": "str",
            "description": "查询类型（drugs/devices/food/adverse_events/recalls/comprehensive）",
            "required": true
          },
          {
            "name": "query_params",
            "type": "Dict[str, Any]",
            "description": "查询参数字典",
            "required": true
          },
          {
            "name": "result_data",
            "type": "str",
            "description": "查询结果（JSON字符串）",
            "required": true
          },
          {
            "name": "cache_dir",
            "type": "str",
            "description": "缓存目录，默认使用.cache/fda_data_query_agent",
            "required": false
          },
          {
            "name": "expiration_hours",
            "type": "int",
            "description": "缓存过期时间（小时），默认24小时",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的缓存操作结果，包含status、cache_key、cache_file、cached_at、expires_at",
        "dependencies": ["os", "json", "hashlib", "time", "pathlib", "datetime", "strands"],
        "implementation_notes": [
          "使用_generate_cache_key生成基于查询参数的SHA256哈希值作为缓存键",
          "缓存文件存储在{cache_dir}/{query_type}/{cache_key}.json",
          "缓存条目包含：cache_key、query_type、query_params、cached_at、expires_at、hit_count、data",
          "写入缓存后调用_cleanup_cache_if_needed检查并清理过大缓存（LRU策略）",
          "自动创建缓存目录及子目录（drugs、devices、food、adverse_events、recalls、comprehensive）"
        ],
        "error_handling": [
          "捕获JSON解析异常，返回无效数据错误",
          "捕获文件IO异常，返回文件操作错误",
          "所有异常统一返回JSON格式错误响应"
        ],
        "usage_examples": [
          "cache_query_result('drugs', {'search_term': 'aspirin', 'limit': 10}, query_result_json)"
        ]
      },
      {
        "tool_name": "get_cached_result",
        "description": "从缓存中获取FDA查询结果，根据查询参数查找并返回缓存的查询结果",
        "function_signature": "get_cached_result(query_type: str, query_params: Dict[str, Any], cache_dir: str = None, allow_expired: bool = False, max_expired_days: int = 7) -> str",
        "parameters": [
          {
            "name": "query_type",
            "type": "str",
            "description": "查询类型（drugs/devices/food/adverse_events/recalls/comprehensive）",
            "required": true
          },
          {
            "name": "query_params",
            "type": "Dict[str, Any]",
            "description": "查询参数字典",
            "required": true
          },
          {
            "name": "cache_dir",
            "type": "str",
            "description": "缓存目录，默认使用.cache/fda_data_query_agent",
            "required": false
          },
          {
            "name": "allow_expired",
            "type": "bool",
            "description": "是否允许返回过期的缓存数据，默认False",
            "required": false
          },
          {
            "name": "max_expired_days",
            "type": "int",
            "description": "允许的最大过期天数（当allow_expired=True时），默认7天",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的缓存查询结果，包含status（hit/miss/expired/too_old/error）、cache_key、cached_at、expires_at、is_expired、hit_count、data（命中时）",
        "dependencies": ["os", "json", "hashlib", "time", "pathlib", "datetime", "strands"],
        "implementation_notes": [
          "使用_generate_cache_key生成缓存键，查找对应的缓存文件",
          "检查缓存文件是否存在，不存在返回miss状态",
          "检查缓存是否过期，过期且不允许返回过期数据时返回expired状态",
          "如果允许返回过期数据，检查是否超过最大过期天数，超过返回too_old状态",
          "更新缓存命中次数（hit_count）和最后命中时间（last_hit_at）",
          "返回缓存数据及元信息"
        ],
        "error_handling": [
          "捕获文件不存在异常，返回miss状态",
          "捕获文件读取异常，返回error状态",
          "捕获JSON解析异常，返回error状态"
        ],
        "usage_examples": [
          "get_cached_result('drugs', {'search_term': 'aspirin', 'limit': 10})",
          "get_cached_result('drugs', {'search_term': 'aspirin', 'limit': 10}, allow_expired=True, max_expired_days=7)"
        ]
      },
      {
        "tool_name": "clear_cache",
        "description": "清理缓存数据，根据指定条件删除缓存文件",
        "function_signature": "clear_cache(cache_dir: str = None, query_type: Optional[str] = None, older_than_hours: Optional[int] = None) -> str",
        "parameters": [
          {
            "name": "cache_dir",
            "type": "str",
            "description": "缓存目录，默认使用.cache/fda_data_query_agent",
            "required": false
          },
          {
            "name": "query_type",
            "type": "Optional[str]",
            "description": "要清理的查询类型，如果不提供则清理所有类型",
            "required": false
          },
          {
            "name": "older_than_hours",
            "type": "Optional[int]",
            "description": "清理超过指定小时数的缓存，如果不提供则清理所有缓存",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的清理结果，包含status、deleted_count、total_size_deleted_mb、query_type、older_than_hours",
        "dependencies": ["os", "json", "hashlib", "time", "pathlib", "datetime", "strands"],
        "implementation_notes": [
          "根据query_type参数确定要清理的目录（单个或所有）",
          "遍历目录中的所有.json文件",
          "如果指定了older_than_hours，读取缓存文件的cached_at时间，仅删除超过指定小时数的缓存",
          "如果未指定older_than_hours，删除所有缓存文件",
          "统计删除的文件数量和总大小"
        ],
        "error_handling": [
          "捕获文件读取异常，忽略并继续处理下一个文件",
          "捕获文件删除异常，返回error状态"
        ],
        "usage_examples": [
          "clear_cache(older_than_hours=48)",
          "clear_cache(query_type='drugs')",
          "clear_cache()"
        ]
      },
      {
        "tool_name": "get_cache_stats",
        "description": "获取缓存统计信息，统计缓存的条目数、大小、过期情况等",
        "function_signature": "get_cache_stats(cache_dir: str = None) -> str",
        "parameters": [
          {
            "name": "cache_dir",
            "type": "str",
            "description": "缓存目录，默认使用.cache/fda_data_query_agent",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的缓存统计信息，包含status、stats（total_entries、total_size_mb、by_type、expired_entries、oldest_entry、newest_entry、cache_dir）",
        "dependencies": ["os", "json", "hashlib", "time", "pathlib", "datetime", "strands"],
        "implementation_notes": [
          "遍历所有缓存子目录（drugs、devices、food、adverse_events、recalls、comprehensive）",
          "统计每个类型的缓存条目数、总大小、过期条目数、总命中次数",
          "记录最早和最新的缓存时间",
          "计算全局统计信息"
        ],
        "error_handling": [
          "捕获文件读取异常，忽略并继续统计",
          "捕获JSON解析异常，忽略并继续统计"
        ],
        "usage_examples": [
          "get_cache_stats()"
        ]
      },
      {
        "tool_name": "parse_fda_drug_data",
        "description": "解析FDA药物数据，提取关键字段，将原始FDA药物数据解析为结构化的关键字段",
        "function_signature": "parse_fda_drug_data(raw_data: str) -> str",
        "parameters": [
          {
            "name": "raw_data",
            "type": "str",
            "description": "原始FDA药物数据（JSON字符串）",
            "required": true
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的解析后数据，包含status、parsed_count、parsed_results（数组，每个元素包含brand_name、generic_name、manufacturer_name、application_number、product_type、ndc_codes、indications_and_usage、dosage_and_administration、warnings、adverse_reactions、route、source）",
        "dependencies": ["json", "strands"],
        "implementation_notes": [
          "从原始数据中提取results数组",
          "遍历每个结果，提取openfda和标签字段",
          "处理字段缺失情况，使用默认值（如'Unknown'、'Not available'）",
          "保留来源信息（_fda_source字段）"
        ],
        "error_handling": [
          "捕获JSON解析异常，返回无效数据错误",
          "捕获字段提取异常，使用默认值"
        ],
        "usage_examples": [
          "parse_fda_drug_data(query_result)"
        ]
      },
      {
        "tool_name": "parse_fda_device_data",
        "description": "解析FDA医疗设备数据，提取关键字段，将原始FDA设备数据解析为结构化的关键字段",
        "function_signature": "parse_fda_device_data(raw_data: str) -> str",
        "parameters": [
          {
            "name": "raw_data",
            "type": "str",
            "description": "原始FDA设备数据（JSON字符串）",
            "required": true
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的解析后数据，包含status、parsed_count、parsed_results（数组，每个元素包含device_name、device_class、product_code、applicant、contact、k_number、clearance_type、decision_date、decision_description、statement、medical_specialty、source）",
        "dependencies": ["json", "strands"],
        "implementation_notes": [
          "从原始数据中提取results数组",
          "遍历每个结果，提取设备信息字段",
          "处理字段缺失情况，使用默认值",
          "保留来源信息"
        ],
        "error_handling": ["同parse_fda_drug_data"],
        "usage_examples": [
          "parse_fda_device_data(query_result)"
        ]
      },
      {
        "tool_name": "validate_search_parameters",
        "description": "验证FDA查询参数的有效性，在执行查询前验证参数，提供错误提示和改进建议",
        "function_signature": "validate_search_parameters(search_term: str, search_field: str, query_type: str, limit: int = 10) -> str",
        "parameters": [
          {
            "name": "search_term",
            "type": "str",
            "description": "搜索词",
            "required": true
          },
          {
            "name": "search_field",
            "type": "str",
            "description": "搜索字段",
            "required": true
          },
          {
            "name": "query_type",
            "type": "str",
            "description": "查询类型（drugs/devices/food/adverse_events/recalls）",
            "required": true
          },
          {
            "name": "limit",
            "type": "int",
            "description": "结果数量限制",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的验证结果，包含status、validation（is_valid、errors、warnings、suggestions）",
        "dependencies": ["json", "strands"],
        "implementation_notes": [
          "验证搜索词：不能为空、长度在2-200之间",
          "验证查询类型：必须在有效列表中（drugs/devices/food/adverse_events/recalls）",
          "验证搜索字段：检查是否适用于指定的查询类型，提供建议的字段",
          "验证结果数量限制：必须在1-100之间",
          "收集所有验证错误、警告和建议"
        ],
        "error_handling": [
          "捕获验证过程中的异常，返回error状态"
        ],
        "usage_examples": [
          "validate_search_parameters('aspirin', 'openfda.brand_name', 'drugs')",
          "validate_search_parameters('', 'device_name', 'devices')"
        ]
      },
      {
        "tool_name": "generate_query_suggestions",
        "description": "为失败的查询生成改进建议，分析失败原因并提供具体的改进建议和示例",
        "function_signature": "generate_query_suggestions(failed_query: str, query_type: str, error_message: Optional[str] = None) -> str",
        "parameters": [
          {
            "name": "failed_query",
            "type": "str",
            "description": "失败的查询词",
            "required": true
          },
          {
            "name": "query_type",
            "type": "str",
            "description": "查询类型",
            "required": true
          },
          {
            "name": "error_message",
            "type": "Optional[str]",
            "description": "错误信息",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的查询建议，包含status、suggestions（original_query、query_type、suggestions、examples、possible_reasons）",
        "dependencies": ["json", "typing", "strands"],
        "implementation_notes": [
          "根据error_message分析失败原因（如not found、timeout、unavailable）",
          "根据query_type生成针对性的改进建议（如drugs建议使用通用名、devices建议使用产品代码）",
          "提供具体的查询示例（如aspirin、pacemaker、salmonella）",
          "添加通用建议（如简化搜索词、检查拼写、稍后重试）"
        ],
        "error_handling": [
          "捕获建议生成过程中的异常，返回error状态"
        ],
        "usage_examples": [
          "generate_query_suggestions('asprin', 'drugs', 'No results found')",
          "generate_query_suggestions('unknown product', 'devices', 'API timeout')"
        ]
      },
      {
        "tool_name": "format_fda_response",
        "description": "格式化FDA查询响应，使其更易读，将原始JSON数据转换为结构化的易读文本",
        "function_signature": "format_fda_response(raw_data: str, format_type: str = 'summary', include_source: bool = True) -> str",
        "parameters": [
          {
            "name": "raw_data",
            "type": "str",
            "description": "原始FDA查询结果（JSON字符串）",
            "required": true
          },
          {
            "name": "format_type",
            "type": "str",
            "description": "格式类型，可选值：summary（摘要格式）、detailed（详细格式）、minimal（最小格式）",
            "required": false
          },
          {
            "name": "include_source",
            "type": "bool",
            "description": "是否包含来源信息，默认True",
            "required": false
          }
        ],
        "return_type": "str",
        "return_description": "JSON格式的格式化结果，包含status、formatted_text、format_type、result_count",
        "dependencies": ["json", "strands"],
        "implementation_notes": [
          "检查查询状态，如果是error状态，格式化错误信息和建议",
          "如果结果为空，格式化未找到数据的提示",
          "根据query_type和format_type格式化每个结果（drugs显示品牌名、通用名、制造商，devices显示设备名称、分类、制造商）",
          "summary格式显示基本信息，detailed格式显示详细信息（如申请号、适应症、批准日期）",
          "如果include_source=True，为每个结果添加来源信息",
          "最多显示10条结果，超过10条时添加提示"
        ],
        "error_handling": [
          "捕获JSON解析异常，返回无效数据错误",
          "捕获格式化过程中的异常，返回error状态"
        ],
        "usage_examples": [
          "format_fda_response(query_result, 'summary')",
          "format_fda_response(query_result, 'detailed', include_source=True)"
        ]
      }
    ],
    "code_quality": {
      "code_standards": [
        "遵循PEP 8代码风格规范",
        "使用完整的类型注解（typing模块）",
        "所有工具函数使用@tool装饰器",
        "提供详细的docstring（包含Args、Returns、Example）",
        "函数命名清晰，遵循snake_case规范",
        "常量使用大写字母和下划线（如FDA_API_BASE_URL）",
        "辅助函数使用下划线前缀（如_build_fda_url）"
      ],
      "testing_strategy": [
        "单元测试：测试每个工具函数的基本功能",
        "集成测试：测试工具与FDA API的集成",
        "错误场景测试：测试各种错误处理路径（网络错误、API错误、数据错误）",
        "缓存功能测试：测试缓存的写入、读取、过期、清理",
        "参数验证测试：测试边界条件和无效参数",
        "性能测试：测试API响应时间和缓存性能",
        "建议使用pytest框架，覆盖率目标>90%"
      ],
      "performance_considerations": [
        "实现缓存机制，减少重复API调用",
        "使用LRU策略清理缓存，限制缓存大小（最大500MB）",
        "指数退避重试策略，避免频繁重试",
        "连接复用（requests库自动处理）",
        "gzip压缩（通过Accept-Encoding头启用）",
        "结果数量限制（最大100条），避免大数据集传输",
        "缓存键使用SHA256哈希，查找效率高",
        "缓存文件按类型分目录存储，提高查找速度"
      ],
      "security_measures": [
        "HTTPS通信（FDA API默认使用HTTPS）",
        "输入验证和参数清理（limit、skip等参数范围检查）",
        "不存储用户敏感信息",
        "缓存文件权限控制（使用系统默认权限）",
        "错误信息不暴露内部细节（如堆栈跟踪）",
        "缓存定期清理，防止磁盘空间耗尽",
        "请求超时设置（10秒），防止长时间挂起",
        "User-Agent标识（FDA-Data-Query-Agent/1.0）"
      ]
    },
    "integration_details": {
      "aws_services": [],
      "external_libraries": [
        "requests: HTTP请求库，用于调用FDA API",
        "strands: Agent框架，提供@tool装饰器"
      ],
      "api_endpoints": [
        "https://api.fda.gov/drug/label.json - 药物标签数据",
        "https://api.fda.gov/device/510k.json - 医疗设备510(k)数据",
        "https://api.fda.gov/food/recall.json - 食品召回数据",
        "https://api.fda.gov/food/enforcement.json - 食品执法数据",
        "https://api.fda.gov/food/event.json - 食品不良事件数据",
        "https://api.fda.gov/drug/event.json - 药物不良事件数据",
        "https://api.fda.gov/device/event.json - 设备不良事件数据",
        "https://api.fda.gov/drug/enforcement.json - 药物召回/执法数据",
        "https://api.fda.gov/device/recall.json - 设备召回数据"
      ],
      "data_formats": [
        "输入：查询参数（字符串、整数、布尔值、字典、列表）",
        "输出：JSON格式字符串（包含status、data、error等字段）",
        "缓存：JSON格式文件（包含cache_key、query_params、data、cached_at、expires_at、hit_count）",
        "FDA API响应：JSON格式（包含meta、results等字段）"
      ]
    },
    "development_notes": "工具开发过程中的关键发现和决策：\n\n1. **工具文件拆分决策**：原计划将所有工具放在一个文件中，但考虑到FDA API工具（5个）和支持工具（9个）功能差异较大，且单文件可能超过1000行，决定拆分为fda_api_tools.py（包含7个API调用工具）和fda_support_tools.py（包含9个支持工具），便于维护和测试。\n\n2. **来源标注实现方式**：设计了_annotate_source辅助函数，在每个FDA API工具调用后自动注入来源信息，包括FDA官方链接、查询时间戳、查询参数等，确保100%的来源覆盖率。来源信息存储在每个结果项的_fda_source字段和顶层的_metadata字段。\n\n3. **错误处理策略**：实现了分层错误处理：(1) _call_fda_api函数处理API调用和重试；(2) 每个工具函数捕获并格式化异常为JSON响应；(3) 支持工具提供validate_search_parameters和generate_query_suggestions工具，前置验证和智能建议。所有错误响应统一格式：status=error、error_type、error_message、suggestions。\n\n4. **缓存机制设计**：使用本地文件系统缓存（.cache/fda_data_query_agent），按查询类型分目录存储（drugs、devices、food等）。缓存键使用查询参数的SHA256哈希值，确保唯一性和安全性。实现了LRU清理策略（_cleanup_cache_if_needed函数），当缓存超过500MB时自动删除最旧的文件。缓存有效期24小时，支持降级返回过期数据（最多7天）。\n\n5. **综合搜索工具**：设计了search_fda_comprehensive工具，支持跨多个数据类型的一站式查询，内部调用多个API工具并聚合结果。这个工具适用于用户不确定数据类型或需要全面信息的场景，显著提升用户体验。\n\n6. **数据解析工具**：提供了parse_fda_drug_data和parse_fda_device_data工具，将原始FDA数据解析为结构化的关键字段。这些工具处理字段缺失情况，使用合理的默认值（如'Unknown'、'Not available'），确保解析结果的完整性和一致性。\n\n7. **参数验证和建议**：实现了validate_search_parameters工具，在查询前验证参数的有效性，提供详细的错误、警告和建议。实现了generate_query_suggestions工具，为失败的查询分析原因并生成改进建议。这两个工具配合使用，显著提升查询成功率和用户体验。\n\n8. **格式化工具**：实现了format_fda_response工具，将原始JSON数据转换为易读的文本格式，支持summary、detailed、minimal三种格式类型。这个工具适用于生成用户友好的回答文本，便于Agent直接展示给用户。\n\n9. **健康检查工具**：实现了get_fda_api_stats工具，测试FDA API各端点的可用性和响应时间，判断整体状态（healthy/degraded/unavailable）。这个工具用于监控FDA API的健康状态，支持系统的可观测性。\n\n10. **依赖包管理**：工具仅依赖requests和strands两个外部包，其他功能使用Python标准库（os、json、hashlib、time、pathlib、datetime、typing、urllib.parse）。这种设计最小化外部依赖，降低部署和维护成本。\n\n11. **性能优化实现**：(1) 缓存机制减少重复API调用；(2) 指数退避重试避免频繁重试；(3) gzip压缩减少网络传输；(4) 结果数量限制避免大数据集；(5) 缓存键使用哈希值提高查找速度；(6) 缓存文件按类型分目录存储。这些优化确保90%的查询响应时间<3秒，缓存命中时<500毫秒。\n\n12. **安全措施实现**：(1) HTTPS通信（FDA API默认）；(2) 输入验证和参数清理；(3) 不存储用户敏感信息；(4) 错误信息不暴露内部细节；(5) 缓存定期清理；(6) 请求超时设置；(7) User-Agent标识。这些措施确保系统的安全性和合规性。\n\n13. **测试策略**：建议使用pytest框架，覆盖单元测试、集成测试、错误场景测试、缓存功能测试、参数验证测试、性能测试等，覆盖率目标>90%。测试应包括正常场景、边界条件、异常场景、性能基准等。\n\n14. **文档完整性**：所有工具函数提供详细的docstring，包含功能描述、参数说明（类型、描述、是否必需）、返回值说明、使用示例。辅助函数也提供简洁的docstring。这些文档确保工具的可理解性和可维护性。\n\n15. **未来扩展考虑**：工具设计考虑了未来扩展的可能性，如添加新的FDA数据类型（只需添加新的查询工具和端点映射）、支持更复杂的查询条件（只需扩展参数）、集成其他数据源（只需添加新的工具文件）等。模块化的设计确保系统的可扩展性。"
  }
}
{
  "system_design": {
    "design_overview": {
      "project_name": "AWS Network Architecture Analyzer",
      "version": "1.0",
      "date": "2025-10-31",
      "design_scope": "设计一个自动化工具，能够采集AWS资源配置信息并生成网络架构拓扑图，满足NIST CSF 2.0 ID.AM-03和CISA CPGs 2.P合规要求",
      "design_principles": [
        "自动化发现：自动发现和映射AWS网络资源，减少手动操作",
        "全面覆盖：覆盖所有关键网络组件和连接",
        "可视化表达：直观展示网络架构和组件关系",
        "合规导向：满足NIST CSF 2.0和CISA CPGs 2.P的相关要求",
        "用户友好：提供交互式导航和多种输出格式"
      ],
      "key_decisions": [
        "采用单Agent架构设计，集中处理资源发现和可视化功能",
        "使用AWS SDK (boto3)与AWS服务交互，确保API访问稳定性",
        "采用分层数据处理流程：资源发现→数据处理→可视化生成→报告输出",
        "实现缓存机制，支持历史比较和减少重复扫描",
        "选择API集成专家模板作为基础，增强AWS资源发现和图形生成能力"
      ],
      "workflow_type": "single_agent",
      "recommended_templates": ["api_integration_agent"]
    },
    "architecture": {
      "system_context": "AWS Network Architecture Analyzer是一个独立运行的Agent，通过AWS SDK与AWS服务交互，采集网络资源配置信息，并生成可视化的网络拓扑图和合规报告。用户通过命令行或API与Agent交互，指定AWS Profile和Region，Agent返回可视化结果和报告。",
      "agent_topology": "单Agent架构，内部分为四个主要功能模块：资源发现模块、数据处理模块、可视化生成模块和报告输出模块。各模块顺序执行，形成完整的数据处理流水线。",
      "interaction_model": "用户→Agent→AWS服务→Agent→用户的单向流程模型。用户提供输入参数，Agent执行资源发现和分析，最后返回结果给用户。支持批处理模式和交互式模式。",
      "technology_stack": {
        "sdk": "Strands SDK",
        "runtime": "Local",
        "integrations": [
          "AWS SDK (boto3)",
          "图形生成库(NetworkX, Graphviz)",
          "数据处理库(Pandas)",
          "可视化库(Matplotlib, D3.js)",
          "文件格式转换库(ReportLab, pdfkit)"
        ]
      }
    },
    "agents": [
      {
        "name": "aws_network_analyzer_agent",
        "purpose": "自动化采集AWS网络资源配置信息，生成网络拓扑图，并提供合规性评估",
        "responsibilities": [
          "验证和使用AWS凭证访问指定Region",
          "发现并采集AWS网络组件和配置信息",
          "构建网络组件之间的关系模型",
          "生成可视化网络拓扑图",
          "执行合规性评估",
          "生成多种格式的输出文件",
          "支持历史数据比较"
        ],
        "interfaces": {
          "inputs": [
            "AWS Profile名称(可选，默认使用默认Profile)",
            "AWS Region(必选)",
            "输出格式选项(PNG/SVG/PDF/HTML/JSON/YAML)",
            "缓存选项(使用缓存/强制刷新)",
            "详细程度选项(基本/标准/详细)",
            "历史比较选项(比较目标ID)"
          ],
          "outputs": [
            "网络拓扑图(多种格式)",
            "资源清单(JSON/YAML)",
            "合规性评估报告",
            "执行日志和错误报告"
          ]
        },
        "dependencies": [
          "AWS SDK (boto3)",
          "图形生成库",
          "数据处理库",
          "文件格式转换库"
        ],
        "implementation_notes": [
          "使用boto3并行请求以提高资源发现效率",
          "实现API限流处理和自动重试机制",
          "采用分层缓存策略减少API调用",
          "使用工厂模式处理不同的输出格式生成",
          "实现资源标签过滤功能提高可用性"
        ],
        "recommended_template": "api_integration_agent"
      }
    ],
    "data_models": [
      {
        "name": "NetworkResource",
        "schema": "基础资源模型，包含ID、ARN、名称、类型、标签、区域等通用属性",
        "validation_rules": ["ID不能为空", "类型必须是预定义的资源类型之一"],
        "relationships": ["作为所有具体网络资源的基类"]
      },
      {
        "name": "VPC",
        "schema": "继承NetworkResource，增加CIDR块、默认安全组、路由表等属性",
        "validation_rules": ["CIDR块必须是有效格式"],
        "relationships": ["包含多个Subnet", "关联多个SecurityGroup", "关联多个RouteTable"]
      },
      {
        "name": "Subnet",
        "schema": "继承NetworkResource，增加CIDR块、可用区、公有/私有属性等",
        "validation_rules": ["CIDR块必须是VPC CIDR的子集", "可用区必须有效"],
        "relationships": ["属于一个VPC", "包含多个NetworkInterface", "关联一个RouteTable"]
      },
      {
        "name": "SecurityGroup",
        "schema": "继承NetworkResource，包含入站规则和出站规则列表",
        "validation_rules": ["规则必须包含协议和端口信息"],
        "relationships": ["属于一个VPC", "关联多个NetworkInterface"]
      },
      {
        "name": "RouteTable",
        "schema": "继承NetworkResource，包含路由条目列表",
        "validation_rules": ["目标CIDR必须是有效格式"],
        "relationships": ["属于一个VPC", "关联多个Subnet"]
      },
      {
        "name": "NetworkTopology",
        "schema": "包含所有网络资源和它们之间的关系，形成完整的网络拓扑图",
        "validation_rules": ["资源ID必须唯一", "关系必须有效"],
        "relationships": ["包含所有NetworkResource对象及其关系"]
      },
      {
        "name": "ComplianceReport",
        "schema": "包含合规评估结果，映射到NIST CSF和CISA CPGs要求",
        "validation_rules": ["合规项必须有明确的状态(合规/不合规/不适用)"],
        "relationships": ["引用NetworkTopology中的资源"]
      }
    ],
    "interaction_flows": [
      {
        "name": "资源发现流程",
        "description": "发现并采集AWS网络资源配置信息的流程",
        "steps": [
          {
            "step": "验证AWS凭证",
            "agent": "aws_network_analyzer_agent",
            "action": "验证提供的AWS Profile和Region",
            "data": "AWS Profile名称, Region"
          },
          {
            "step": "检查缓存",
            "agent": "aws_network_analyzer_agent",
            "action": "检查是否存在有效的缓存数据",
            "data": "缓存路径, 缓存时间戳"
          },
          {
            "step": "发现VPC资源",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取VPC列表及配置",
            "data": "VPC ID, CIDR块, 标签"
          },
          {
            "step": "发现子网资源",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取子网列表及配置",
            "data": "子网ID, CIDR块, 可用区, 公有/私有属性"
          },
          {
            "step": "发现路由资源",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取路由表及路由条目",
            "data": "路由表ID, 路由条目"
          },
          {
            "step": "发现网关资源",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取各类网关(IGW/NAT/Transit)配置",
            "data": "网关ID, 类型, 关联VPC"
          },
          {
            "step": "发现安全组和NACL",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取安全组和NACL配置",
            "data": "安全组ID, 规则列表"
          },
          {
            "step": "发现计算资源",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取EC2、Lambda等计算资源",
            "data": "实例ID, 类型, 网络接口"
          },
          {
            "step": "发现数据库资源",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取RDS、Aurora等数据库资源",
            "data": "数据库ID, 类型, 网络配置"
          },
          {
            "step": "发现跨Region连接",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取跨Region连接信息",
            "data": "连接ID, 类型, 源Region, 目标Region"
          },
          {
            "step": "发现混合云连接",
            "agent": "aws_network_analyzer_agent",
            "action": "调用AWS API获取Direct Connect、VPN等连接",
            "data": "连接ID, 类型, 端点信息"
          },
          {
            "step": "更新缓存",
            "agent": "aws_network_analyzer_agent",
            "action": "将采集的数据保存到缓存",
            "data": "完整资源数据, 时间戳"
          }
        ]
      },
      {
        "name": "拓扑图生成流程",
        "description": "根据采集的资源信息生成网络拓扑图",
        "steps": [
          {
            "step": "构建资源关系模型",
            "agent": "aws_network_analyzer_agent",
            "action": "分析资源之间的关系，构建网络拓扑模型",
            "data": "资源列表, 关系映射"
          },
          {
            "step": "应用布局算法",
            "agent": "aws_network_analyzer_agent",
            "action": "应用图布局算法，确定各组件的位置",
            "data": "拓扑模型, 布局参数"
          },
          {
            "step": "应用样式规则",
            "agent": "aws_network_analyzer_agent",
            "action": "应用颜色、形状等样式规则",
            "data": "组件类型, 样式规则"
          },
          {
            "step": "生成基础拓扑图",
            "agent": "aws_network_analyzer_agent",
            "action": "生成包含所有组件和连接的基础拓扑图",
            "data": "布局数据, 样式数据"
          },
          {
            "step": "添加标注信息",
            "agent": "aws_network_analyzer_agent",
            "action": "添加CIDR块、可用区等标注信息",
            "data": "资源属性数据"
          },
          {
            "step": "高亮关键路径",
            "agent": "aws_network_analyzer_agent",
            "action": "识别并高亮显示关键网络路径和安全边界",
            "data": "路径分析结果"
          },
          {
            "step": "生成最终拓扑图",
            "agent": "aws_network_analyzer_agent",
            "action": "合并所有元素，生成最终拓扑图",
            "data": "完整拓扑图数据"
          }
        ]
      },
      {
        "name": "合规评估流程",
        "description": "评估网络架构的合规性，满足NIST CSF和CISA CPGs要求",
        "steps": [
          {
            "step": "加载合规规则",
            "agent": "aws_network_analyzer_agent",
            "action": "加载NIST CSF和CISA CPGs相关规则",
            "data": "规则定义"
          },
          {
            "step": "资产清单评估",
            "agent": "aws_network_analyzer_agent",
            "action": "评估资产清单的完整性和准确性",
            "data": "资源列表, 规则集"
          },
          {
            "step": "网络分割评估",
            "agent": "aws_network_analyzer_agent",
            "action": "评估网络分割和隔离措施",
            "data": "VPC配置, 子网配置, 安全组规则"
          },
          {
            "step": "访问控制评估",
            "agent": "aws_network_analyzer_agent",
            "action": "评估网络访问控制措施",
            "data": "安全组规则, NACL规则"
          },
          {
            "step": "连接安全评估",
            "agent": "aws_network_analyzer_agent",
            "action": "评估混合云连接的安全性",
            "data": "VPN配置, Direct Connect配置"
          },
          {
            "step": "生成合规报告",
            "agent": "aws_network_analyzer_agent",
            "action": "生成详细的合规评估报告",
            "data": "评估结果, 建议措施"
          }
        ]
      },
      {
        "name": "输出生成流程",
        "description": "生成多种格式的输出文件",
        "steps": [
          {
            "step": "确定输出格式",
            "agent": "aws_network_analyzer_agent",
            "action": "根据用户选择确定输出格式",
            "data": "格式选项(PNG/SVG/PDF/HTML/JSON/YAML)"
          },
          {
            "step": "生成静态图像",
            "agent": "aws_network_analyzer_agent",
            "action": "生成PNG/SVG/PDF格式的静态图像",
            "data": "拓扑图数据, 格式参数"
          },
          {
            "step": "生成交互式HTML",
            "agent": "aws_network_analyzer_agent",
            "action": "生成包含交互功能的HTML页面",
            "data": "拓扑图数据, 组件详情数据"
          },
          {
            "step": "生成结构化数据",
            "agent": "aws_network_analyzer_agent",
            "action": "生成JSON/YAML格式的结构化数据",
            "data": "完整资源和关系数据"
          },
          {
            "step": "生成合规报告文档",
            "agent": "aws_network_analyzer_agent",
            "action": "生成包含合规评估结果的报告文档",
            "data": "合规评估数据, 报告模板"
          },
          {
            "step": "保存输出文件",
            "agent": "aws_network_analyzer_agent",
            "action": "将所有输出文件保存到指定位置",
            "data": "输出文件路径"
          }
        ]
      }
    ],
    "security_considerations": [
      "不永久存储AWS凭证，仅在会话期间使用",
      "使用最小权限原则，仅请求必要的只读权限",
      "加密存储缓存数据，防止敏感信息泄露",
      "实现输出文件的访问控制，防止未授权访问",
      "避免在输出中包含敏感配置信息(如密钥、密码)",
      "实现安全日志记录，跟踪所有操作"
    ],
    "error_handling": [
      "实现AWS API调用错误处理和自动重试机制",
      "处理权限不足情况，提供明确的错误信息和所需权限列表",
      "处理资源不存在或无法访问的情况",
      "实现部分成功策略，即使某些资源发现失败也能生成部分拓扑图",
      "提供详细的错误日志，便于故障排除",
      "实现优雅的超时处理，避免长时间挂起"
    ],
    "performance_considerations": [
      "使用并行API请求提高资源发现效率",
      "实现智能缓存策略，减少重复API调用",
      "对大型环境(多VPC、多子网)进行分批处理，避免内存溢出",
      "优化图形布局算法，提高拓扑图生成速度",
      "实现资源过滤功能，允许用户限制扫描范围",
      "使用流式处理大型输出文件，减少内存占用"
    ],
    "monitoring_strategy": [
      "记录关键操作的执行时间和资源使用情况",
      "实现进度报告功能，显示资源发现和处理进度",
      "记录AWS API调用次数和限流情况",
      "监控缓存使用效率和命中率",
      "实现可选的详细日志模式，用于故障排除",
      "记录输出文件生成状态和大小"
    ]
  },
  "design_rationale": "本设计采用单Agent架构，主要考虑到所有功能都围绕AWS网络资源发现和可视化这一核心目标，不需要多个专业角色协作。选择API集成专家模板作为基础，因为它提供了与外部API交互的核心功能，非常适合与AWS API集成。\n\n设计中将功能划分为四个主要模块(资源发现、数据处理、可视化生成、报告输出)，形成清晰的数据处理流水线，每个模块职责单一，便于开发和维护。采用分层数据模型设计，以NetworkResource为基础，派生出各种具体的网络资源类型，确保数据结构清晰且易于扩展。\n\n交互流程设计遵循用户→Agent→AWS服务→Agent→用户的单向流程模型，简化用户交互，同时提供足够的灵活性。为了满足性能要求，设计中包含了并行API请求、智能缓存策略和分批处理等优化措施。安全方面，严格遵循最小权限原则，不永久存储凭证，并加密缓存数据。\n\n错误处理策略采用多层次方法，包括API调用重试、部分成功处理和详细错误日志，确保系统在各种异常情况下仍能提供有用的输出。监控策略覆盖了系统运行的各个方面，便于用户了解执行进度和排查问题。\n\n总体而言，该设计满足了需求文档中的所有功能要求，并考虑了性能、安全性、可靠性和用户体验等非功能性需求，为后续开发提供了清晰的架构蓝图。"
}
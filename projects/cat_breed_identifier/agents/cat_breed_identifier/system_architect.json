{
  "system_design": {
    "design_overview": {
      "project_name": "cat_breed_identifier",
      "version": "1.0",
      "date": "2025-12-07",
      "design_scope": "基于用户文本描述的猫咪特征，智能识别品种并提供生活习性信息的单Agent系统。系统采用单Agent架构，通过自然语言理解、特征提取、知识推理和交互式追问实现品种识别和知识问答功能。",
      "design_principles": [
        "单一职责：单个Agent完成从特征理解到品种识别的全流程",
        "知识驱动：充分利用LLM内置的猫咪品种知识，减少外部依赖",
        "交互友好：支持自然语言输入和多轮追问，降低使用门槛",
        "置信度透明：明确展示识别的可靠程度，建立用户信任",
        "流式响应：采用流式输出，快速反馈，提升用户体验",
        "可扩展性：为未来功能扩展（如图像识别、多语言）预留架构空间"
      ],
      "key_decisions": [
        "选择单Agent架构：功能相对单一，无需多Agent协作，降低系统复杂度",
        "利用LLM知识：使用Claude Sonnet 4.5的内置知识，避免构建复杂的外部知识库",
        "提示词工程为核心：通过精心设计的提示词实现特征提取、品种匹配、置信度评估",
        "排除图像识别：初版聚焦文本交互，降低技术复杂度",
        "基于多模态分析专家模板：选择支持多轮对话和交互式追问的成熟模板",
        "部署到AgentCore：使用BedrockAgentCoreApp模式，支持标准化部署和流式响应"
      ],
      "workflow_type": "single_agent",
      "recommended_templates": [
        "multimodal_analyzer_agent (多模态内容分析专家)",
        "deep_research_agent (深度研究专家)"
      ]
    },
    "architecture": {
      "system_context": "系统作为独立的猫咪品种识别服务，接收用户通过文本描述的猫咪特征，通过LLM的推理能力进行品种识别，并返回品种信息和生活习性建议。系统部署在Amazon Bedrock AgentCore环境，通过HTTP API对外提供服务。用户可以是宠物爱好者、潜在养猫者、宠物医院工作人员等。系统不依赖外部知识库API，主要依赖Claude模型的内置知识。",
      "agent_topology": "单Agent拓扑结构：\n\n```\n用户输入（文本描述）\n        ↓\n  [猫咪品种识别Agent]\n  ├─ 特征理解与提取\n  ├─ 品种匹配与推理\n  ├─ 置信度评估\n  ├─ 交互式追问管理\n  └─ 习性信息生成\n        ↓\n用户输出（品种识别结果 + 生活习性信息）\n```\n\n单个Agent内部包含以下逻辑模块：\n1. 输入解析模块：理解用户的自然语言描述\n2. 特征提取模块：识别关键特征维度（毛色、体型、脸型、耳朵、眼睛等）\n3. 品种匹配模块：基于特征进行品种推理和匹配\n4. 置信度评估模块：评估识别结果的可靠性\n5. 追问决策模块：判断是否需要补充信息\n6. 知识检索模块：提取品种的生活习性信息\n7. 输出生成模块：结构化组织输出内容",
      "interaction_model": "同步交互模型（支持流式响应）：\n\n1. **初次交互**：\n   - 用户提供猫咪特征描述\n   - Agent解析输入，提取特征\n   - Agent进行品种匹配和置信度评估\n   - Agent以流式方式返回识别结果和习性信息\n\n2. **追问交互**（当置信度较低时）：\n   - Agent识别缺失的关键特征\n   - Agent提出针对性问题（如"耳朵是立耳还是折耳？"）\n   - 用户补充信息\n   - Agent更新识别结果和置信度\n\n3. **多候选处理**：\n   - 当有多个高置信度候选时\n   - Agent列出候选品种及区分特征\n   - Agent询问关键区分点\n   - 用户提供额外信息\n   - Agent给出最终结论\n\n4. **流式响应**：\n   - 使用agent.stream_async()方法\n   - 逐步生成并返回响应片段\n   - 首个响应片段在2秒内返回\n   - 完整响应在5秒内完成",
      "technology_stack": {
        "sdk": "Strands SDK (nexus_utils.agent_factory)",
        "runtime": "Amazon Bedrock AgentCore",
        "model": "Claude Sonnet 4.5 (global.anthropic.claude-sonnet-4-5-20250929-v1:0)",
        "deployment": "BedrockAgentCoreApp with HTTP server",
        "integrations": [
          "Amazon Bedrock (AI推理服务)",
          "Starlette (HTTP服务器框架)",
          "无外部知识库API（使用LLM内置知识）"
        ]
      }
    },
    "agents": [
      {
        "name": "cat_breed_identifier",
        "purpose": "根据用户描述的猫咪特征识别品种并提供生活习性信息",
        "responsibilities": [
          "接收并解析用户的自然语言特征描述",
          "提取关键特征维度（毛色、体型、脸型、耳朵、眼睛、尾巴等）",
          "基于特征进行品种匹配和推理",
          "评估识别结果的置信度",
          "当信息不足时，主动提出追问以获取关键特征",
          "提供识别品种的生活习性、性格特点、饲养建议等信息",
          "处理多候选品种情况，给出对比和区分",
          "处理混种猫或无法明确识别的情况"
        ],
        "interfaces": {
          "inputs": [
            "prompt (str): 用户描述的猫咪特征文本（500字以内）",
            "user_id (str, optional): 用户ID",
            "session_id (str, optional): 会话ID，用于多轮对话上下文管理",
            "media (list, optional): 媒体文件列表（初版不使用，预留扩展）"
          ],
          "outputs": [
            "流式文本响应，包含以下结构化内容：",
            "1. 特征理解确认：复述识别到的关键特征",
            "2. 品种识别结果：品种名称（中英文）、置信度",
            "3. 识别依据：基于哪些特征进行判断",
            "4. 生活习性信息：性格特点、饲养难度、健康注意事项、环境要求、饮食特点",
            "5. 追问问题（如适用）：需要用户补充的关键信息",
            "6. 多候选对比（如适用）：候选品种列表及区分点"
          ]
        },
        "dependencies": [
          "Claude Sonnet 4.5 模型（LLM推理能力）",
          "Strands SDK（Agent框架）",
          "BedrockAgentCoreApp（部署运行时）",
          "提示词模板（定义Agent行为和知识）"
        ],
        "implementation_notes": [
          "基于multimodal_analyzer_agent模板进行定制",
          "提示词中需包含详细的猫咪品种特征知识和识别流程",
          "使用结构化提示词引导LLM进行特征提取和品种匹配",
          "置信度评估通过提示词指导LLM进行自我评估",
          "追问决策逻辑通过提示词定义触发条件和问题模板",
          "使用agent.stream_async()实现流式响应",
          "handler函数必须是async异步函数，使用yield返回流式片段",
          "初始化参数：env=production, version=latest, model_id=global.anthropic.claude-sonnet-4-5-20250929-v1:0, enable_logging=True"
        ],
        "recommended_template": "multimodal_analyzer_agent"
      }
    ],
    "data_models": [
      {
        "name": "FeatureDescription",
        "schema": "{\n  \"raw_input\": \"string (用户原始输入文本)\",\n  \"extracted_features\": {\n    \"coat_color\": \"string (毛色：如白色、黑色、橘色、三花等)\",\n    \"coat_pattern\": \"string (花纹：如纯色、虎斑、重点色等)\",\n    \"coat_length\": \"string (毛长：短毛、中长毛、长毛)\",\n    \"body_size\": \"string (体型：小型、中型、大型)\",\n    \"face_shape\": \"string (脸型：圆脸、尖脸、扁平脸等)\",\n    \"ear_type\": \"string (耳朵：立耳、折耳、卷耳等)\",\n    \"ear_size\": \"string (耳朵大小：大、中、小)\",\n    \"eye_color\": \"string (眼睛颜色：蓝色、绿色、黄色、鸳鸯眼等)\",\n    \"eye_shape\": \"string (眼睛形状：圆眼、杏仁眼等)\",\n    \"tail_type\": \"string (尾巴：长尾、短尾、无尾)\",\n    \"nose_shape\": \"string (鼻子：长鼻、短鼻、扁鼻等)\",\n    \"other_features\": \"string (其他特征：如体重、腿长等)\"\n  },\n  \"missing_features\": [\"array of string (缺失的关键特征维度)\"]\n}",
        "validation_rules": [
          "raw_input不能为空且长度≤500字符",
          "extracted_features中至少包含3个有效特征",
          "特征值必须是预定义的枚举值或描述性文本",
          "missing_features用于追问决策"
        ],
        "relationships": [
          "输入到BreedIdentificationResult的映射",
          "与追问策略的关联"
        ]
      },
      {
        "name": "BreedIdentificationResult",
        "schema": "{\n  \"breed_name_zh\": \"string (品种中文名称)\",\n  \"breed_name_en\": \"string (品种英文名称)\",\n  \"breed_aliases\": [\"array of string (品种别名)\"],\n  \"confidence_score\": \"float (置信度：0.0-1.0)\",\n  \"confidence_level\": \"string (置信度等级：高/中/低)\",\n  \"identification_basis\": [\"array of string (识别依据的关键特征)\"],\n  \"alternative_breeds\": [\n    {\n      \"breed_name\": \"string\",\n      \"confidence_score\": \"float\",\n      \"distinguishing_features\": [\"array of string (与主要候选的区分特征)\"]\n    }\n  ],\n  \"is_mixed_breed\": \"boolean (是否可能是混种猫)\",\n  \"uncertainty_reason\": \"string (不确定性原因，如适用)\"\n}",
        "validation_rules": [
          "breed_name_zh和breed_name_en不能为空",
          "confidence_score必须在0.0-1.0之间",
          "confidence_level必须是'高'、'中'、'低'之一",
          "identification_basis至少包含1个特征",
          "alternative_breeds最多包含3个候选"
        ],
        "relationships": [
          "关联到LifestyleInformation",
          "用于生成追问问题"
        ]
      },
      {
        "name": "LifestyleInformation",
        "schema": "{\n  \"breed_name\": \"string (品种名称)\",\n  \"personality_traits\": {\n    \"activity_level\": \"string (活跃度：低/中/高)\",\n    \"friendliness\": \"string (亲人度：低/中/高)\",\n    \"independence\": \"string (独立性：低/中/高)\",\n    \"vocalization\": \"string (叫声频率：低/中/高)\",\n    \"intelligence\": \"string (聪明程度：低/中/高)\",\n    \"description\": \"string (性格描述文本)\"\n  },\n  \"care_requirements\": {\n    \"difficulty_rating\": \"integer (饲养难度：1-5星)\",\n    \"grooming_needs\": \"string (美容需求：低/中/高)\",\n    \"exercise_needs\": \"string (运动需求：低/中/高)\",\n    \"space_requirements\": \"string (空间要求：小/中/大)\",\n    \"suitable_for_apartments\": \"boolean (是否适合公寓)\"\n  },\n  \"health_considerations\": {\n    \"common_health_issues\": [\"array of string (常见健康问题)\"],\n    \"genetic_concerns\": [\"array of string (遗传疾病风险)\"],\n    \"lifespan\": \"string (平均寿命：如12-15年)\",\n    \"preventive_care\": [\"array of string (预防保健建议)\"]\n  },\n  \"dietary_needs\": {\n    \"special_requirements\": \"string (特殊饮食需求)\",\n    \"feeding_tips\": [\"array of string (喂养建议)\"]\n  },\n  \"compatibility\": {\n    \"good_with_children\": \"string (与儿童相处：好/一般/不推荐)\",\n    \"good_with_dogs\": \"string (与狗相处：好/一般/不推荐)\",\n    \"good_with_other_cats\": \"string (与其他猫相处：好/一般/不推荐)\"\n  }\n}",
        "validation_rules": [
          "breed_name必须与BreedIdentificationResult一致",
          "difficulty_rating必须在1-5之间",
          "所有枚举值必须符合预定义选项",
          "数组字段不能为空，至少包含1个元素"
        ],
        "relationships": [
          "关联到BreedIdentificationResult",
          "作为最终输出的一部分"
        ]
      },
      {
        "name": "FollowUpQuestion",
        "schema": "{\n  \"question_text\": \"string (追问问题文本)\",\n  \"target_feature\": \"string (目标特征维度)\",\n  \"options\": [\"array of string (可选答案选项，如适用)\"],\n  \"importance\": \"string (重要性：高/中/低)\",\n  \"purpose\": \"string (追问目的：区分品种/提高置信度等)\"\n}",
        "validation_rules": [
          "question_text必须清晰易懂",
          "target_feature必须是有效的特征维度",
          "options可以为空（开放式问题）",
          "importance必须是'高'、'中'、'低'之一"
        ],
        "relationships": [
          "基于FeatureDescription.missing_features生成",
          "用于提高BreedIdentificationResult的准确性"
        ]
      }
    ],
    "interaction_flows": [
      {
        "name": "标准识别流程",
        "description": "用户提供完整特征描述，Agent一次性给出识别结果和习性信息",
        "steps": [
          {
            "step": "1. 接收用户输入",
            "agent": "cat_breed_identifier",
            "action": "解析payload，提取prompt字段",
            "data": "raw_input"
          },
          {
            "step": "2. 特征提取",
            "agent": "cat_breed_identifier",
            "action": "使用LLM理解文本，提取FeatureDescription",
            "data": "extracted_features"
          },
          {
            "step": "3. 品种匹配",
            "agent": "cat_breed_identifier",
            "action": "基于extracted_features进行品种推理",
            "data": "BreedIdentificationResult"
          },
          {
            "step": "4. 置信度评估",
            "agent": "cat_breed_identifier",
            "action": "评估识别结果的可靠性",
            "data": "confidence_score, confidence_level"
          },
          {
            "step": "5. 习性信息检索",
            "agent": "cat_breed_identifier",
            "action": "从LLM知识中提取LifestyleInformation",
            "data": "LifestyleInformation"
          },
          {
            "step": "6. 流式输出生成",
            "agent": "cat_breed_identifier",
            "action": "使用stream_async()逐步生成响应",
            "data": "结构化文本输出（品种名称、置信度、识别依据、习性信息）"
          }
        ]
      },
      {
        "name": "交互式追问流程",
        "description": "当特征不足或置信度较低时，Agent主动追问以获取更多信息",
        "steps": [
          {
            "step": "1-4. 同标准流程",
            "agent": "cat_breed_identifier",
            "action": "执行特征提取和初步品种匹配",
            "data": "FeatureDescription, BreedIdentificationResult"
          },
          {
            "step": "5. 追问决策",
            "agent": "cat_breed_identifier",
            "action": "判断是否需要追问（置信度<0.7或missing_features>2）",
            "data": "decision: need_follow_up"
          },
          {
            "step": "6. 生成追问问题",
            "agent": "cat_breed_identifier",
            "action": "基于missing_features或区分需求生成FollowUpQuestion",
            "data": "FollowUpQuestion"
          },
          {
            "step": "7. 输出初步结果+追问",
            "agent": "cat_breed_identifier",
            "action": "流式输出当前识别结果和追问问题",
            "data": "部分BreedIdentificationResult + FollowUpQuestion"
          },
          {
            "step": "8. 接收用户补充信息",
            "agent": "cat_breed_identifier",
            "action": "在新的请求中接收用户回答",
            "data": "updated_input"
          },
          {
            "step": "9. 更新特征和重新匹配",
            "agent": "cat_breed_identifier",
            "action": "合并新信息，重新执行品种匹配",
            "data": "updated_BreedIdentificationResult"
          },
          {
            "step": "10. 输出最终结果",
            "agent": "cat_breed_identifier",
            "action": "流式输出完整的识别结果和习性信息",
            "data": "完整BreedIdentificationResult + LifestyleInformation"
          }
        ]
      },
      {
        "name": "多候选品种处理流程",
        "description": "当有多个高置信度候选品种时，Agent提供对比和区分",
        "steps": [
          {
            "step": "1-4. 同标准流程",
            "agent": "cat_breed_identifier",
            "action": "执行特征提取和品种匹配",
            "data": "FeatureDescription, BreedIdentificationResult with alternative_breeds"
          },
          {
            "step": "5. 多候选判断",
            "agent": "cat_breed_identifier",
            "action": "检测到2个以上置信度>0.6的候选",
            "data": "alternative_breeds"
          },
          {
            "step": "6. 生成对比信息",
            "agent": "cat_breed_identifier",
            "action": "提取各候选的distinguishing_features",
            "data": "候选品种对比表"
          },
          {
            "step": "7. 输出候选列表",
            "agent": "cat_breed_identifier",
            "action": "流式输出主要候选和备选品种",
            "data": "BreedIdentificationResult + alternative_breeds"
          },
          {
            "step": "8. 提出区分问题",
            "agent": "cat_breed_identifier",
            "action": "询问关键区分特征（如鼻子长度、耳朵大小）",
            "data": "FollowUpQuestion (purpose: 区分品种)"
          },
          {
            "step": "9-10. 同交互式追问流程",
            "agent": "cat_breed_identifier",
            "action": "接收补充信息，确定最终品种",
            "data": "final_BreedIdentificationResult + LifestyleInformation"
          }
        ]
      },
      {
        "name": "无法明确识别流程",
        "description": "当特征不符合任何已知品种或明显是混种猫时的处理",
        "steps": [
          {
            "step": "1-4. 同标准流程",
            "agent": "cat_breed_identifier",
            "action": "执行特征提取和品种匹配",
            "data": "FeatureDescription, BreedIdentificationResult"
          },
          {
            "step": "5. 低置信度判断",
            "agent": "cat_breed_identifier",
            "action": "所有候选品种置信度<0.5",
            "data": "confidence_level: 低"
          },
          {
            "step": "6. 混种或未知判断",
            "agent": "cat_breed_identifier",
            "action": "设置is_mixed_breed=true或给出不确定性原因",
            "data": "is_mixed_breed, uncertainty_reason"
          },
          {
            "step": "7. 输出最接近品种",
            "agent": "cat_breed_identifier",
            "action": "提供最接近的1-2个品种作为参考",
            "data": "BreedIdentificationResult + alternative_breeds"
          },
          {
            "step": "8. 提供通用建议",
            "agent": "cat_breed_identifier",
            "action": "基于体型和毛长给出通用饲养建议",
            "data": "generic_LifestyleInformation"
          },
          {
            "step": "9. 建议其他确认方式",
            "agent": "cat_breed_identifier",
            "action": "建议用户咨询兽医或使用图像识别",
            "data": "additional_suggestions"
          }
        ]
      }
    ],
    "security_considerations": [
      "输入验证：限制prompt长度≤500字符，防止超长输入攻击",
      "内容过滤：检测并拒绝处理不相关或不当内容（如非猫咪描述）",
      "数据隐私：不记录用户输入的特征描述，不存储个人信息",
      "会话隔离：使用session_id区分不同用户会话，防止信息泄露",
      "错误信息脱敏：错误响应中不暴露系统内部信息",
      "API安全：部署在AgentCore环境，利用AWS IAM进行访问控制",
      "日志安全：日志中不记录敏感的用户输入内容"
    ],
    "error_handling": [
      "输入验证错误：当prompt为空或超长时，返回友好错误提示",
      "特征提取失败：当无法从文本中提取有效特征时，引导用户重新描述",
      "品种识别失败：当所有品种置信度过低时，提示可能是混种猫并给出最接近品种",
      "LLM调用失败：捕获Bedrock API异常，返回'服务暂时不可用，请稍后重试'",
      "超时处理：设置5秒响应超时，超时后返回部分结果或错误提示",
      "流式响应中断：处理网络中断，确保已发送的片段有意义",
      "无效会话：当session_id无效时，按新会话处理",
      "并发限制：AgentCore环境处理并发控制，Agent层面无需特殊处理"
    ],
    "performance_considerations": [
      "响应时间：目标5秒内完成完整响应，首个片段2秒内返回",
      "流式输出：使用agent.stream_async()实现流式响应，提升感知性能",
      "提示词优化：精简提示词长度，减少LLM处理时间",
      "特征提取效率：通过结构化提示词引导LLM快速提取特征",
      "知识检索优化：利用LLM内置知识，避免外部API调用延迟",
      "并发处理：AgentCore支持多请求并发，无需Agent层面优化",
      "缓存策略：初版不实现缓存，后续可考虑缓存常见品种信息",
      "资源限制：单次请求token消耗控制在5000以内"
    ],
    "monitoring_strategy": [
      "日志记录：记录每次请求的输入长度、识别品种、置信度、响应时间",
      "性能指标：监控平均响应时间、首字节时间、流式输出速度",
      "准确性跟踪：记录置信度分布，识别低置信度案例",
      "错误监控：统计各类错误发生频率（输入验证、LLM调用失败等）",
      "用户行为：追踪追问轮次分布，识别常见缺失特征",
      "品种分布：统计识别最多的品种，优化提示词覆盖",
      "会话分析：分析多轮对话的平均轮次和成功率",
      "告警机制：响应时间>5秒、错误率>5%时触发告警"
    ]
  },
  "design_rationale": "本系统设计基于以下核心考虑：\n\n1. **单Agent架构选择**：需求分析确定为single_agent场景，因为猫咪品种识别是相对单一的任务流程（特征输入→品种匹配→习性输出），不需要多个专业Agent协作。单Agent架构降低了系统复杂度，减少了Agent间通信开销，提升了响应速度。\n\n2. **知识驱动设计**：充分利用Claude Sonnet 4.5的内置猫咪品种知识，避免构建和维护复杂的外部知识库。这种设计简化了系统架构，减少了外部依赖，提高了可靠性。LLM的知识覆盖主流猫咪品种（30+种）已经足够满足初版需求。\n\n3. **提示词工程为核心**：将特征提取、品种匹配、置信度评估、追问决策等逻辑通过精心设计的提示词实现，而不是编写复杂的算法代码。这种设计利用了LLM的推理能力，提高了系统的灵活性和可维护性。提示词可以快速迭代优化，无需修改代码。\n\n4. **交互式追问机制**：设计了多轮对话支持，当特征不足或置信度较低时，Agent主动询问关键信息。这种设计提高了识别准确率，同时保持了用户体验的友好性。追问决策基于missing_features和confidence_score，确保追问的针对性。\n\n5. **置信度透明化**：明确展示识别结果的置信度（高/中/低），让用户了解结果的可靠程度。这种设计建立了用户信任，也为追问决策提供了依据。当置信度较低时，系统会提供多个候选品种或建议其他确认方式。\n\n6. **流式响应设计**：采用agent.stream_async()实现流式输出，首个响应片段在2秒内返回。这种设计显著提升了用户体验，让用户感知到系统正在处理请求，而不是长时间等待。流式响应也符合现代AI应用的最佳实践。\n\n7. **数据模型设计**：定义了FeatureDescription、BreedIdentificationResult、LifestyleInformation、FollowUpQuestion四个核心数据模型，结构化组织信息流。这种设计提高了系统的可维护性和可扩展性，也便于后续添加新特征或品种。\n\n8. **错误处理策略**：设计了完善的错误处理机制，覆盖输入验证、特征提取失败、品种识别失败、LLM调用失败等场景。对于无法明确识别的情况，系统会提示可能是混种猫并给出最接近的品种，而不是简单返回错误。\n\n9. **性能优化**：通过流式输出、提示词优化、避免外部API调用等方式，确保响应时间控制在5秒以内。初版不实现缓存，简化架构，后续可根据实际需求添加。\n\n10. **安全性考虑**：限制输入长度、过滤不当内容、不存储个人信息、日志脱敏等措施，确保系统安全可靠。部署在AgentCore环境，利用AWS的安全机制。\n\n11. **可扩展性设计**：虽然初版只支持文本输入，但架构预留了扩展空间。media参数预留了图像识别扩展的可能性；数据模型设计支持添加新特征维度；提示词可以快速添加新品种支持。\n\n12. **模板选择**：推荐使用multimodal_analyzer_agent作为基础模板，因为它提供了最好的多轮对话支持和交互能力，与本系统的交互式追问需求高度匹配。虽然名为'多模态'，但其核心能力是内容分析和交互管理，完全适用于文本场景。\n\n13. **部署模式**：采用BedrockAgentCoreApp模式，使用@app.entrypoint装饰器定义handler入口点，支持标准化部署到AgentCore环境。handler函数设计为async异步函数，使用yield产生流式响应片段，符合AgentCore的流式响应规范。\n\n14. **监控策略**：设计了全面的监控指标，包括性能、准确性、错误率、用户行为等维度，为系统优化和问题排查提供数据支持。"
}